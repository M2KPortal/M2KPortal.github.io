<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mount 2000 Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.4;
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #061d28, #0a2635);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 8px;
            font-size: 2.2em;
        }

        .header h2 {
            margin-bottom: 0;
            font-size: 1.2em;
            font-weight: 400;
            opacity: 0.9;
        }

        /* Loading and Error States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #061d28;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 50px auto;
            max-width: 600px;
        }

        .error-message h2 {
            color: #c00;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .error-message p {
            color: #666;
            font-size: 1.1em;
        }

        /* Tab System */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .tab-button.active {
            background: #061d28;
            color: white;
        }

        .tab-button:hover {
            background: #061d28;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Statistics */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #c9a96e, #a68b5b);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 1.6em;
            margin-bottom: 8px;
        }

        /* Resource Cards */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .resource-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #061d28;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(6, 29, 40, 0.2);
        }

        .resource-card h3 {
            color: #061d28;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .resource-card .icon {
            font-size: 1.8em;
        }

        .resource-link-box {
            background: white;
            border: 2px dashed #bdc3c7;
            border-radius: 6px;
            padding: 15px;
            min-height: 80px;
            color: #6c757d;
            font-style: italic;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Search */
        .search-bar {
            width: 100%;
            padding: 15px;
            border: 3px solid #061d28;
            border-radius: 8px;
            font-size: 18px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(6, 29, 40, 0.2);
        }

        .search-bar:focus {
            outline: none;
            border-color: #0a2635;
            box-shadow: 0 4px 15px rgba(6, 29, 40, 0.3);
        }

        /* Room Cards */
        .room-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #061d28;
            transition: all 0.3s ease;
            position: relative;
        }

        .room-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-left-color: #d4af37;
        }

        /* Status Indicators */
        .section-id {
            background: #061d28;
            color: #d4af37;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #d4af37;
        }

        .assignment-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-assigned { 
            background: #2e7d32;
            color: white; 
        }

        .status-unassigned { 
            background: #8b4513;
            color: white; 
        }

        /* Gender Color Coding - Updated colors */
        .male-section {
            background: #e6f3ff;
            border-left: 4px solid #061d28;
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
        }

        .female-section {
            background: #fff8e6;
            border-left: 4px solid #d4af37;
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 14px;
        }

        .btn-primary { background: #061d28; color: white; }
        .btn-primary:hover { background: #0a2635; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }

        .table th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* Capacity Displays */
        .capacity-display {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .capacity-positive { background: #d4edda; color: #155724; }
        .capacity-negative { background: #f8d7da; color: #721c24; }
        .capacity-zero { background: #fff3cd; color: #856404; }

        /* Table Containers */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 10px;
        }

        /* Management Sections */
        .management-section {
            margin-top: 30px;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 10px;
        }

        /* Notifications */
        .notification {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 600;
        }

        .notification.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Data Version Badge */
        .version-badge {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Favorite Star */
        .favorite-star {
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            user-select: none;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }

        .favorite-star:hover {
            transform: scale(1.2);
        }

        .favorite-star.favorited {
            color: #f1c40f;
        }

        /* Login Button */
        .header {
            position: relative;
        }

        .login-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .login-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }

            .header {
                padding: 12px;
                margin-bottom: 12px;
            }

            .header h1 {
                font-size: 1.1em;
                margin-bottom: 4px;
            }

            .header h2 {
                font-size: 0.75em;
            }

            .login-btn {
                top: 10px;
                right: 10px;
                padding: 4px 8px;
                font-size: 0.7em;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            .stat-card h3 {
                font-size: 1.2em;
                margin-bottom: 5px;
            }
            
            .stat-card p {
                font-size: 0.8em;
            }
            
            .tabs {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 4px;
            }
            
            .tab-button {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .search-bar {
                padding: 12px;
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            .room-card {
                padding: 12px;
                margin: 8px 0;
            }
            
            .table {
                font-size: 11px;
            }
            
            .table th, .table td {
                padding: 6px;
            }

            .resource-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Loading Mount 2K Data...</h2>
            <p id="loading-status">Searching for the latest data file...</p>
        </div>
    </div>

    <div class="container" id="main-container" style="display: none;">
        <div class="header">
            <a href="https://m2kportal.github.io/master.html" class="login-btn">üîê</a>
            <h1>Mount 2000 Dashboard</h1>
            <h2>Housing and Small Group Room Assignments - 2026 <span id="data-version-badge" class="version-badge"></span></h2>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard')">Assignment Dashboard</button>
            <button class="tab-button" onclick="switchTab('resources')">Resources</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Assignment Dashboard</h2>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="total-groups">0</h3>
                    <p>Total Youth Groups</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-participants">0</h3>
                    <p>Total Participants</p>
                </div>
            </div>

            <h3 style="margin-bottom: 10px; color: #061d28;">üîç Quick Parish Assignment Search</h3>
            <input type="text" class="search-bar" id="parish-search" placeholder="üîç Search by Parish, Group ID, Leader, Phone, Seminarian SGL, or Religious..." oninput="performSearch()" autocomplete="off">

            <div id="search-results"></div>

            <!-- Favorites Section -->
            <div id="favorites-section" style="background: #fffef0; padding: 15px; border-radius: 8px; margin-top: 20px; border: 2px solid #f1c40f; display: none;">
                <h3 style="color: #061d28; margin-bottom: 15px;">‚≠ê Your Favorited Groups</h3>
                <div id="favorites-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;"></div>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                <h3>Complete Assignment Overview</h3>
                <div id="assignment-overview"></div>
            </div>
        </div>

        <!-- Resources Tab -->
        <div id="resources" class="tab-content">
            <h2>Mount 2K Resources</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">Quick access to important resources and information for the retreat.</p>
            
            <div class="resource-grid" id="resource-grid">
                <!-- Resources loaded dynamically from JSON -->
            </div>
        </div>

    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let appData = {
            youthGroups: [],
            housingRooms: [],
            smallGroupRooms: [],
            housingAssignments: {
                male: {},
                female: {}
            },
            smallGroupAssignments: {},
            mealColorAssignments: {},
            mealTimes: {},
            resources: []
        };

        let currentDataVersion = 0;
        let dataTimestamp = null;

        // ===== FAVORITE FUNCTIONS =====
        function getFavorites() {
            const favorites = localStorage.getItem('m2k_favorites');
            return favorites ? JSON.parse(favorites) : [];
        }

        function saveFavorites(favorites) {
            localStorage.setItem('m2k_favorites', JSON.stringify(favorites));
        }

        function toggleFavorite(groupId) {
            let favorites = getFavorites();
            const index = favorites.indexOf(groupId);

            if (index > -1) {
                // Remove from favorites
                favorites.splice(index, 1);
            } else {
                // Add to favorites
                favorites.push(groupId);
            }

            saveFavorites(favorites);

            // Refresh the display
            displayFavoritesSection();
            updateAssignmentOverview();
            performSearch();
        }

        function displayFavoritesSection() {
            const favorites = getFavorites();
            const favoritesSection = document.getElementById('favorites-section');
            const favoritesList = document.getElementById('favorites-list');

            if (!favoritesSection || !favoritesList) return;

            if (favorites.length === 0) {
                favoritesSection.style.display = 'none';
                return;
            }

            // Show the section
            favoritesSection.style.display = 'block';

            // Get favorited groups
            const favoritedGroups = appData.youthGroups.filter(g => favorites.includes(g.id));

            // Generate cards
            let html = '';
            favoritedGroups.forEach(group => {
                html += createGroupCard(group, false);
            });

            favoritesList.innerHTML = html;
        }

        function isFavorited(groupId) {
            return getFavorites().includes(groupId);
        }

        function sortGroupsByFavorites(groups) {
            const favorites = getFavorites();
            return groups.sort((a, b) => {
                const aFavorited = favorites.includes(a.id);
                const bFavorited = favorites.includes(b.id);

                if (aFavorited && !bFavorited) return -1;
                if (!aFavorited && bFavorited) return 1;
                return 0;
            });
        }

        // ===== UTILITY FUNCTIONS =====
        function formatRelativeTime(timestamp) {
            if (!timestamp) return '';

            const now = new Date();
            const updateTime = new Date(timestamp);
            const diffMs = now - updateTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            // Same day - show relative time
            if (diffDays === 0) {
                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            }

            // Different day - show full date
            const options = {
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            return updateTime.toLocaleDateString('en-US', options);
        }

        // ===== SYSTEM INITIALIZATION =====
        async function initializeSystem() {
            try {
                await findAndLoadLatestData();
                
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
                
                const versionBadge = document.getElementById('data-version-badge');
                if (versionBadge && dataTimestamp) {
                    const timeText = formatRelativeTime(dataTimestamp);
                    versionBadge.textContent = `Last Updated: ${timeText}`;
                }
                
                updateAllDisplays();
                displayFavoritesSection();
                displayResources();
                setupKeyboardShortcuts();
                
                setTimeout(() => {
                    const searchInput = document.getElementById('parish-search');
                    if (searchInput) {
                        searchInput.addEventListener('input', performSearch);
                        searchInput.addEventListener('keyup', performSearch);
                    }
                }, 100);
            } catch (error) {
                showErrorMessage();
            }
        }

        async function findAndLoadLatestData() {
            const loadingStatus = document.getElementById('loading-status');
            let foundVersion = 0;
            
            for (let version = 1; version <= 100; version++) {
                const filename = `m2k_2026_housing_data (${version}).json`;
                
                if (loadingStatus) {
                    loadingStatus.textContent = `Checking for version ${version}...`;
                }
                
                try {
                    const response = await fetch(filename);
                    
                    if (response.ok) {
                        foundVersion = version;
                    } else {
                        break;
                    }
                } catch (error) {
                    break;
                }
            }
            
            if (foundVersion > 0) {
                const filename = `m2k_2026_housing_data (${foundVersion}).json`;
                
                if (loadingStatus) {
                    loadingStatus.textContent = `Loading version ${foundVersion}...`;
                }
                
                const response = await fetch(filename);
                const data = await response.json();

                currentDataVersion = foundVersion;
                dataTimestamp = data.timestamp || new Date().toISOString();

                appData.youthGroups = data.youthGroups || [];
                appData.housingRooms = data.housingRooms || [];
                appData.smallGroupRooms = data.smallGroupRooms || [];
                appData.housingAssignments = data.housingAssignments || { male: {}, female: {} };
                appData.smallGroupAssignments = data.smallGroupAssignments || {};
                appData.mealColorAssignments = data.mealColorAssignments || {};
                appData.mealTimes = data.mealTimes || {};
                appData.activeColors = data.activeColors || Object.keys(data.mealTimes || {});
                appData.resources = data.resources || [];

                if (loadingStatus) {
                    loadingStatus.textContent = `Successfully loaded version ${foundVersion}!`;
                }
            } else {
                throw new Error('No data files found');
            }
        }

        function showErrorMessage() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.innerHTML = `
                <div class="error-message">
                    <h2>ü§î Whoops!</h2>
                    <p>Looks like we can't find the data right now! Please check back later.</p>
                    <p style="font-size: 0.9em; color: #999; margin-top: 15px;">
                        (Make sure a JSON file named "m2k_2026_housing_data (1).json" or similar is in the same folder)
                    </p>
                </div>
            `;
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                if ((event.metaKey || event.ctrlKey) && event.key === 'f') {
                    event.preventDefault();
                    document.getElementById('parish-search').focus();
                }
            });
        }

        // ===== TAB MANAGEMENT =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ===== UTILITY FUNCTIONS =====
        function getMealColorStyle(color) {
            if (!color) return { background: '#f8f9fa', color: '#6c757d', text: 'No Color' };
            
            const colorMap = {
                'Red': { background: '#e74c3c', color: 'white', text: 'Red' },
                'Blue': { background: '#3498db', color: 'white', text: 'Blue' },
                'Green': { background: '#27ae60', color: 'white', text: 'Green' },
                'Yellow': { background: '#f1c40f', color: '#212529', text: 'Yellow' },
                'Orange': { background: '#e67e22', color: 'white', text: 'Orange' },
                'Purple': { background: '#9b59b6', color: 'white', text: 'Purple' },
                'Pink': { background: '#e83e8c', color: 'white', text: 'Pink' },
                'Brown': { background: '#8b4513', color: 'white', text: 'Brown' },
                'Grey': { background: '#95a5a6', color: 'white', text: 'Grey' },
                'Black': { background: '#343a40', color: 'white', text: 'Black' },
                'White': { background: '#f8f9fa', color: '#212529', text: 'White' }
            };
            
            return colorMap[color] || { background: '#f8f9fa', color: '#6c757d', text: color };
        }

        function isGroupHousingAssigned(groupId) {
            const maleAssignments = appData.housingAssignments.male[groupId];
            const femaleAssignments = appData.housingAssignments.female[groupId];
            return (Array.isArray(maleAssignments) && maleAssignments.length > 0) ||
                   (Array.isArray(femaleAssignments) && femaleAssignments.length > 0);
        }

        function isGroupSmallGroupAssigned(groupId) {
            const assignments = appData.smallGroupAssignments[groupId];
            return Array.isArray(assignments) && assignments.length > 0;
        }

        function getHousingRoomOccupancy(roomKey) {
            let total = 0;
            
            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const assignments = appData.housingAssignments.male[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.maleTeens + group.maleChaperones;
                    }
                }
            });
            
            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const assignments = appData.housingAssignments.female[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.femaleTeens + group.femaleChaperones;
                    }
                }
            });
            
            return total;
        }

        function getSmallGroupRoomOccupancy(roomKey) {
            let total = 0;
            
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const assignments = appData.smallGroupAssignments[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                    }
                }
            });
            
            return total;
        }

        function getHousingRoomAssignedGroupsDisplay(roomKey) {
            const assignedGroups = [];
            
            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const assignments = appData.housingAssignments.male[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(`${groupId}(M)`);
                }
            });
            
            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const assignments = appData.housingAssignments.female[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(`${groupId}(F)`);
                }
            });
            
            return assignedGroups.join(', ') || 'None';
        }

        function getSmallGroupRoomAssignedGroupsDisplay(roomKey) {
            const assignedGroups = [];
            
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const assignments = appData.smallGroupAssignments[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(groupId);
                }
            });
            
            return assignedGroups.join(', ') || 'None';
        }

        // ===== CREATE GROUP CARD FUNCTION =====
        function createGroupCard(group, isSearch = false) {
            const isHousingAssigned = isGroupHousingAssigned(group.id);
            const isSmallGroupAssigned = isGroupSmallGroupAssigned(group.id);
            const maleTotal = group.maleTeens + group.maleChaperones;
            const femaleTotal = group.femaleTeens + group.femaleChaperones;
            const totalGroup = maleTotal + femaleTotal;
            
            // Get housing assignments
            const maleHousingRooms = appData.housingAssignments.male[group.id] || [];
            const femaleHousingRooms = appData.housingAssignments.female[group.id] || [];
            
            const maleHousingRoomNames = maleHousingRooms.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building}-${room.roomId}` : roomKey;
            });
            
            const femaleHousingRoomNames = femaleHousingRooms.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building}-${room.roomId}` : roomKey;
            });
            
            // Get small group assignments with features
            const groupSmallGroupRooms = appData.smallGroupAssignments[group.id] || [];
            
            const groupSmallGroupRoomNames = groupSmallGroupRooms.map(roomKey => {
                const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                if (room) {
                    const roomName = `${room.building}-${room.roomId}`;
                    return room.features ? `${roomName} (${room.features})` : roomName;
                }
                return roomKey;
            });
            
            const overallAssigned = isHousingAssigned || isSmallGroupAssigned;
            
            // Get meal color, seminarian, and religious info
            const mealColor = appData.mealColorAssignments[group.id];
            const mealColorStyle = getMealColorStyle(mealColor);
            const seminarian = group.seminarianSgl || '';
            const religious = group.religious || '';
            const isOffCampus = group.stayingOffCampus || false;
            
            const backgroundStyle = isSearch ? (overallAssigned ? '#f0fff4' : '#fff5f5') : '';
            const borderColor = overallAssigned ? '#27ae60' : '#e74c3c';
            const favorited = isFavorited(group.id);

            return `
                <div class="room-card" style="border-left-color: ${borderColor}; background: ${backgroundStyle}; position: relative; padding-left: 35px;">
                    <!-- FAVORITE STAR -->
                    <span class="favorite-star ${favorited ? 'favorited' : ''}" onclick="toggleFavorite('${group.id}')" title="${favorited ? 'Remove from favorites' : 'Add to favorites'}">
                        ${favorited ? '‚≠ê' : '‚òÜ'}
                    </span>

                    <!-- HEADER ROW -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="font-size: 16px;">${group.parish}</strong>
                        
                        <!-- STATUS BADGES CONTAINER -->
                        <div style="display: flex; gap: 5px; align-items: center;">
                            ${isOffCampus ? '<span class="assignment-status" style="background: #e67e22; color: white; font-size: 10px;">üèïÔ∏è OFF-CAMPUS</span>' : ''}
                            
                            <span class="assignment-status ${isHousingAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                üè† ${isHousingAssigned ? '‚úÖ' : '‚ùå'}
                            </span>
                            
                            <span class="assignment-status ${isSmallGroupAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                üë• ${isSmallGroupAssigned ? '‚úÖ' : '‚ùå'}
                            </span>
                            
                            ${mealColor ? `<span style="padding: 2px 6px; border-radius: 4px; background: ${mealColorStyle.background}; color: ${mealColorStyle.color}; font-size: 10px; font-weight: bold;">üçΩÔ∏è ${mealColorStyle.text}</span>` : ''}
                        </div>
                    </div>
                    
                    <!-- GROUP INFO ROW -->
                    <p><span class="section-id">${group.id}</span> | ${totalGroup} people total</p>
                    
                    ${isSearch ? `
                        <!-- DETAILED INFO FOR SEARCH RESULTS -->
                        <p style="margin-top: 6px; font-size: 13px;"><strong>Leader:</strong> ${group.leader} | <strong>Phone:</strong> ${group.phone}</p>
                        <p style="margin-top: 6px; font-size: 12px; color: #555;">
                            <strong>Male:</strong> ${group.maleTeens} teens + ${group.maleChaperones} chaperones | 
                            <strong>Female:</strong> ${group.femaleTeens} teens + ${group.femaleChaperones} chaperones
                        </p>
                        ${group.specialAccommodations ? `<p style="margin-top: 8px; font-size: 12px; background: #fff3cd; padding: 6px; border-radius: 4px;"><strong>‚ö†Ô∏è Special Accommodations:</strong> ${group.specialAccommodations}</p>` : ''}
                    ` : ''}
                    
                    <!-- SEMINARIAN SGL -->
                    ${seminarian ? `<p style="font-size: 12px; color: #2c3e50; margin-top: 8px;"><strong>Seminarian SGL:</strong> ${seminarian}</p>` : ''}

                    <!-- RELIGIOUS -->
                    ${religious ? `<p style="font-size: 12px; color: #2c3e50; margin-top: 6px;"><strong>Religious:</strong> ${religious}</p>` : ''}

                    <!-- HOUSING ASSIGNMENTS SECTION -->
                    ${isOffCampus ? `
                        <div style="background: #fff3cd; padding: 8px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #e67e22;">
                            <strong style="font-size: 14px;">üèïÔ∏è OFF-CAMPUS HOUSING</strong>
                            <p style="font-size: 12px; margin-top: 4px;">This group is staying off-campus</p>
                        </div>
                    ` : `
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin: 8px 0;">
                            <strong style="font-size: 14px;">üè† Housing Assignments</strong>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px;">
                                ${maleTotal > 0 ? `
                                    <div class="male-section" style="padding: 6px;">
                                        <strong style="font-size: 12px;">üîµ Males: ${maleTotal}</strong>
                                        ${maleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0; font-weight: bold; color: #2e7d32;">${maleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0; font-weight: bold;">‚ùå Not assigned</p>'}
                                    </div>
                                ` : '<div></div>'}
                                
                                ${femaleTotal > 0 ? `
                                    <div class="female-section" style="padding: 6px;">
                                        <strong style="font-size: 12px;">üü£ Females: ${femaleTotal}</strong>
                                        ${femaleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0; font-weight: bold; color: #2e7d32;">${femaleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0; font-weight: bold;">‚ùå Not assigned</p>'}
                                    </div>
                                ` : '<div></div>'}
                            </div>
                        </div>
                    `}
                    
                    <!-- SMALL GROUP SECTION -->
                    <div style="background: #f0f8ff; padding: 8px; border-radius: 6px; margin: 8px 0;">
                        <strong style="font-size: 14px;">üë• Small Group Location</strong>
                        ${groupSmallGroupRoomNames.length > 0 ? `
                            <div style="background: linear-gradient(45deg, #e8f4f8, #fdf2f2); padding: 6px; border-radius: 4px; margin-top: 5px;">
                                <strong style="font-size: 12px;">üü° Group Location:</strong>
                                <p style="font-size: 10px; margin: 2px 0 0 0; font-weight: bold; color: #2e7d32;">${groupSmallGroupRoomNames.join(', ')}</p>
                            </div>
                        ` : `<div style="background: #fff3cd; padding: 4px; border-radius: 4px; margin-top: 5px; text-align: center;">
                            <p style="font-size: 10px; color: #856404; margin: 0; font-weight: bold;">‚ùå No small group location assigned</p>
                        </div>`}
                    </div>

                    <!-- MEAL TIMES SECTION - Only show in search results -->
                    ${isSearch && mealColor ? `
                        <div style="background: ${mealColorStyle.background}15; padding: 8px; border-radius: 6px; margin: 8px 0; border-left: 4px solid ${mealColorStyle.background};">
                            <strong style="font-size: 14px;">üçΩÔ∏è Meal Times - ${mealColorStyle.text} Group</strong>
                            ${appData.mealTimes[mealColor] ? `
                                <div style="margin-top: 5px; font-size: 11px; line-height: 1.6;">
                                    <div style="background: white; padding: 5px; border-radius: 4px; margin-bottom: 3px;">
                                        <strong>Saturday Breakfast:</strong> ${appData.mealTimes[mealColor].satBreakfast || 'TBA'}
                                    </div>
                                    <div style="background: white; padding: 5px; border-radius: 4px; margin-bottom: 3px;">
                                        <strong>Saturday Lunch:</strong> ${appData.mealTimes[mealColor].satLunch || 'TBA'}
                                    </div>
                                    <div style="background: white; padding: 5px; border-radius: 4px; margin-bottom: 3px;">
                                        <strong>Saturday Dinner:</strong> ${appData.mealTimes[mealColor].satDinner || 'TBA'}
                                    </div>
                                    <div style="background: white; padding: 5px; border-radius: 4px;">
                                        <strong>Sunday Breakfast:</strong> ${appData.mealTimes[mealColor].sunBreakfast || 'TBA'}
                                    </div>
                                </div>
                            ` : `<p style="font-size: 10px; color: #856404; margin-top: 5px;">Meal times not yet available</p>`}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ===== DISPLAY UPDATE FUNCTIONS =====
        function updateAllDisplays() {
            updateYouthGroupsTable();
            updateMealColorTable();
            updateHousingRoomsTable();
            updateSmallGroupRoomsTable();
            updateDashboard();
            updateAssignmentOverview();
        }

        function updateDashboard() {
            const totalGroupsElement = document.getElementById('total-groups');
            const totalParticipantsElement = document.getElementById('total-participants');
            
            if (totalGroupsElement) totalGroupsElement.textContent = appData.youthGroups.length;
            if (totalParticipantsElement) totalParticipantsElement.textContent = appData.youthGroups.reduce((total, group) => 
                total + group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones, 0);
        }

        function updateAssignmentOverview() {
            const overviewDiv = document.getElementById('assignment-overview');
            if (!overviewDiv) return;

            if (appData.youthGroups.length === 0) {
                overviewDiv.innerHTML = '<p>No youth groups added yet.</p>';
                return;
            }

            // Get favorites list
            const favorites = getFavorites();

            // Filter out favorited groups from the overview (they'll show in the favorites section instead)
            const nonFavoritedGroups = appData.youthGroups.filter(group => !favorites.includes(group.id));

            if (nonFavoritedGroups.length === 0) {
                overviewDiv.innerHTML = '<p style="color: #666; font-style: italic;">All groups are in your favorites section above.</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';

            nonFavoritedGroups.forEach(group => {
                html += createGroupCard(group, false);
            });

            html += '</div>';
            overviewDiv.innerHTML = html;
        }

        function updateYouthGroupsTable() {
            const tbody = document.getElementById('youth-groups-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            appData.youthGroups.forEach((group, index) => {
                const total = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                const isAssigned = isGroupHousingAssigned(group.id);
                const mealColor = appData.mealColorAssignments[group.id];
                const mealColorStyle = getMealColorStyle(mealColor);
                const seminarian = group.seminarianSgl || '';
                const isOffCampus = group.stayingOffCampus || false;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="section-id">${group.id}</span></td>
                    <td>${group.parish}</td>
                    <td>${group.leader}</td>
                    <td>${group.phone}</td>
                    <td><strong>${total}</strong></td>
                    <td>${isOffCampus ? '<span style="background: #e67e22; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold;">üèïÔ∏è YES</span>' : '<span style="color: #6c757d; font-size: 11px;">No</span>'}</td>
                    <td style="font-size: 11px; font-style: italic;">${seminarian || 'Not assigned'}</td>
                    <td>${mealColor ? `<span style="background: ${mealColorStyle.background}; color: ${mealColorStyle.color}; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">${mealColorStyle.text}</span>` : '<span style="color: #6c757d;">No Color</span>'}</td>
                    <td><span class="assignment-status ${isAssigned ? 'status-assigned' : 'status-unassigned'}">${isAssigned ? '‚úÖ Assigned' : '‚ùå Unassigned'}</span></td>
                `;
            });
        }

        function updateMealColorTable() {
            const tbody = document.getElementById('meal-color-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            appData.youthGroups.forEach(group => {
                const totalPeople = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                const mealColor = appData.mealColorAssignments[group.id];
                const mealColorStyle = getMealColorStyle(mealColor);
                const seminarian = group.seminarianSgl || '';
                
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td><span class="section-id">${group.id}</span></td>
                    <td>${group.parish}</td>
                    <td>${group.leader}</td>
                    <td><strong>${totalPeople}</strong></td>
                    <td>${mealColor ? `<span style="background: ${mealColorStyle.background}; color: ${mealColorStyle.color}; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">${mealColorStyle.text}</span>` : '<span style="color: #6c757d;">No Color</span>'}</td>
                    <td style="font-size: 11px; font-style: italic;">${seminarian || 'Not assigned'}</td>
                `;
            });
        }

        function updateHousingRoomsTable() {
            const tbody = document.getElementById('housing-rooms-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            appData.housingRooms.forEach((room, index) => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getHousingRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const assignedGroups = getHousingRoomAssignedGroupsDisplay(roomKey);
                
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td>${room.building}</td>
                    <td>${room.roomId}</td>
                    <td>${room.gender.charAt(0).toUpperCase() + room.gender.slice(1)}</td>
                    <td>${room.capacity}</td>
                    <td class="capacity-display ${availableSpace < 0 ? 'capacity-negative' : availableSpace === 0 ? 'capacity-zero' : 'capacity-positive'}">${availableSpace}</td>
                    <td style="font-size: 12px;">${assignedGroups}</td>
                `;
            });
        }

        function updateSmallGroupRoomsTable() {
            const tbody = document.getElementById('small-group-rooms-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            appData.smallGroupRooms.forEach((room, index) => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getSmallGroupRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const assignedGroups = getSmallGroupRoomAssignedGroupsDisplay(roomKey);
                
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td>${room.building}</td>
                    <td>${room.roomId}</td>
                    <td>${room.gender === 'mixed' ? 'Mixed/Co-ed' : room.gender.charAt(0).toUpperCase() + room.gender.slice(1)}</td>
                    <td>${room.capacity}</td>
                    <td class="capacity-display ${availableSpace < 0 ? 'capacity-negative' : availableSpace === 0 ? 'capacity-zero' : 'capacity-positive'}">${availableSpace}</td>
                    <td style="font-size: 12px;">${assignedGroups}</td>
                `;
            });
        }

        // ===== SEARCH FUNCTIONALITY =====
        function performSearch() {
            const searchInput = document.getElementById('parish-search');
            const resultsDiv = document.getElementById('search-results');
            
            if (!searchInput || !resultsDiv) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const matchingGroups = appData.youthGroups.filter(group =>
                group.parish.toLowerCase().includes(searchTerm) ||
                group.id.toLowerCase().includes(searchTerm) ||
                group.leader.toLowerCase().includes(searchTerm) ||
                group.phone.toLowerCase().includes(searchTerm) ||
                (group.seminarianSgl && group.seminarianSgl.toLowerCase().includes(searchTerm)) ||
                (group.religious && group.religious.toLowerCase().includes(searchTerm))
            );

            if (matchingGroups.length === 0) {
                resultsDiv.innerHTML = '<div class="notification warning">üîç No groups found matching your search.</div>';
                return;
            }

            // Sort matching groups with favorites at the top
            const sortedMatches = sortGroupsByFavorites(matchingGroups);

            let html = `<h3 style="color: #061d28; margin-bottom: 15px;">üîç Search Results (${sortedMatches.length} found)</h3><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">`;

            sortedMatches.forEach(group => {
                html += createGroupCard(group, true);
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // ===== RESOURCES DISPLAY =====
        function displayResources() {
            const container = document.getElementById('resource-grid');
            if (!container) return;

            let html = '';

            // Add Meal Times selector first
            const activeColors = appData.activeColors || Object.keys(appData.mealTimes || {});
            html += `
                <div class="resource-card" style="grid-column: 1 / -1;">
                    <h3><span class="icon">üçΩÔ∏è</span> Meal Times</h3>
                    <p style="color: #666; margin-bottom: 15px;">Select your meal color to view your schedule:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        ${activeColors.map(color => {
                            const colorStyles = {
                                'Blue': 'background: #3498db; color: white;',
                                'Red': 'background: #e74c3c; color: white;',
                                'Orange': 'background: #e67e22; color: white;',
                                'Yellow': 'background: #f1c40f; color: #333;',
                                'Green': 'background: #27ae60; color: white;',
                                'Purple': 'background: #9b59b6; color: white;',
                                'Brown': 'background: #8B4513; color: white;',
                                'Grey': 'background: #95a5a6; color: white;'
                            };
                            return `
                                <button onclick="showMealTimes('${color}')"
                                        style="${colorStyles[color]} border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: transform 0.2s;">
                                    ${color}
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <div id="meal-schedule-display" style="background: #f8f9fa; border-radius: 8px; padding: 15px; display: none;">
                        <!-- Meal schedule appears here -->
                    </div>
                </div>
            `;

            if (!appData.resources || appData.resources.length === 0) {
                html += '<p style="color: #666; text-align: center;">No additional resources available at this time.</p>';
            } else {
                appData.resources.forEach(resource => {
                    // Skip the Meal Times resource since we handle it above
                    if (resource.name === 'Meal Times') return;

                    const hasLink = resource.url && resource.url.trim() !== '';

                    html += `
                        <div class="resource-card">
                            <h3><span class="icon">${resource.emoji}</span> ${resource.name || 'Resource'}</h3>
                            <div class="resource-link-box">
                                ${hasLink ?
                                    `<a href="${resource.url}" target="_blank" style="color: #061d28; text-decoration: none; font-weight: 600;">
                                        ${resource.name || 'Click here'} ‚Üí
                                    </a>`
                                    :
                                    '<p style="color: #999; font-style: italic;">Link coming soon</p>'
                                }
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function showMealTimes(color) {
            const display = document.getElementById('meal-schedule-display');
            const times = appData.mealTimes[color];

            if (!times) {
                display.innerHTML = '<p style="color: #999;">Meal times not available for this color.</p>';
                display.style.display = 'block';
                return;
            }

            let html = `
                <h4 style="color: #061d28; margin: 0 0 15px 0; font-size: 1.3em;">${color} Team Schedule</h4>
                <div style="display: grid; gap: 10px;">
                    <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #27ae60;">
                        <strong style="color: #061d28;">Saturday Breakfast:</strong> ${times.satBreakfast}
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #3498db;">
                        <strong style="color: #061d28;">Saturday Lunch:</strong> ${times.satLunch}
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #e67e22;">
                        <strong style="color: #061d28;">Saturday Dinner:</strong> ${times.satDinner}
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #f39c12;">
                        <strong style="color: #061d28;">Sunday Breakfast:</strong> ${times.sunBreakfast}
                    </div>
                </div>
            `;

            display.innerHTML = html;
            display.style.display = 'block';
        }

        // ===== SYSTEM INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing system...');
            initializeSystem();
        });
    </script>
</body>
</html>
