<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mount 2K Housing Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #061d28, #0f3a4a);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            margin-bottom: 8px;
            font-size: 2.2em;
        }

        /* Logout Button */
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Front View Button */
        .front-view-btn {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .front-view-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Tab System */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #061d28;
        }

        .tab-button.active {
            background: #061d28;
            color: #d4af37;
        }

        .tab-button:hover {
            background: #0f3a4a;
            color: #d4af37;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Statistics */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #061d28, #0f3a4a);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #d4af37;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
            color: #d4af37;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            height: 80px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 14px;
        }

        .btn-primary { background: #061d28; color: #d4af37; border: 2px solid #d4af37; }
        .btn-primary:hover { background: #d4af37; color: #061d28; }
        .btn-success { background: #2e7d32; color: white; }
        .btn-success:hover { background: #1b5e20; }
        .btn-danger { background: #8b4513; color: white; }
        .btn-danger:hover { background: #654321; }
        .btn-warning { background: #d4af37; color: #061d28; }
        .btn-warning:hover { background: #b8941f; }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }

        .table th {
            background: #061d28;
            color: #d4af37;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* Search */
        .search-bar {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        /* Assignment System */
        .assignment-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .group-details, .available-rooms {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .room-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #061d28;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .room-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-left-color: #d4af37;
        }

        .room-card.selected {
            background: #f9f7f0;
            border-left-color: #d4af37;
            border: 2px solid #d4af37;
            border-left: 4px solid #d4af37;
        }

        /* Status Indicators */
        .section-id {
            background: #061d28;
            color: #d4af37;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #d4af37;
        }

        .assignment-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-assigned { background: #2e7d32; color: white; }
        .status-unassigned { background: #8b4513; color: white; }

        /* Gender Color Coding */
        .male-section {
            background: #e6f3ff;
            border-left: 4px solid #061d28;
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
        }

        .female-section {
            background: #fff8e6;
            border-left: 4px solid #d4af37;
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
        }

        /* Notifications */
        .notification {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 600;
        }

        .notification.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* Capacity Displays */
        .capacity-display {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .capacity-positive { background: #e8f5e8; color: #2e7d32; }
        .capacity-negative { background: #fdeaea; color: #8b4513; }
        .capacity-zero { background: #fff8e6; color: #b8941f; }

        /* Scrollable Tables */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 10px;
        }

        /* Table Filtering and Sorting */
        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-select {
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        /* Sortable Table Headers */
        .table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }

        .table th.sortable:hover {
            background: #0f3a4a !important;
        }

        .table th.sortable::after {
            content: '↕️';
            position: absolute;
            right: 8px;
            opacity: 0.5;
            font-size: 12px;
        }

        .table th.sortable.sort-asc::after {
            content: '⬆️';
            opacity: 1;
        }

        .table th.sortable.sort-desc::after {
            content: '⬇️';
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .assignment-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
            }
            
            .tab-button {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* Print Styles for PDF Generation */
        @media print {
            @page {
                size: letter;
                margin: 0.5in;
            }
            
            .no-print {
                display: none !important;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            body {
                background: white;
            }
        }

        /* Password Protection Styles */
        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #061d28, #0f3a4a);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .password-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .password-container h1 {
            color: #061d28;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .password-container p {
            color: #666;
            margin-bottom: 25px;
        }

        .password-input-group {
            margin-bottom: 20px;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .password-input:focus {
            outline: none;
            border-color: #0f3a4a;
        }

        .password-btn {
            width: 100%;
            padding: 15px;
            background: #061d28;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .password-btn:hover {
            background: #0f3a4a;
        }

        .password-error {
            color: #d32f2f;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }

        .password-setup {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .password-setup h3 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .password-setup p {
            color: #856404;
            font-size: 14px;
            margin-bottom: 15px;
        }

        #main-content {
            display: none;
        }

        #main-content.unlocked {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div id="password-overlay">
        <div class="password-container">
            <h1>🔒 Secure Access</h1>
            <p>Mount 2K Housing Management System</p>

            <div id="password-setup-mode" class="password-setup" style="display: none;">
                <h3>⚙️ First Time Setup</h3>
                <p>Create a password to protect this system</p>
            </div>

            <div class="password-input-group">
                <input type="password"
                       id="password-input"
                       class="password-input"
                       placeholder="Enter password"
                       onkeypress="if(event.key==='Enter') checkPassword()">
            </div>

            <button class="password-btn" onclick="checkPassword()">
                <span id="password-btn-text">🔓 Unlock</span>
            </button>

            <div id="password-error" class="password-error">
                ❌ Incorrect password. Please try again.
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: left;">
                <small style="color: #1565c0;">
                    <strong>🛡️ Security Note:</strong><br>
                    This system uses a centralized password.
                    Contact your administrator if you need the password.
                </small>
            </div>
        </div>
    </div>

    <div id="main-content" class="container">
        <div class="header">
            <button class="logout-btn" onclick="logout()">🚪 Logout</button>
            <a href="https://m2kportal.github.io/index.html" class="front-view-btn">👁️ Front View</a>
            <h1>Mount 2K Housing Management System</h1>
            <p>Mount St. Mary's University - Comprehensive Housing Solution</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-button" onclick="switchTab('youth-groups')">Youth Groups</button>
            <button class="tab-button" onclick="switchTab('housing-rooms')">Housing Rooms</button>
            <button class="tab-button" onclick="switchTab('housing-assignments')">Housing Assignments</button>
            <button class="tab-button" onclick="switchTab('small-group-rooms')">Small Group Rooms</button>
            <button class="tab-button" onclick="switchTab('small-group-assignments')">Small Group Assignments</button>
            <button class="tab-button" onclick="switchTab('meal-colors')">Meal Color Assignments</button>
            <button class="tab-button" onclick="switchTab('resources')">Resources</button>
            <button class="tab-button" onclick="switchTab('printable-forms')">Print Group Housing Information</button>
            <button class="tab-button" onclick="switchTab('room-posters')">Print Room Information</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Overview Dashboard</h2>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="total-groups">0</h3>
                    <p>Total Youth Groups</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-participants">0</h3>
                    <p>Total Participants</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e67e22, #d35400); border-color: #e67e22;">
                    <h3 id="off-campus-groups">0</h3>
                    <p>🏕️ Off-Campus People</p>
                </div>
                <div class="stat-card">
                    <h3 id="groups-needing-housing">0</h3>
                    <p>Groups Needing Housing</p>
                </div>
                <div class="stat-card">
                    <h3 id="groups-needing-small-group">0</h3>
                    <p>Groups Needing Small Group</p>
                </div>
                <div class="stat-card">
                    <h3 id="groups-needing-meal-color">0</h3>
                    <p>Groups Needing Meal Color</p>
                </div>
            </div>

            <h3 style="margin: 20px 0 10px 0;">Housing Capacity Details</h3>
            <div class="dashboard-stats">
                <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9); border-color: #3498db;">
                    <h3 id="male-housing-capacity">0</h3>
                    <p>🔵 Male Housing Capacity</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9); border-color: #3498db;">
                    <h3 id="male-housing-used">0</h3>
                    <p>🔵 Male Housing Used</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9); border-color: #3498db;">
                    <h3 id="male-housing-utilization">0%</h3>
                    <p>🔵 Male Housing Used %</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); border-color: #9b59b6;">
                    <h3 id="female-housing-capacity">0</h3>
                    <p>🟣 Female Housing Capacity</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); border-color: #9b59b6;">
                    <h3 id="female-housing-used">0</h3>
                    <p>🟣 Female Housing Used</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); border-color: #9b59b6;">
                    <h3 id="female-housing-utilization">0%</h3>
                    <p>🟣 Female Housing Used %</p>
                </div>
            </div>

            <h3 style="margin: 20px 0 10px 0;">Small Group Room Capacity</h3>
            <div class="dashboard-stats">
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954); border-color: #27ae60;">
                    <h3 id="mixed-sg-capacity">0</h3>
                    <p>Mixed/Co-ed Room Capacity</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954); border-color: #27ae60;">
                    <h3 id="mixed-sg-used">0</h3>
                    <p>Mixed/Co-ed Rooms Used</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954); border-color: #27ae60;">
                    <h3 id="mixed-sg-utilization">0%</h3>
                    <p>Mixed/Co-ed Rooms Used %</p>
                </div>
                <div class="stat-card">
                    <h3 id="available-small-group-rooms">0</h3>
                    <p>Available Small Group Rooms</p>
                </div>
            </div>

            <h3 style="margin: 20px 0 10px 0;">General Statistics</h3>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="available-housing-rooms">0</h3>
                    <p>Available Housing Rooms</p>
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="exportToCSV()">📥 Export Data to CSV</button>
                <button class="btn btn-success" onclick="saveData()">💾 Save Data (JSON)</button>
                <button class="btn btn-warning" onclick="loadData()">📂 Load Data</button>
                <button class="btn btn-primary" onclick="exportCompleteHTML()">🌐 Export Complete HTML Site</button>
                <input type="file" id="load-file" accept=".json" style="display: none;" onchange="handleLoadFile(event)">
            </div>

            <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border: 2px solid #4CAF50;">
                <h3 style="margin-bottom: 10px; color: #2e7d32;">🔄 GitHub Auto-Save</h3>
                <button id="save-github-btn" class="btn" onclick="saveToGitHub()"
                        style="background: #2e7d32; color: white; font-size: 16px; padding: 12px 24px; margin-right: 10px;">
                    🔄 Save to GitHub
                </button>
                <button class="btn" onclick="manageGitHubToken()"
                        style="background: #666; color: white; padding: 12px 24px;">
                    🔑 Manage Token
                </button>
                <p style="font-size: 12px; color: #2e7d32; margin-top: 10px;">
                    💡 Click "Save to GitHub" - you'll be asked for your token the first time!
                </p>
            </div>

            <h3>Quick Parish Assignment Search</h3>
            <input type="text" class="search-bar" id="parish-search" placeholder="Search by Parish name, Group ID, Leader name, Seminarian SGL, or Phone..." oninput="performSearch()">
            
            <div id="search-results"></div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                <h3>Assignment Overview</h3>
                <div id="assignment-overview"></div>
            </div>
        </div>

        <!-- Youth Groups Tab -->
        <div id="youth-groups" class="tab-content">
            <h2>Youth Group Management</h2>
            
            <div class="notification" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 20px; border-radius: 6px;">
                <h4 style="margin: 0 0 8px 0; color: #1976d2;">💡 Quick Import from CSV</h4>
                <p style="margin: 0; font-size: 14px; color: #1565c0;">
                    <strong>Step 1:</strong> Click "Download CSV Template" to get the format<br>
                    <strong>Step 2:</strong> Fill in your group data (only Group ID and Parish Name required)<br>
                    <strong>Step 3:</strong> Click "Import from CSV" and select your filled CSV file<br>
                    <strong>Note:</strong> Import adds to existing groups - duplicates are skipped
                </p>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Group ID *</label>
                    <input type="text" id="group-id" placeholder="Enter Group ID">
                </div>
                <div class="form-group">
                    <label>Parish Name *</label>
                    <input type="text" id="parish-name" placeholder="Enter Parish Name">
                </div>
                <div class="form-group">
                    <label>Group Leader</label>
                    <input type="text" id="group-leader" placeholder="Enter Leader Name">
                </div>
                <div class="form-group">
                    <label>Seminarian SGL</label>
                    <input type="text" id="seminarian-sgl" placeholder="Enter Seminarian Small Group Leader">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phone-number" placeholder="Enter Phone Number">
                </div>
                <div class="form-group">
                    <label>Male Teens</label>
                    <input type="number" id="male-teens" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Female Teens</label>
                    <input type="number" id="female-teens" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Male Chaperones</label>
                    <input type="number" id="male-chaperones" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Female Chaperones</label>
                    <input type="number" id="female-chaperones" min="0" value="0">
                </div>
                <div class="form-group" style="display: flex; align-items: center; padding-top: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="staying-off-campus" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                        <span style="font-weight: 600;">Staying Off-Campus</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Special Accommodations</label>
                <textarea id="special-accommodations" placeholder="Enter any special accommodations (CPAP machine, wheelchair access, medical needs, etc.)"></textarea>
            </div>

            <div>
                <button class="btn btn-success" onclick="addYouthGroup()">Add Youth Group</button>
                <button class="btn btn-primary" onclick="updateYouthGroup()" id="update-group-btn" style="display:none;">Update Youth Group</button>
                <button class="btn btn-danger" onclick="deleteYouthGroup()" id="delete-group-btn" style="display:none;">Delete Group</button>
                <button class="btn btn-warning" onclick="cancelEdit()" id="cancel-edit-btn" style="display:none;">Cancel</button>
                <button class="btn btn-primary" onclick="downloadCSVTemplate()" style="margin-left: 20px;">📥 Download CSV Template</button>
                <label class="btn btn-success" style="margin-left: 10px; cursor: pointer;">
                    📤 Import from CSV
                    <input type="file" id="csv-import" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
                </label>
            </div>

            <div class="table-controls">
                <input type="text" class="filter-input" id="youth-groups-filter" placeholder="Filter by Parish, Group ID, Leader, Seminarian SGL, or Phone..." oninput="filterYouthGroupsTable()">
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select class="sort-select" id="youth-groups-sort" onchange="sortYouthGroupsTable()">
                        <option value="id">Group ID</option>
                        <option value="parish">Parish Name</option>
                        <option value="leader">Leader Name</option>
                        <option value="seminarianSgl">Seminarian SGL</option>
                        <option value="total">Total People</option>
                        <option value="maleTeens">Male Teens</option>
                        <option value="femaleTeens">Female Teens</option>
                        <option value="status">Assignment Status</option>
                    </select>
                    <button class="btn btn-warning" onclick="toggleYouthGroupsSortOrder()" id="youth-groups-sort-order">A→Z</button>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortYouthGroupsBy('id')">Group ID</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('parish')">Parish</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('leader')">Leader</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('seminarianSgl')">Seminarian SGL</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('phone')">Phone</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('maleTeens')">M Teens</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('femaleTeens')">F Teens</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('maleChaperones')">M Chap</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('femaleChaperones')">F Chap</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('total')">Total</th>
                            <th>Special Needs</th>
                            <th class="sortable" onclick="sortYouthGroupsBy('status')">Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="youth-groups-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Housing Rooms Tab -->
        <div id="housing-rooms" class="tab-content">
            <h2>Housing Room Management</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Building Name *</label>
                    <input type="text" id="building-name" placeholder="e.g., Gymnasium, Auditorium">
                </div>
                <div class="form-group">
                    <label>Room/Section ID *</label>
                    <input type="text" id="room-id" placeholder="e.g., East Section, Orchestra Level">
                </div>
                <div class="form-group">
                    <label>Gender Designation *</label>
                    <select id="gender-designation">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Total Capacity *</label>
                    <input type="number" id="room-capacity" min="1" placeholder="Number of people">
                </div>
            </div>
            
            <div class="form-group">
                <label>Accessibility Features</label>
                <textarea id="accessibility-features" placeholder="Wheelchair accessible, ground floor, etc."></textarea>
            </div>

            <div>
                <button class="btn btn-success" onclick="addHousingRoom()">Add Housing Room</button>
                <button class="btn btn-primary" onclick="updateHousingRoom()" id="update-room-btn" style="display:none;">Update Room</button>
                <button class="btn btn-danger" onclick="deleteHousingRoom()" id="delete-room-btn" style="display:none;">Delete Room</button>
                <button class="btn btn-warning" onclick="cancelRoomEdit()" id="cancel-room-edit-btn" style="display:none;">Cancel</button>
            </div>

            <div class="table-controls">
                <input type="text" class="filter-input" id="housing-rooms-filter" placeholder="Filter by Building, Room, or Features..." oninput="filterHousingRoomsTable()">
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select class="sort-select" id="housing-rooms-sort" onchange="sortHousingRoomsTable()">
                        <option value="building">Building</option>
                        <option value="roomId">Room/Section</option>
                        <option value="gender">Gender</option>
                        <option value="capacity">Capacity</option>
                        <option value="occupied">Occupied</option>
                        <option value="available">Available Space</option>
                    </select>
                    <button class="btn btn-warning" onclick="toggleHousingRoomsSortOrder()" id="housing-rooms-sort-order">A→Z</button>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortHousingRoomsBy('sectionId')">Section ID</th>
                            <th class="sortable" onclick="sortHousingRoomsBy('building')">Building</th>
                            <th class="sortable" onclick="sortHousingRoomsBy('roomId')">Room/Section</th>
                            <th class="sortable" onclick="sortHousingRoomsBy('gender')">Gender</th>
                            <th class="sortable" onclick="sortHousingRoomsBy('capacity')">Capacity</th>
                            <th class="sortable" onclick="sortHousingRoomsBy('occupied')">Occupied</th>
                            <th class="sortable" onclick="sortHousingRoomsBy('available')">Available</th>
                            <th>Accessibility</th>
                            <th>Assigned Groups</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="housing-rooms-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Housing Assignments Tab -->
        <div id="housing-assignments" class="tab-content">
            <h2>Housing Room Assignments</h2>
            
            <div class="form-group">
                <label>Search Groups</label>
                <input type="text" class="search-bar" id="housing-assignment-search" placeholder="Search by Parish name, Group ID, or Leader name..." oninput="filterHousingAssignmentDropdown()">
            </div>
            
            <div class="form-group">
                <label>Select Group Gender Assignment</label>
                <select id="housing-assignment-group-select" onchange="selectGroupForHousingAssignment()">
                    <option value="">Select a Group-Gender Assignment</option>
                </select>
            </div>

            <div class="assignment-container">
                <div class="group-details">
                    <h3>Selected Assignment Details</h3>
                    <div id="housing-selected-group-info">
                        <p>Please select a group-gender assignment above to see room options.</p>
                    </div>
                </div>

                <div class="available-rooms">
                    <h3>Available Housing Rooms</h3>
                    <input type="text" id="housing-rooms-search" placeholder="🔍 Search housing rooms by building, room ID..."
                           oninput="filterHousingRooms()"
                           style="width: 100%; padding: 10px; border: 2px solid #061d28; border-radius: 6px; font-size: 14px; margin-bottom: 15px; display: none;">
                    <div id="housing-available-rooms-list">
                        <p>Select a group-gender assignment to see matching rooms.</p>
                    </div>
                </div>
            </div>

            <div id="housing-assignment-actions" style="display:none; margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="confirmHousingAssignment()">Save Housing Assignment</button>
                <button class="btn btn-danger" onclick="clearHousingAssignment()">Clear Assignment</button>
                <button class="btn btn-warning" onclick="cancelHousingSelection()">Cancel</button>
            </div>
        </div>

        <!-- Small Group Rooms Tab -->
        <div id="small-group-rooms" class="tab-content">
            <h2>Small Group Meeting Room Management</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Building Name *</label>
                    <input type="text" id="sg-building-name" placeholder="e.g., Student Center, Library">
                </div>
                <div class="form-group">
                    <label>Room/Location ID *</label>
                    <input type="text" id="sg-room-id" placeholder="e.g., Conference Room A, Study Hall">
                </div>
                <div class="form-group">
                    <label>Gender Designation *</label>
                    <select id="sg-gender-designation">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="mixed">Mixed/Co-ed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Room Capacity *</label>
                    <input type="number" id="sg-room-capacity" min="1" placeholder="Number of people">
                </div>
            </div>
            
            <div class="form-group">
                <label>Room Features</label>
                <textarea id="sg-room-features" placeholder="Projector, whiteboard, tables/chairs setup, etc."></textarea>
            </div>

            <div>
                <button class="btn btn-success" onclick="addSmallGroupRoom()">Add Small Group Room</button>
                <button class="btn btn-primary" onclick="updateSmallGroupRoom()" id="update-sg-room-btn" style="display:none;">Update Room</button>
                <button class="btn btn-danger" onclick="deleteSmallGroupRoom()" id="delete-sg-room-btn" style="display:none;">Delete Room</button>
                <button class="btn btn-warning" onclick="cancelSmallGroupRoomEdit()" id="cancel-sg-room-edit-btn" style="display:none;">Cancel</button>
            </div>

            <div class="table-controls">
                <input type="text" class="filter-input" id="small-group-rooms-filter" placeholder="Filter by Building, Room, or Features..." oninput="filterSmallGroupRoomsTable()">
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select class="sort-select" id="small-group-rooms-sort" onchange="sortSmallGroupRoomsTable()">
                        <option value="building">Building</option>
                        <option value="roomId">Room/Location</option>
                        <option value="gender">Gender</option>
                        <option value="capacity">Capacity</option>
                        <option value="occupied">Occupied</option>
                        <option value="available">Available Space</option>
                    </select>
                    <button class="btn btn-warning" onclick="toggleSmallGroupRoomsSortOrder()" id="small-group-rooms-sort-order">A→Z</button>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortSmallGroupRoomsBy('locationId')">Location ID</th>
                            <th class="sortable" onclick="sortSmallGroupRoomsBy('building')">Building</th>
                            <th class="sortable" onclick="sortSmallGroupRoomsBy('roomId')">Room/Location</th>
                            <th class="sortable" onclick="sortSmallGroupRoomsBy('gender')">Gender</th>
                            <th class="sortable" onclick="sortSmallGroupRoomsBy('capacity')">Capacity</th>
                            <th class="sortable" onclick="sortSmallGroupRoomsBy('occupied')">Occupied</th>
                            <th class="sortable" onclick="sortSmallGroupRoomsBy('available')">Available</th>
                            <th>Features</th>
                            <th>Assigned Groups</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="small-group-rooms-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Small Group Assignments Tab -->
        <div id="small-group-assignments" class="tab-content">
            <h2>Small Group Location Assignments</h2>
            
            <div class="form-group">
                <label>Search Groups</label>
                <input type="text" class="search-bar" id="sg-assignment-search" placeholder="Search by Parish name, Group ID, or Leader name..." oninput="filterSmallGroupAssignmentDropdown()">
            </div>
            
            <div class="form-group">
                <label>Select Group for Small Group Assignment</label>
                <select id="sg-assignment-group-select" onchange="selectGroupForSmallGroupAssignment()">
                    <option value="">Select a Group for Small Group Assignment</option>
                </select>
            </div>

            <div class="assignment-container">
                <div class="group-details">
                    <h3>Selected Group Details</h3>
                    <div id="sg-selected-group-info">
                        <p>Please select a group above to see small group location options.</p>
                    </div>
                </div>

                <div class="available-rooms">
                    <h3>Available Small Group Locations</h3>
                    <input type="text" id="sg-rooms-search" placeholder="🔍 Search small group rooms by building, room ID, features..."
                           oninput="filterSmallGroupRooms()"
                           style="width: 100%; padding: 10px; border: 2px solid #061d28; border-radius: 6px; font-size: 14px; margin-bottom: 15px; display: none;">
                    <div id="sg-available-rooms-list">
                        <p>Select a group to see available small group locations.</p>
                    </div>
                </div>
            </div>

            <div id="sg-assignment-actions" style="display:none; margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="confirmSmallGroupAssignment()">Save Small Group Assignment</button>
                <button class="btn btn-danger" onclick="clearSmallGroupAssignment()">Clear Assignment</button>
                <button class="btn btn-warning" onclick="cancelSmallGroupSelection()">Cancel</button>
            </div>
        </div>

        <!-- Meal Color Assignments Tab -->
        <div id="meal-colors" class="tab-content">
            <h2>Meal Color Assignments & Meal Times</h2>
            
            <!-- Meal Color Summary Dashboard -->
            <div class="dashboard-stats" style="margin-bottom: 20px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9); border-color: #3498db;">
                    <h3 id="blue-meal-count">0</h3>
                    <p>🔵 Blue Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b); border-color: #e74c3c;">
                    <h3 id="red-meal-count">0</h3>
                    <p>🔴 Red Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e67e22, #d35400); border-color: #e67e22;">
                    <h3 id="orange-meal-count">0</h3>
                    <p>🟠 Orange Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f1c40f, #f39c12); border-color: #f1c40f;">
                    <h3 id="yellow-meal-count">0</h3>
                    <p>🟡 Yellow Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954); border-color: #27ae60;">
                    <h3 id="green-meal-count">0</h3>
                    <p>🟢 Green Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); border-color: #9b59b6;">
                    <h3 id="purple-meal-count">0</h3>
                    <p>🟣 Purple Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #8b4513, #654321); border-color: #8b4513;">
                    <h3 id="brown-meal-count">0</h3>
                    <p>🤎 Brown Teams</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d); border-color: #95a5a6;">
                    <h3 id="grey-meal-count">0</h3>
                    <p>⚪ Grey Teams</p>
                </div>
            </div>

            <!-- Meal Times Configuration -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleMealTimesConfig()">
                    <h3 style="margin: 0;">⏰ Meal Time Schedule Configuration</h3>
                    <span id="meal-times-toggle" style="font-size: 24px;">▼</span>
                </div>
                <p style="font-size: 14px; color: #666; margin: 10px 0;">Set the meal times for each color group. These will appear on the printable check-in forms.</p>
                
                <div id="meal-times-config" style="display: none; margin-top: 15px;"></div>
            </div>

            <div class="table-controls">
                <input type="text" class="filter-input" id="meal-colors-filter" placeholder="Filter by Parish, Group ID, or Leader..." oninput="filterMealColorsTable()">
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select class="sort-select" id="meal-colors-sort" onchange="sortMealColorsTable()">
                        <option value="id">Group ID</option>
                        <option value="parish">Parish Name</option>
                        <option value="total">Total People</option>
                        <option value="color">Meal Color</option>
                    </select>
                    <button class="btn btn-warning" onclick="toggleMealColorsSortOrder()" id="meal-colors-sort-order">A→Z</button>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortMealColorsBy('id')">Group ID</th>
                            <th class="sortable" onclick="sortMealColorsBy('parish')">Parish</th>
                            <th class="sortable" onclick="sortMealColorsBy('leader')">Leader</th>
                            <th class="sortable" onclick="sortMealColorsBy('total')">Total People</th>
                            <th class="sortable" onclick="sortMealColorsBy('color')">Meal Color</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="meal-colors-table"></tbody>
                </table>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmMealColorAssignments()" style="font-size: 16px; padding: 12px 24px;">Save Meal Colors & Times</button>
            </div>
        </div>

        <!-- Resources Tab -->
        <div id="resources" class="tab-content">
            <h2>Resource Links Management</h2>
            <p style="margin-bottom: 20px; color: #666;">Manage the resource links that appear on the public dashboard. Edit the name and URL for each resource.</p>

            <div id="resources-list"></div>
        </div>

        <!-- Print Group Housing Information Tab -->
        <div id="printable-forms" class="tab-content">
            <h2>Print Group Housing Information</h2>
            <p style="margin-bottom: 20px; color: #666;">Generate professional PDF check-in forms for each youth group with all housing and meal assignments.</p>

            <!-- Generate PDF Buttons at Top -->
            <div style="text-align: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #061d28, #0f3a4a); border-radius: 10px;">
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateSelectedPDFs()" style="font-size: 18px; padding: 15px 30px; background: #d4af37; color: #061d28; border: 2px solid #d4af37;">
                        📄 Generate Selected Forms
                    </button>
                    <button class="btn btn-primary" onclick="generatePDFView()" style="font-size: 18px; padding: 15px 30px; background: #27ae60; color: white; border: 2px solid #27ae60;">
                        📄 Generate All Forms
                    </button>
                </div>
                <p style="color: #d4af37; margin-top: 10px; font-size: 14px;">Check boxes below to select specific forms, then use Ctrl+P (or Cmd+P) to save as PDF</p>
            </div>

            <!-- Default Notes Configuration -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">📝 Default Information (Appears on ALL Forms)</h3>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>General Information</label>
                    <textarea id="default-general-info" rows="3" placeholder="Enter general information that will appear on ALL forms (both on-campus and off-campus)..." style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
                </div>

                <h3 style="margin: 20px 0 15px 0;">🏠 On-Campus Only Information</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">The following fields only appear on forms for groups staying on-campus:</p>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Housing Notes/Information</label>
                    <textarea id="default-housing-notes" rows="3" placeholder="Enter housing information for on-campus groups..." style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Teen Shower Plan</label>
                    <textarea id="default-teen-shower" rows="3" placeholder="Enter teen shower schedule/plan for on-campus groups..." style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Adult Chaperone Shower Plan</label>
                    <textarea id="default-adult-shower" rows="3" placeholder="Enter adult chaperone shower schedule/plan for on-campus groups..." style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
                </div>

                <button class="btn btn-success" onclick="saveDefaultNotes()">💾 Save Default Notes</button>
            </div>

            <!-- Search/Filter for Forms -->
            <div style="margin-bottom: 20px;">
                <input 
                    type="text" 
                    id="forms-search" 
                    class="search-bar" 
                    placeholder="🔍 Search forms by Parish, Group ID, or Leader name..." 
                    oninput="filterFormsPreview()"
                    style="width: 100%; padding: 12px; border: 2px solid #061d28; border-radius: 8px; font-size: 16px;"
                >
            </div>

            <!-- Individual Group Forms Preview & Notes -->
            <div id="forms-preview-section"></div>

            <!-- Generate PDF Buttons at Bottom -->
            <div style="text-align: center; margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #061d28, #0f3a4a); border-radius: 10px;">
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateSelectedPDFs()" style="font-size: 18px; padding: 15px 30px; background: #d4af37; color: #061d28; border: 2px solid #d4af37;">
                        📄 Generate Selected Forms
                    </button>
                    <button class="btn btn-primary" onclick="generatePDFView()" style="font-size: 18px; padding: 15px 30px; background: #27ae60; color: white; border: 2px solid #27ae60;">
                        📄 Generate All Forms
                    </button>
                </div>
                <p style="color: #d4af37; margin-top: 10px; font-size: 14px;">Check boxes above to select specific forms, then use Ctrl+P (or Cmd+P) to save as PDF</p>
            </div>
        </div>

        <!-- Print Room Information Tab -->
        <div id="room-posters" class="tab-content">
            <h2>Print Room Information</h2>
            <p style="margin-bottom: 20px; color: #666;">Generate professional room posters for housing and small group rooms with all assignment details.</p>

            <!-- Search and Filter Controls -->
            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <input type="text"
                       id="room-search"
                       class="form-input"
                       placeholder="🔍 Search rooms by building, room number, or assigned group..."
                       oninput="filterRoomPosters()"
                       style="width: 100%; padding: 15px; border: 3px solid #061d28; border-radius: 8px; font-size: 16px; margin-bottom: 15px;">

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="showAllRoomPosters('all')" class="btn btn-primary">Show All Rooms</button>
                    <button onclick="showAllRoomPosters('housing')" class="btn btn-primary">Housing Rooms Only</button>
                    <button onclick="showAllRoomPosters('smallgroup')" class="btn btn-primary">Small Group Rooms Only</button>
                </div>
            </div>

            <!-- Print Controls -->
            <div style="text-align: center; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #061d28, #0f3a4a); border-radius: 10px;">
                <h3 style="color: #d4af37; margin-bottom: 15px;">📄 Print Options</h3>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="printAllRoomPosters()" class="btn" style="background: #27ae60; color: white; padding: 15px 30px; font-size: 16px;">
                        🖨️ Print All Visible Posters
                    </button>
                    <button onclick="printSelectedRoomPosters()" class="btn" style="background: #f39c12; color: white; padding: 15px 30px; font-size: 16px;">
                        🖨️ Print Selected Only
                    </button>
                </div>
            </div>

            <!-- Room Posters Container -->
            <div id="room-posters-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(600px, 1fr)); gap: 20px;">
                <!-- Room posters will be generated here -->
            </div>
        </div>

    </div>
    </div> <!-- End of main-content -->

    <script>
        // ===== GLOBAL VARIABLES =====
        let appData = {
            youthGroups: [],
            housingRooms: [],
            smallGroupRooms: [],
            housingAssignments: {
                male: {},
                female: {}
            },
            smallGroupAssignments: {},
            mealColorAssignments: {},
            mealTimes: {
                Blue: { friDinner: '5:30 PM', satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                Red: { friDinner: '6:00 PM', satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                Orange: { friDinner: '6:30 PM', satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                Yellow: { friDinner: '7:00 PM', satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' },
                Green: { friDinner: '5:30 PM', satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                Purple: { friDinner: '6:00 PM', satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                Brown: { friDinner: '6:30 PM', satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                Grey: { friDinner: '7:00 PM', satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' }
            },
            defaultNotes: {
                generalInfo: '',
                housingNotes: '',
                teenShowerPlan: '',
                adultShowerPlan: ''
            },
            groupNotes: {},
            resources: []
        };

        let editingGroupIndex = -1;
        let editingHousingRoomIndex = -1;
        let editingSmallGroupRoomIndex = -1;
        let selectedHousingAssignment = null;
        let selectedSmallGroupAssignment = null;
        let selectedFormsForPDF = new Set(); // Track which forms are selected for PDF generation

        // Available meal colors
        const MEAL_COLORS = ['Blue', 'Red', 'Orange', 'Yellow', 'Green', 'Purple', 'Brown', 'Grey'];

        // Sorting state
        let sortStates = {
            youthGroups: { field: null, ascending: true },
            housingRooms: { field: null, ascending: true },
            smallGroupRooms: { field: null, ascending: true },
            mealColors: { field: null, ascending: true }
        };

        // ===== TABLE FILTERING AND SORTING FUNCTIONS =====
        
        // Youth Groups Table Filtering and Sorting
        function filterYouthGroupsTable() {
            const filterValue = document.getElementById('youth-groups-filter').value.toLowerCase();
            const tbody = document.getElementById('youth-groups-table');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let showRow = false;
                
                // Check Group ID, Parish, Leader, Seminarian SGL, Phone
                for (let j = 0; j < 5; j++) {
                    if (cells[j] && cells[j].textContent.toLowerCase().includes(filterValue)) {
                        showRow = true;
                        break;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        function sortYouthGroupsTable() {
            const sortField = document.getElementById('youth-groups-sort').value;
            sortYouthGroupsBy(sortField);
        }

        function sortYouthGroupsBy(field) {
            const isNewField = sortStates.youthGroups.field !== field;
            sortStates.youthGroups.field = field;
            
            if (isNewField) {
                sortStates.youthGroups.ascending = true;
            } else {
                sortStates.youthGroups.ascending = !sortStates.youthGroups.ascending;
            }
            
            updateSortHeaders('youth-groups-table', field, sortStates.youthGroups.ascending);
            updateYouthGroupsTable();
            updateSortOrderButton('youth-groups-sort-order', sortStates.youthGroups.ascending);
        }

        function toggleYouthGroupsSortOrder() {
            if (sortStates.youthGroups.field) {
                sortStates.youthGroups.ascending = !sortStates.youthGroups.ascending;
                updateYouthGroupsTable();
                updateSortOrderButton('youth-groups-sort-order', sortStates.youthGroups.ascending);
            }
        }

        // Housing Rooms Table Filtering and Sorting
        function filterHousingRoomsTable() {
            const filterValue = document.getElementById('housing-rooms-filter').value.toLowerCase();
            const tbody = document.getElementById('housing-rooms-table');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let showRow = false;
                
                // Check Building, Room, Accessibility
                if ((cells[1] && cells[1].textContent.toLowerCase().includes(filterValue)) ||
                    (cells[2] && cells[2].textContent.toLowerCase().includes(filterValue)) ||
                    (cells[7] && cells[7].textContent.toLowerCase().includes(filterValue))) {
                    showRow = true;
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        function sortHousingRoomsTable() {
            const sortField = document.getElementById('housing-rooms-sort').value;
            sortHousingRoomsBy(sortField);
        }

        function sortHousingRoomsBy(field) {
            const isNewField = sortStates.housingRooms.field !== field;
            sortStates.housingRooms.field = field;
            
            if (isNewField) {
                sortStates.housingRooms.ascending = true;
            } else {
                sortStates.housingRooms.ascending = !sortStates.housingRooms.ascending;
            }
            
            updateSortHeaders('housing-rooms-table', field, sortStates.housingRooms.ascending);
            updateHousingRoomsTable();
            updateSortOrderButton('housing-rooms-sort-order', sortStates.housingRooms.ascending);
        }

        function toggleHousingRoomsSortOrder() {
            if (sortStates.housingRooms.field) {
                sortStates.housingRooms.ascending = !sortStates.housingRooms.ascending;
                updateHousingRoomsTable();
                updateSortOrderButton('housing-rooms-sort-order', sortStates.housingRooms.ascending);
            }
        }

        // Small Group Rooms Table Filtering and Sorting
        function filterSmallGroupRoomsTable() {
            const filterValue = document.getElementById('small-group-rooms-filter').value.toLowerCase();
            const tbody = document.getElementById('small-group-rooms-table');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let showRow = false;
                
                // Check Building, Room, Features
                if ((cells[1] && cells[1].textContent.toLowerCase().includes(filterValue)) ||
                    (cells[2] && cells[2].textContent.toLowerCase().includes(filterValue)) ||
                    (cells[7] && cells[7].textContent.toLowerCase().includes(filterValue))) {
                    showRow = true;
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        function sortSmallGroupRoomsTable() {
            const sortField = document.getElementById('small-group-rooms-sort').value;
            sortSmallGroupRoomsBy(sortField);
        }

        function sortSmallGroupRoomsBy(field) {
            const isNewField = sortStates.smallGroupRooms.field !== field;
            sortStates.smallGroupRooms.field = field;
            
            if (isNewField) {
                sortStates.smallGroupRooms.ascending = true;
            } else {
                sortStates.smallGroupRooms.ascending = !sortStates.smallGroupRooms.ascending;
            }
            
            updateSortHeaders('small-group-rooms-table', field, sortStates.smallGroupRooms.ascending);
            updateSmallGroupRoomsTable();
            updateSortOrderButton('small-group-rooms-sort-order', sortStates.smallGroupRooms.ascending);
        }

        function toggleSmallGroupRoomsSortOrder() {
            if (sortStates.smallGroupRooms.field) {
                sortStates.smallGroupRooms.ascending = !sortStates.smallGroupRooms.ascending;
                updateSmallGroupRoomsTable();
                updateSortOrderButton('small-group-rooms-sort-order', sortStates.smallGroupRooms.ascending);
            }
        }

        // Utility functions for sorting
        function updateSortHeaders(tableId, field, ascending) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th.sortable');
            
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Add sort class to the active header
            headers.forEach(header => {
                if (header.textContent.toLowerCase().includes(field.toLowerCase()) || 
                    header.onclick.toString().includes(`'${field}'`)) {
                    header.classList.add(ascending ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        function updateSortOrderButton(buttonId, ascending) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.textContent = ascending ? 'A→Z' : 'Z→A';
            }
        }

        function getSortedYouthGroups() {
            let sorted = [...appData.youthGroups];
            const { field, ascending } = sortStates.youthGroups;
            
            if (!field) return sorted;
            
            sorted.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'total':
                        valueA = a.maleTeens + a.femaleTeens + a.maleChaperones + a.femaleChaperones;
                        valueB = b.maleTeens + b.femaleTeens + b.maleChaperones + b.femaleChaperones;
                        break;
                    case 'status':
                        valueA = isGroupHousingAssigned(a.id) ? 1 : 0;
                        valueB = isGroupHousingAssigned(b.id) ? 1 : 0;
                        break;
                    case 'maleTeens':
                    case 'femaleTeens':
                    case 'maleChaperones':
                    case 'femaleChaperones':
                        valueA = a[field];
                        valueB = b[field];
                        break;
                    default:
                        valueA = (a[field] || '').toString().toLowerCase();
                        valueB = (b[field] || '').toString().toLowerCase();
                }
                
                if (typeof valueA === 'number') {
                    return ascending ? valueA - valueB : valueB - valueA;
                } else {
                    if (valueA < valueB) return ascending ? -1 : 1;
                    if (valueA > valueB) return ascending ? 1 : -1;
                    return 0;
                }
            });
            
            return sorted;
        }

        // Meal Colors Table Filtering and Sorting
        function filterMealColorsTable() {
            const filterValue = document.getElementById('meal-colors-filter').value.toLowerCase();
            const tbody = document.getElementById('meal-colors-table');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let showRow = false;
                
                // Check Group ID, Parish, Leader
                for (let j = 0; j < 3; j++) {
                    if (cells[j] && cells[j].textContent.toLowerCase().includes(filterValue)) {
                        showRow = true;
                        break;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }

        function sortMealColorsTable() {
            const sortField = document.getElementById('meal-colors-sort').value;
            sortMealColorsBy(sortField);
        }

        function sortMealColorsBy(field) {
            const isNewField = sortStates.mealColors.field !== field;
            sortStates.mealColors.field = field;
            
            if (isNewField) {
                sortStates.mealColors.ascending = true;
            } else {
                sortStates.mealColors.ascending = !sortStates.mealColors.ascending;
            }
            
            updateSortHeaders('meal-colors-table', field, sortStates.mealColors.ascending);
            updateMealColorsTable();
            updateSortOrderButton('meal-colors-sort-order', sortStates.mealColors.ascending);
        }

        function toggleMealColorsSortOrder() {
            if (sortStates.mealColors.field) {
                sortStates.mealColors.ascending = !sortStates.mealColors.ascending;
                updateMealColorsTable();
                updateSortOrderButton('meal-colors-sort-order', sortStates.mealColors.ascending);
            }
        }

        function getSortedMealColorGroups() {
            let sorted = [...appData.youthGroups];
            const { field, ascending } = sortStates.mealColors;
            
            if (!field) return sorted;
            
            sorted.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'total':
                        valueA = a.maleTeens + a.femaleTeens + a.maleChaperones + a.femaleChaperones;
                        valueB = b.maleTeens + b.femaleTeens + b.maleChaperones + b.femaleChaperones;
                        break;
                    case 'color':
                        valueA = appData.mealColorAssignments[a.id] || '';
                        valueB = appData.mealColorAssignments[b.id] || '';
                        break;
                    default:
                        valueA = (a[field] || '').toString().toLowerCase();
                        valueB = (b[field] || '').toString().toLowerCase();
                }
                
                if (typeof valueA === 'number') {
                    return ascending ? valueA - valueB : valueB - valueA;
                } else {
                    if (valueA < valueB) return ascending ? -1 : 1;
                    if (valueA > valueB) return ascending ? 1 : -1;
                    return 0;
                }
            });
            
            return sorted;
        }

        function getSortedHousingRooms() {
            let sorted = [...appData.housingRooms];
            const { field, ascending } = sortStates.housingRooms;
            
            if (!field) return sorted;
            
            sorted.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'occupied':
                        valueA = getHousingRoomOccupancy(`${a.building}-${a.roomId}`);
                        valueB = getHousingRoomOccupancy(`${b.building}-${b.roomId}`);
                        break;
                    case 'available':
                        valueA = a.capacity - getHousingRoomOccupancy(`${a.building}-${a.roomId}`);
                        valueB = b.capacity - getHousingRoomOccupancy(`${b.building}-${b.roomId}`);
                        break;
                    case 'sectionId':
                        valueA = `${a.building.substring(0, 3).toUpperCase()}-${a.roomId}`;
                        valueB = `${b.building.substring(0, 3).toUpperCase()}-${b.roomId}`;
                        break;
                    case 'capacity':
                        valueA = a.capacity;
                        valueB = b.capacity;
                        break;
                    default:
                        valueA = (a[field] || '').toString().toLowerCase();
                        valueB = (b[field] || '').toString().toLowerCase();
                }
                
                if (typeof valueA === 'number') {
                    return ascending ? valueA - valueB : valueB - valueA;
                } else {
                    if (valueA < valueB) return ascending ? -1 : 1;
                    if (valueA > valueB) return ascending ? 1 : -1;
                    return 0;
                }
            });
            
            return sorted;
        }

        function getSortedSmallGroupRooms() {
            let sorted = [...appData.smallGroupRooms];
            const { field, ascending } = sortStates.smallGroupRooms;
            
            if (!field) return sorted;
            
            sorted.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'occupied':
                        valueA = getSmallGroupRoomOccupancy(`${a.building}-${a.roomId}`);
                        valueB = getSmallGroupRoomOccupancy(`${b.building}-${b.roomId}`);
                        break;
                    case 'available':
                        valueA = a.capacity - getSmallGroupRoomOccupancy(`${a.building}-${a.roomId}`);
                        valueB = b.capacity - getSmallGroupRoomOccupancy(`${b.building}-${b.roomId}`);
                        break;
                    case 'locationId':
                        valueA = `${a.building.substring(0, 3).toUpperCase()}-${a.roomId}`;
                        valueB = `${b.building.substring(0, 3).toUpperCase()}-${b.roomId}`;
                        break;
                    case 'capacity':
                        valueA = a.capacity;
                        valueB = b.capacity;
                        break;
                    default:
                        valueA = (a[field] || '').toString().toLowerCase();
                        valueB = (b[field] || '').toString().toLowerCase();
                }
                
                if (typeof valueA === 'number') {
                    return ascending ? valueA - valueB : valueB - valueA;
                } else {
                    if (valueA < valueB) return ascending ? -1 : 1;
                    if (valueA > valueB) return ascending ? 1 : -1;
                    return 0;
                }
            });
            
            return sorted;
        }

        // ===== PRINTABLE FORMS MANAGEMENT =====
        function toggleMealTimesConfig() {
            const configDiv = document.getElementById('meal-times-config');
            const toggleIcon = document.getElementById('meal-times-toggle');
            
            if (configDiv.style.display === 'none') {
                configDiv.style.display = 'block';
                toggleIcon.textContent = '▲';
            } else {
                configDiv.style.display = 'none';
                toggleIcon.textContent = '▼';
            }
        }

        function updateMealTimesConfig() {
            const container = document.getElementById('meal-times-config');
            if (!container) return;

            const mealSlots = [
                { key: 'friDinner', label: 'Friday Dinner' },
                { key: 'satBreakfast', label: 'Saturday Breakfast' },
                { key: 'satLunch', label: 'Saturday Lunch' },
                { key: 'satDinner', label: 'Saturday Dinner' },
                { key: 'sunBreakfast', label: 'Sunday Breakfast' }
            ];

            let html = '';
            MEAL_COLORS.forEach(color => {
                const colorLower = color.toLowerCase();
                const colorBg = getColorForMealAssignment(color);
                
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${colorBg};">
                        <h4 style="margin-bottom: 10px; color: ${colorBg}; font-weight: bold;">
                            <span style="display: inline-block; width: 20px; height: 20px; background: ${colorBg}; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>
                            ${color} Group Meal Times
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                `;
                
                mealSlots.forEach(slot => {
                    const currentValue = appData.mealTimes[color] && appData.mealTimes[color][slot.key] ? appData.mealTimes[color][slot.key] : '';
                    html += `
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #666;">${slot.label}</label>
                            <input 
                                type="text" 
                                value="${currentValue}"
                                onchange="updateMealTime('${color}', '${slot.key}', this.value)"
                                placeholder="e.g., 6:00 PM"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                            />
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateMealTime(color, slot, time) {
            if (!appData.mealTimes[color]) {
                appData.mealTimes[color] = {};
            }
            appData.mealTimes[color][slot] = time;
            autoSave();
        }

        function saveDefaultNotes() {
            appData.defaultNotes.generalInfo = document.getElementById('default-general-info').value;
            appData.defaultNotes.housingNotes = document.getElementById('default-housing-notes').value;
            appData.defaultNotes.teenShowerPlan = document.getElementById('default-teen-shower').value;
            appData.defaultNotes.adultShowerPlan = document.getElementById('default-adult-shower').value;
            autoSave();
            alert('✅ Default notes saved successfully!');
        }

        function loadDefaultNotes() {
            document.getElementById('default-general-info').value = appData.defaultNotes.generalInfo || '';
            document.getElementById('default-housing-notes').value = appData.defaultNotes.housingNotes || '';
            document.getElementById('default-teen-shower').value = appData.defaultNotes.teenShowerPlan || '';
            document.getElementById('default-adult-shower').value = appData.defaultNotes.adultShowerPlan || '';
        }

        function updateGroupNote(groupId, note) {
            appData.groupNotes[groupId] = note;
            autoSave();
        }

        function filterFormsPreview() {
            const searchTerm = document.getElementById('forms-search').value.toLowerCase();
            const allForms = document.querySelectorAll('.individual-form-preview');
            
            allForms.forEach(form => {
                const formText = form.textContent.toLowerCase();
                if (formText.includes(searchTerm)) {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            });
        }

        function updateFormsPreview() {
            const container = document.getElementById('forms-preview-section');
            if (!container) return;

            if (appData.youthGroups.length === 0) {
                container.innerHTML = '<div class="notification warning">No youth groups added yet. Add groups in the Youth Groups tab first.</div>';
                return;
            }

            // Sort groups alphabetically by parish name
            const sortedGroups = [...appData.youthGroups].sort((a, b) => 
                a.parish.localeCompare(b.parish)
            );

            let html = '<h3 style="margin: 20px 0 15px 0;">📋 Individual Group Forms Preview</h3>';
            html += '<p style="font-size: 14px; color: #666; margin-bottom: 20px;">Preview and add custom notes for each group before generating PDFs.</p>';

            sortedGroups.forEach(group => {
                const groupNote = appData.groupNotes[group.id] || '';
                const maleHousing = getMaleHousingForForm(group.id);
                const femaleHousing = getFemaleHousingForForm(group.id);
                const smallGroupRoom = getSmallGroupForForm(group.id);
                const mealColor = appData.mealColorAssignments[group.id] || 'Not Assigned';
                const mealSchedule = getMealScheduleText(group.id);
                const isOffCampus = group.stayingOffCampus || false;
                const isSelected = selectedFormsForPDF.has(group.id);

                html += `
                    <div class="individual-form-preview" style="background: white; border: 2px solid #061d28; border-radius: 10px; padding: 20px; margin-bottom: 20px; page-break-inside: avoid;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input 
                                        type="checkbox" 
                                        ${isSelected ? 'checked' : ''}
                                        onchange="toggleFormSelection('${group.id}')"
                                        style="width: 24px; height: 24px; cursor: pointer; margin: 0;"
                                    >
                                </label>
                                <div style="background: linear-gradient(135deg, #061d28, #0f3a4a); color: #d4af37; padding: 10px 20px; border-radius: 6px; flex: 1; text-align: center;">
                                    <h3 style="margin: 0; font-size: 20px;">MOUNT 2000 YOUTH RETREAT 2026</h3>
                                    <p style="margin: 5px 0 0 0; font-size: 12px;">Housing & Information Check-In Form</p>
                                </div>
                            </div>
                            <button 
                                onclick="generateIndividualPDF('${group.id}')" 
                                class="btn btn-primary" 
                                style="margin-left: 15px; padding: 10px 20px; font-size: 14px; white-space: nowrap;"
                            >
                                🖨️ Print This Form
                            </button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong style="font-size: 12px; color: #666;">Parish/Group:</strong>
                                <div style="font-size: 16px; font-weight: bold; border-bottom: 2px solid #d4af37; padding: 5px 0;">${group.parish}</div>
                            </div>
                            <div>
                                <strong style="font-size: 12px; color: #666;">Group Leader:</strong>
                                <div style="font-size: 16px; border-bottom: 2px solid #d4af37; padding: 5px 0;">${group.leader}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong style="font-size: 12px; color: #666;">Leader Phone:</strong>
                                <div style="font-size: 16px; border-bottom: 2px solid #d4af37; padding: 5px 0;">${group.phone}</div>
                            </div>
                            <div>
                                <strong style="font-size: 12px; color: #666;">Seminarian Small Group Leader:</strong>
                                <div style="font-size: 16px; border-bottom: 2px solid #d4af37; padding: 5px 0;">${group.seminarianSgl || 'N/A'}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <div>
                                <strong style="font-size: 11px; color: #666;">Male Teens:</strong>
                                <div style="font-size: 18px; font-weight: bold;">${group.maleTeens}</div>
                            </div>
                            <div>
                                <strong style="font-size: 11px; color: #666;">Female Teens:</strong>
                                <div style="font-size: 18px; font-weight: bold;">${group.femaleTeens}</div>
                            </div>
                            <div>
                                <strong style="font-size: 11px; color: #666;">Male Chaperones:</strong>
                                <div style="font-size: 18px; font-weight: bold;">${group.maleChaperones}</div>
                            </div>
                            <div>
                                <strong style="font-size: 11px; color: #666;">Female Chaperones:</strong>
                                <div style="font-size: 18px; font-weight: bold;">${group.femaleChaperones}</div>
                            </div>
                        </div>

                        <div style="border-top: 2px solid #061d28; padding-top: 15px; margin-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;">🏠 HOUSING ASSIGNMENTS</h4>
                            <div style="margin-bottom: 10px;">
                                <strong style="font-size: 13px;">Male Housing:</strong>
                                <div style="background: #e6f3ff; padding: 8px; border-radius: 4px; border-left: 4px solid #3498db; margin-top: 4px;">${maleHousing}</div>
                            </div>
                            <div>
                                <strong style="font-size: 13px;">Female Housing:</strong>
                                <div style="background: #fff0f6; padding: 8px; border-radius: 4px; border-left: 4px solid #9b59b6; margin-top: 4px;">${femaleHousing}</div>
                            </div>
                        </div>

                        <div style="margin-top: 15px;">
                            <strong style="font-size: 13px;">👥 Small Group Room Assignment:</strong>
                            <div style="background: #f0f8ff; padding: 8px; border-radius: 4px; border-left: 4px solid #27ae60; margin-top: 4px;">${smallGroupRoom}</div>
                        </div>

                        <div style="margin-top: 15px;">
                            <strong style="font-size: 13px;">🍽️ Meal Schedule - ${mealColor}:</strong>
                            <div style="background: ${getColorForMealAssignment(mealColor)}; color: white; padding: 10px; border-radius: 4px; margin-top: 4px; white-space: pre-line; font-size: 12px;">${mealSchedule}</div>
                        </div>

                        ${appData.defaultNotes.generalInfo ? `
                            <div style="margin-top: 15px;">
                                <strong style="font-size: 13px;">ℹ️ General Information:</strong>
                                <div style="background: #e3f2fd; padding: 8px; border-radius: 4px; border-left: 4px solid #2196f3; margin-top: 4px; white-space: pre-line; font-size: 12px;">${appData.defaultNotes.generalInfo}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && appData.defaultNotes.housingNotes ? `
                            <div style="margin-top: 15px;">
                                <strong style="font-size: 13px;">📝 Housing Notes/Information:</strong>
                                <div style="background: #fffbea; padding: 8px; border-radius: 4px; border-left: 4px solid #f1c40f; margin-top: 4px; white-space: pre-line; font-size: 12px;">${appData.defaultNotes.housingNotes}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && appData.defaultNotes.teenShowerPlan ? `
                            <div style="margin-top: 15px;">
                                <strong style="font-size: 13px;">🚿 Teen Shower Plan:</strong>
                                <div style="background: #e8f5e9; padding: 8px; border-radius: 4px; border-left: 4px solid #27ae60; margin-top: 4px; white-space: pre-line; font-size: 12px;">${appData.defaultNotes.teenShowerPlan}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && appData.defaultNotes.adultShowerPlan ? `
                            <div style="margin-top: 15px;">
                                <strong style="font-size: 13px;">🚿 Adult Chaperone Shower Plan:</strong>
                                <div style="background: #f3e5f5; padding: 8px; border-radius: 4px; border-left: 4px solid #9b59b6; margin-top: 4px; white-space: pre-line; font-size: 12px;">${appData.defaultNotes.adultShowerPlan}</div>
                            </div>
                        ` : ''}

                        ${group.specialAccommodations ? `
                            <div style="margin-top: 15px; background: #fff3cd; padding: 10px; border-radius: 4px; border-left: 4px solid #f39c12;">
                                <strong style="font-size: 13px;">⚠️ Special Accommodations:</strong>
                                <div style="margin-top: 4px; font-size: 12px;">${group.specialAccommodations}</div>
                            </div>
                        ` : ''}

                        <div style="margin-top: 15px;">
                            <strong style="font-size: 13px;">💬 Additional Notes for ${group.parish}:</strong>
                            <textarea 
                                id="group-note-${group.id}"
                                onchange="updateGroupNote('${group.id}', this.value)"
                                placeholder="Add any specific notes for this group..."
                                style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 13px; margin-top: 4px; min-height: 80px; font-family: inherit;"
                            >${groupNote}</textarea>
                        </div>

                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; text-align: center; font-size: 11px; color: #666;">
                            Mount St. Mary's University/Seminary | Mount 2000 Youth Retreat 2026
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getMaleHousingForForm(groupId) {
            const assignments = appData.housingAssignments.male[groupId];
            if (!assignments || assignments.length === 0) return 'Not Assigned';
            
            return assignments.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            }).join(', ');
        }

        function getFemaleHousingForForm(groupId) {
            const assignments = appData.housingAssignments.female[groupId];
            if (!assignments || assignments.length === 0) return 'Not Assigned';
            
            return assignments.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            }).join(', ');
        }

        function getSmallGroupForForm(groupId) {
            const assignments = appData.smallGroupAssignments[groupId];
            if (!assignments || assignments.length === 0) return 'Not Assigned';
            
            return assignments.map(roomKey => {
                const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                if (room && room.features) {
                    return `${room.building} - ${room.roomId} (${room.features})`;
                }
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            }).join(', ');
        }

        function getMealScheduleText(groupId) {
            const color = appData.mealColorAssignments[groupId];
            if (!color) return 'Not Assigned';

            const times = appData.mealTimes[color];
            if (!times) return color;

            const mealSlots = [
                { key: 'friDinner', label: 'Friday Dinner' },
                { key: 'satBreakfast', label: 'Saturday Breakfast' },
                { key: 'satLunch', label: 'Saturday Lunch' },
                { key: 'satDinner', label: 'Saturday Dinner' },
                { key: 'sunBreakfast', label: 'Sunday Breakfast' }
            ];

            const schedule = [];
            mealSlots.forEach(slot => {
                if (times[slot.key]) {
                    schedule.push(`${slot.label}: ${times[slot.key]}`);
                }
            });

            return schedule.length > 0 ? schedule.join('\n') : color;
        }

        function toggleFormSelection(groupId) {
            if (selectedFormsForPDF.has(groupId)) {
                selectedFormsForPDF.delete(groupId);
            } else {
                selectedFormsForPDF.add(groupId);
            }
        }

        function generateSelectedPDFs() {
            if (selectedFormsForPDF.size === 0) {
                alert('⚠️ Please select at least one form by checking the boxes next to the forms you want to generate.');
                return;
            }

            const selectedGroups = appData.youthGroups.filter(g => selectedFormsForPDF.has(g.id));
            generatePDFViewForGroups(selectedGroups);
        }

        function generateIndividualPDF(groupId) {
            const group = appData.youthGroups.find(g => g.id === groupId);
            if (!group) {
                alert('Group not found!');
                return;
            }

            const printWindow = window.open('', '_blank');
            
            const maleHousing = getMaleHousingForForm(group.id);
            const femaleHousing = getFemaleHousingForForm(group.id);
            const smallGroupRoom = getSmallGroupForForm(group.id);
            const mealColor = appData.mealColorAssignments[group.id] || 'Not Assigned';
            const mealSchedule = getMealScheduleText(group.id);
            const groupNote = appData.groupNotes[group.id] || '';
            const isOffCampus = group.stayingOffCampus || false;

            let printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${group.parish} - Check-In Form</title>
                    <style>
                        @page {
                            size: letter;
                            margin: 0.5in;
                        }
                        @media print {
                            .no-print {
                                display: none !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 12pt;
                            line-height: 1.4;
                            color: #000;
                        }
                        .form-container {
                            background: white;
                            padding: 20px;
                        }
                        .header {
                            background: #061d28;
                            color: #d4af37;
                            padding: 20px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .header h1 {
                            margin: 0;
                            font-size: 24pt;
                        }
                        .header p {
                            margin: 8px 0 0 0;
                            font-size: 14pt;
                        }
                        .field-label {
                            font-weight: bold;
                            font-size: 10pt;
                            color: #666;
                            margin-bottom: 4px;
                        }
                        .field-value {
                            font-size: 14pt;
                            border-bottom: 2px solid #d4af37;
                            padding: 6px 0;
                            margin-bottom: 12px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 12px;
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 15px;
                        }
                        .section-header {
                            font-size: 14pt;
                            font-weight: bold;
                            border-top: 2px solid #061d28;
                            padding-top: 15px;
                            margin-top: 15px;
                            margin-bottom: 10px;
                        }
                        .housing-box {
                            padding: 10px;
                            border-radius: 4px;
                            margin: 8px 0;
                            border-left: 4px solid;
                        }
                        .male-housing {
                            background: #e6f3ff;
                            border-left-color: #3498db;
                        }
                        .female-housing {
                            background: #fff0f6;
                            border-left-color: #9b59b6;
                        }
                        .off-campus-box {
                            background: #fff3cd;
                            border-left-color: #e67e22;
                            text-align: center;
                            padding: 15px;
                        }
                        .small-group-box {
                            background: #f0f8ff;
                            border-left-color: #27ae60;
                        }
                        .notes-box {
                            background: #fffbea;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #f1c40f;
                            margin: 8px 0;
                            white-space: pre-line;
                        }
                        .general-info-box {
                            background: #e3f2fd;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #2196f3;
                            margin: 8px 0;
                            white-space: pre-line;
                        }
                        .special-box {
                            background: #fff3cd;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #f39c12;
                            margin: 8px 0;
                        }
                        .footer {
                            margin-top: 20px;
                            padding-top: 10px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            font-size: 9pt;
                            color: #666;
                        }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <button onclick="window.print()" style="padding: 12px 24px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px;">
                            🖨️ Print to PDF
                        </button>
                        <button onclick="window.close()" style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Close
                        </button>
                    </div>
                    
                    <div class="form-container">
                        <div class="header">
                            <h1>MOUNT 2000 YOUTH RETREAT 2026</h1>
                            <p>Housing & Information Check-In Form</p>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div class="field-label">Parish/Group:</div>
                                <div class="field-value">${group.parish}</div>
                            </div>
                            <div>
                                <div class="field-label">Group Leader:</div>
                                <div class="field-value">${group.leader}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div class="field-label">Leader Phone:</div>
                                <div class="field-value">${group.phone}</div>
                            </div>
                            <div>
                                <div class="field-label">Seminarian Small Group Leader:</div>
                                <div class="field-value">${group.seminarianSgl || 'N/A'}</div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div>
                                <div class="field-label">Male Teens:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.maleTeens}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Teens:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.femaleTeens}</div>
                            </div>
                            <div>
                                <div class="field-label">Male Chaperones:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.maleChaperones}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Chaperones:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.femaleChaperones}</div>
                            </div>
                        </div>

                        <div class="section-header">🏠 HOUSING ASSIGNMENTS</div>
                        ${isOffCampus ? `
                            <div class="housing-box off-campus-box">
                                <strong style="font-size: 16pt; color: #856404;">🏕️ OFF-CAMPUS HOUSING</strong>
                                <p style="margin: 5px 0 0 0; color: #856404;">This group is staying off-campus</p>
                            </div>
                        ` : `
                            <div>
                                <div class="field-label">Male Housing:</div>
                                <div class="housing-box male-housing">${maleHousing}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Housing:</div>
                                <div class="housing-box female-housing">${femaleHousing}</div>
                            </div>
                        `}

                        <div style="margin-top: 15px;">
                            <div class="field-label">👥 Small Group Room Assignment:</div>
                            <div class="housing-box small-group-box">${smallGroupRoom}</div>
                        </div>

                        <div style="margin-top: 15px;">
                            <div class="field-label">🍽️ Meal Schedule - ${mealColor}:</div>
                            <div class="notes-box" style="background: ${getColorForMealAssignment(mealColor)}; color: white; border-left-color: ${getColorForMealAssignment(mealColor)};">${mealSchedule}</div>
                        </div>

                        ${!isOffCampus && appData.defaultNotes.housingNotes ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">📝 Housing Notes/Information:</div>
                                <div class="notes-box">${appData.defaultNotes.housingNotes}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && appData.defaultNotes.teenShowerPlan ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">🚿 Teen Shower Plan:</div>
                                <div class="notes-box" style="background: #e8f5e9; border-left-color: #27ae60;">${appData.defaultNotes.teenShowerPlan}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && appData.defaultNotes.adultShowerPlan ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">🚿 Adult Chaperone Shower Plan:</div>
                                <div class="notes-box" style="background: #f3e5f5; border-left-color: #9b59b6;">${appData.defaultNotes.adultShowerPlan}</div>
                            </div>
                        ` : ''}

                        ${appData.defaultNotes.generalInfo ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">ℹ️ General Information:</div>
                                <div class="general-info-box">${appData.defaultNotes.generalInfo}</div>
                            </div>
                        ` : ''}

                        ${group.specialAccommodations ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">⚠️ Special Accommodations:</div>
                                <div class="special-box">${group.specialAccommodations}</div>
                            </div>
                        ` : ''}

                        ${groupNote ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">💬 Additional Notes:</div>
                                <div class="general-info-box">${groupNote}</div>
                            </div>
                        ` : ''}

                        <div class="footer">
                            Mount St. Mary's University/Seminary | Mount 2000 Youth Retreat 2026
                        </div>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(printHTML);
            printWindow.document.close();
        }

        function generatePDFView() {
            if (appData.youthGroups.length === 0) {
                alert('No youth groups to generate forms for!');
                return;
            }

            const sortedGroups = [...appData.youthGroups].sort((a, b) => 
                a.parish.localeCompare(b.parish)
            );
            
            generatePDFViewForGroups(sortedGroups);
        }

        function generatePDFViewForGroups(groupsToGenerate) {
            if (!groupsToGenerate || groupsToGenerate.length === 0) {
                alert('No youth groups to generate forms for!');
                return;
            }

            // Create a new window with print-optimized content
            const printWindow = window.open('', '_blank');
            
            // Sort the provided groups alphabetically
            const sortedGroups = [...groupsToGenerate].sort((a, b) => 
                a.parish.localeCompare(b.parish)
            );

            let printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mount 2000 Check-In Forms - ${new Date().toLocaleDateString()}</title>
                    <style>
                        @page {
                            size: letter;
                            margin: 0.5in;
                        }
                        @media print {
                            .page-break {
                                page-break-after: always;
                            }
                            .no-print {
                                display: none !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 12pt;
                            line-height: 1.4;
                            color: #000;
                        }
                        .form-container {
                            background: white;
                            padding: 20px;
                            margin-bottom: 20px;
                        }
                        .header {
                            background: #061d28;
                            color: #d4af37;
                            padding: 20px;
                            text-align: center;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .header h1 {
                            margin: 0;
                            font-size: 24pt;
                        }
                        .header p {
                            margin: 8px 0 0 0;
                            font-size: 14pt;
                        }
                        .field-label {
                            font-weight: bold;
                            font-size: 10pt;
                            color: #666;
                            margin-bottom: 4px;
                        }
                        .field-value {
                            font-size: 14pt;
                            border-bottom: 2px solid #d4af37;
                            padding: 6px 0;
                            margin-bottom: 12px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 12px;
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 15px;
                        }
                        .section-header {
                            font-size: 14pt;
                            font-weight: bold;
                            border-top: 2px solid #061d28;
                            padding-top: 15px;
                            margin-top: 15px;
                            margin-bottom: 10px;
                        }
                        .housing-box {
                            padding: 10px;
                            border-radius: 4px;
                            margin: 8px 0;
                            border-left: 4px solid;
                        }
                        .male-housing {
                            background: #e6f3ff;
                            border-left-color: #3498db;
                        }
                        .female-housing {
                            background: #fff0f6;
                            border-left-color: #9b59b6;
                        }
                        .off-campus-box {
                            background: #fff3cd;
                            border-left-color: #e67e22;
                            text-align: center;
                            padding: 15px;
                        }
                        .small-group-box {
                            background: #f0f8ff;
                            border-left-color: #27ae60;
                        }
                        .notes-box {
                            background: #fffbea;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #f1c40f;
                            margin: 8px 0;
                            white-space: pre-line;
                        }
                        .general-info-box {
                            background: #e3f2fd;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #2196f3;
                            margin: 8px 0;
                            white-space: pre-line;
                        }
                        .special-box {
                            background: #fff3cd;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 4px solid #f39c12;
                            margin: 8px 0;
                        }
                        .footer {
                            margin-top: 20px;
                            padding-top: 10px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            font-size: 9pt;
                            color: #666;
                        }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <button onclick="window.print()" style="padding: 12px 24px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px;">
                            🖨️ Print to PDF
                        </button>
                        <button onclick="window.close()" style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Close
                        </button>
                    </div>
            `;

            sortedGroups.forEach((group, index) => {
                const maleHousing = getMaleHousingForForm(group.id);
                const femaleHousing = getFemaleHousingForForm(group.id);
                const smallGroupRoom = getSmallGroupForForm(group.id);
                const mealColor = appData.mealColorAssignments[group.id] || 'Not Assigned';
                const mealSchedule = getMealScheduleText(group.id);
                const groupNote = appData.groupNotes[group.id] || '';
                const isOffCampus = group.stayingOffCampus || false;

                printHTML += `
                    <div class="form-container ${index < sortedGroups.length - 1 ? 'page-break' : ''}">
                        <div class="header">
                            <h1>MOUNT 2000 YOUTH RETREAT 2026</h1>
                            <p>Housing & Information Check-In Form</p>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div class="field-label">Parish/Group:</div>
                                <div class="field-value">${group.parish}</div>
                            </div>
                            <div>
                                <div class="field-label">Group Leader:</div>
                                <div class="field-value">${group.leader}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div class="field-label">Leader Phone:</div>
                                <div class="field-value">${group.phone}</div>
                            </div>
                            <div>
                                <div class="field-label">Seminarian Small Group Leader:</div>
                                <div class="field-value">${group.seminarianSgl || 'N/A'}</div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div>
                                <div class="field-label">Male Teens:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.maleTeens}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Teens:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.femaleTeens}</div>
                            </div>
                            <div>
                                <div class="field-label">Male Chaperones:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.maleChaperones}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Chaperones:</div>
                                <div style="font-size: 18pt; font-weight: bold;">${group.femaleChaperones}</div>
                            </div>
                        </div>

                        <div class="section-header">🏠 HOUSING ASSIGNMENTS</div>
                        ${isOffCampus ? `
                            <div class="housing-box off-campus-box">
                                <strong style="font-size: 16pt; color: #856404;">🏕️ OFF-CAMPUS HOUSING</strong>
                                <p style="margin: 5px 0 0 0; color: #856404;">This group is staying off-campus</p>
                            </div>
                        ` : `
                            <div>
                                <div class="field-label">Male Housing:</div>
                                <div class="housing-box male-housing">${maleHousing}</div>
                            </div>
                            <div>
                                <div class="field-label">Female Housing:</div>
                                <div class="housing-box female-housing">${femaleHousing}</div>
                            </div>
                        `}

                        <div style="margin-top: 15px;">
                            <div class="field-label">👥 Small Group Room Assignment:</div>
                            <div class="housing-box small-group-box">${smallGroupRoom}</div>
                        </div>

                        <div style="margin-top: 15px;">
                            <div class="field-label">🍽️ Meal Schedule - ${mealColor}:</div>
                            <div class="notes-box" style="background: ${getColorForMealAssignment(mealColor)}; color: white; border-left-color: ${getColorForMealAssignment(mealColor)};">${mealSchedule}</div>
                        </div>

                        ${!isOffCampus && appData.defaultNotes.housingNotes ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">📝 Housing Notes/Information:</div>
                                <div class="notes-box">${appData.defaultNotes.housingNotes}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && appData.defaultNotes.teenShowerPlan ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">🚿 Teen Shower Plan:</div>
                                <div class="notes-box" style="background: #e8f5e9; border-left-color: #27ae60;">${appData.defaultNotes.teenShowerPlan}</div>
                            </div>
                        ` : ''}

                        ${!isOffCampus && appData.defaultNotes.adultShowerPlan ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">🚿 Adult Chaperone Shower Plan:</div>
                                <div class="notes-box" style="background: #f3e5f5; border-left-color: #9b59b6;">${appData.defaultNotes.adultShowerPlan}</div>
                            </div>
                        ` : ''}

                        ${appData.defaultNotes.generalInfo ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">ℹ️ General Information:</div>
                                <div class="general-info-box">${appData.defaultNotes.generalInfo}</div>
                            </div>
                        ` : ''}

                        ${group.specialAccommodations ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">⚠️ Special Accommodations:</div>
                                <div class="special-box">${group.specialAccommodations}</div>
                            </div>
                        ` : ''}

                        ${groupNote ? `
                            <div style="margin-top: 15px;">
                                <div class="field-label">💬 Additional Notes:</div>
                                <div class="notes-box" style="background: #e3f2fd; border-left-color: #2196f3;">${groupNote}</div>
                            </div>
                        ` : ''}

                        <div class="footer">
                            Mount St. Mary's University/Seminary | Mount 2000 Youth Retreat 2026
                        </div>
                    </div>
                `;
            });

            printHTML += `
                </body>
                </html>
            `;

            printWindow.document.write(printHTML);
            printWindow.document.close();
        }

        // ===== SYSTEM INITIALIZATION =====
        async function initializeSystem() {
            await loadDataFromJSON();
            updateAllDisplays();
            setupKeyboardShortcuts();
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                // Check for Cmd+S (Mac) or Ctrl+S (Windows/Linux)
                if ((event.metaKey || event.ctrlKey) && event.key === 's') {
                    event.preventDefault(); // Prevent browser's default save
                    exportCompleteHTML();
                }
            });
        }

        async function loadDataFromJSON() {
            try {
                const response = await fetch('m2k_2026_housing_data (1).json');
                
                if (!response.ok) {
                    throw new Error('Data file not found');
                }
                
                const data = await response.json();
                
                // Load all data from JSON
                appData.youthGroups = data.youthGroups || [];
                appData.housingRooms = data.housingRooms || [];
                appData.smallGroupRooms = data.smallGroupRooms || [];
                appData.housingAssignments = data.housingAssignments || { male: {}, female: {} };
                appData.smallGroupAssignments = data.smallGroupAssignments || {};
                appData.mealColorAssignments = data.mealColorAssignments || {};
                appData.mealTimes = data.mealTimes || {
                    Blue: { friDinner: '5:30 PM', satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                    Red: { friDinner: '6:00 PM', satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                    Orange: { friDinner: '6:30 PM', satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                    Yellow: { friDinner: '7:00 PM', satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' },
                    Green: { friDinner: '5:30 PM', satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                    Purple: { friDinner: '6:00 PM', satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                    Brown: { friDinner: '6:30 PM', satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                    Grey: { friDinner: '7:00 PM', satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' }
                };
                
                // Ensure defaultNotes has all fields, including new generalInfo field
                appData.defaultNotes = {
                    generalInfo: data.defaultNotes?.generalInfo || '',
                    housingNotes: data.defaultNotes?.housingNotes || '',
                    teenShowerPlan: data.defaultNotes?.teenShowerPlan || '',
                    adultShowerPlan: data.defaultNotes?.adultShowerPlan || ''
                };
                
                appData.groupNotes = data.groupNotes || {};
                appData.resources = data.resources || [];

                console.log('✅ Data loaded successfully from JSON file');
                
            } catch (error) {
                console.warn('⚠️ Could not load data file:', error);
                
                // Show friendly error message on dashboard
                showDataLoadError();
                
                // Initialize with empty data structure
                appData.youthGroups = [];
                appData.housingRooms = [];
                appData.smallGroupRooms = [];
                appData.housingAssignments = { male: {}, female: {} };
                appData.smallGroupAssignments = {};
                appData.mealColorAssignments = {};
                appData.mealTimes = {
                    Blue: { friDinner: '5:30 PM', satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                    Red: { friDinner: '6:00 PM', satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                    Orange: { friDinner: '6:30 PM', satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                    Yellow: { friDinner: '7:00 PM', satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' },
                    Green: { friDinner: '5:30 PM', satBreakfast: '7:00 AM', satLunch: '12:00 PM', satDinner: '5:30 PM', sunBreakfast: '7:30 AM' },
                    Purple: { friDinner: '6:00 PM', satBreakfast: '7:30 AM', satLunch: '12:30 PM', satDinner: '6:00 PM', sunBreakfast: '8:00 AM' },
                    Brown: { friDinner: '6:30 PM', satBreakfast: '8:00 AM', satLunch: '1:00 PM', satDinner: '6:30 PM', sunBreakfast: '8:30 AM' },
                    Grey: { friDinner: '7:00 PM', satBreakfast: '8:30 AM', satLunch: '1:30 PM', satDinner: '7:00 PM', sunBreakfast: '9:00 AM' }
                };
                appData.defaultNotes = { generalInfo: '', housingNotes: '', teenShowerPlan: '', adultShowerPlan: '' };
                appData.groupNotes = {};
                appData.resources = [];
            }
        }

        function showDataLoadError() {
            // Add error notification to dashboard
            setTimeout(() => {
                const dashboard = document.getElementById('dashboard');
                if (dashboard) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'notification warning';
                    errorDiv.style.cssText = 'margin: 20px 0; padding: 20px; background: #fff3cd; border: 2px solid #f39c12; border-radius: 10px;';
                    errorDiv.innerHTML = `
                        <h3 style="margin: 0 0 10px 0; color: #856404;">⚠️ Whoops, looks like we can't find the data right now!</h3>
                        <p style="margin: 0; color: #856404;">You can insert old information into the folder or start here. Once you add data and save it, place the <strong>m2k_2026_housing_data.json</strong> file in the same folder as this HTML file and rename it to <strong>m2k_2026_housing_data (1).json</strong></p>
                    `;
                    dashboard.insertBefore(errorDiv, dashboard.firstChild.nextSibling);
                }
            }, 100);
        }

        function loadSampleData() {
            // This function is no longer used - data is loaded from JSON file
            // Kept for compatibility
        }

        // ===== TAB MANAGEMENT =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'housing-assignments') {
                updateHousingAssignmentDropdown();
            } else if (tabName === 'small-group-assignments') {
                updateSmallGroupAssignmentDropdown();
            } else if (tabName === 'meal-colors') {
                updateMealColorsTable();
                updateMealColorSummary();
                updateMealTimesConfig();
                // Expand meal times on first visit
                const configDiv = document.getElementById('meal-times-config');
                if (configDiv && configDiv.innerHTML && configDiv.style.display === 'none') {
                    // Keep it collapsed by default - user can expand if needed
                }
            } else if (tabName === 'resources') {
                displayResources();
            } else if (tabName === 'printable-forms') {
                loadDefaultNotes();
                updateFormsPreview();
            } else if (tabName === 'room-posters') {
                loadRoomNotes();
                displayRoomPosters();
            }
        }

        // ===== CSV IMPORT/EXPORT FOR YOUTH GROUPS =====
        function downloadCSVTemplate() {
            const headers = [
                'Group ID',
                'Parish Name',
                'Group Leader',
                'Seminarian SGL',
                'Phone Number',
                'Male Teens',
                'Female Teens',
                'Male Chaperones',
                'Female Chaperones',
                'Off-Campus',
                'Special Accommodations'
            ];
            
            const sampleRow = [
                '1',
                'St. Example Parish',
                'John Smith',
                'Fr. Michael',
                '123-456-7890',
                '15',
                '20',
                '3',
                '4',
                'No',
                'Wheelchair accessible room needed'
            ];
            
            let csvContent = headers.join(',') + '\n';
            csvContent += sampleRow.join(',') + '\n';
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'm2k_youth_groups_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ CSV Template downloaded!\n\nThe template includes:\n• All required and optional columns\n• One sample row showing the format\n• Instructions in the sample data\n\nFill it out and use "Import from CSV" to add your groups!');
        }

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    
                    if (lines.length < 2) {
                        alert('❌ CSV file is empty or invalid!');
                        return;
                    }
                    
                    // Parse header row
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    // Validate required headers
                    const groupIdIndex = headers.findIndex(h => h.toLowerCase().includes('group') && h.toLowerCase().includes('id'));
                    const parishIndex = headers.findIndex(h => h.toLowerCase().includes('parish'));
                    
                    if (groupIdIndex === -1 || parishIndex === -1) {
                        alert('❌ CSV must have "Group ID" and "Parish Name" columns!');
                        return;
                    }
                    
                    // Find optional column indices
                    const leaderIndex = headers.findIndex(h => h.toLowerCase().includes('leader'));
                    const seminarianIndex = headers.findIndex(h => h.toLowerCase().includes('seminarian') || h.toLowerCase().includes('sgl'));
                    const phoneIndex = headers.findIndex(h => h.toLowerCase().includes('phone'));
                    const maleTeensIndex = headers.findIndex(h => h.toLowerCase().includes('male') && h.toLowerCase().includes('teen'));
                    const femaleTeensIndex = headers.findIndex(h => h.toLowerCase().includes('female') && h.toLowerCase().includes('teen'));
                    const maleChaperoneIndex = headers.findIndex(h => h.toLowerCase().includes('male') && h.toLowerCase().includes('chap'));
                    const femaleChaperoneIndex = headers.findIndex(h => h.toLowerCase().includes('female') && h.toLowerCase().includes('chap'));
                    const offCampusIndex = headers.findIndex(h => h.toLowerCase().includes('off') && h.toLowerCase().includes('campus'));
                    const accommodationsIndex = headers.findIndex(h => h.toLowerCase().includes('special') || h.toLowerCase().includes('accommod'));
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    const errors = [];
                    
                    // Process data rows
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue; // Skip empty lines
                        
                        const values = parseCSVLine(line);
                        
                        const groupId = values[groupIdIndex]?.trim();
                        const parishName = values[parishIndex]?.trim();
                        
                        // Skip if missing required fields
                        if (!groupId || !parishName) {
                            skippedCount++;
                            errors.push(`Row ${i + 1}: Missing Group ID or Parish Name`);
                            continue;
                        }
                        
                        // Check if group already exists
                        const existingIndex = appData.youthGroups.findIndex(g => g.id === groupId);
                        if (existingIndex !== -1) {
                            skippedCount++;
                            errors.push(`Row ${i + 1}: Group ID "${groupId}" already exists`);
                            continue;
                        }
                        
                        // Parse off-campus status
                        let offCampus = false;
                        if (offCampusIndex !== -1 && values[offCampusIndex]) {
                            const offCampusValue = values[offCampusIndex].trim().toLowerCase();
                            offCampus = offCampusValue === 'yes' || 
                                       offCampusValue === 'true' || 
                                       offCampusValue === 'x' || 
                                       offCampusValue === '1' ||
                                       offCampusValue === 'y';
                        }
                        
                        // Create new group
                        const newGroup = {
                            id: groupId,
                            parish: parishName,
                            leader: leaderIndex !== -1 ? (values[leaderIndex]?.trim() || '') : '',
                            seminarianSgl: seminarianIndex !== -1 ? (values[seminarianIndex]?.trim() || '') : '',
                            phone: phoneIndex !== -1 ? (values[phoneIndex]?.trim() || '') : '',
                            maleTeens: maleTeensIndex !== -1 ? (parseInt(values[maleTeensIndex]) || 0) : 0,
                            femaleTeens: femaleTeensIndex !== -1 ? (parseInt(values[femaleTeensIndex]) || 0) : 0,
                            maleChaperones: maleChaperoneIndex !== -1 ? (parseInt(values[maleChaperoneIndex]) || 0) : 0,
                            femaleChaperones: femaleChaperoneIndex !== -1 ? (parseInt(values[femaleChaperoneIndex]) || 0) : 0,
                            stayingOffCampus: offCampus,
                            specialAccommodations: accommodationsIndex !== -1 ? (values[accommodationsIndex]?.trim() || '') : ''
                        };
                        
                        appData.youthGroups.push(newGroup);
                        importedCount++;
                        
                        // Auto-assign off-campus housing if needed
                        if (offCampus) {
                            autoAssignOffCampusHousing(groupId);
                        }
                    }
                    
                    // Clear the file input
                    event.target.value = '';
                    
                    // Update displays
                    updateAllDisplays();
                    autoSave();
                    
                    // Show results
                    let message = `✅ Import Complete!\n\n`;
                    message += `✓ Successfully imported: ${importedCount} groups\n`;
                    if (skippedCount > 0) {
                        message += `⚠ Skipped: ${skippedCount} rows\n\n`;
                        if (errors.length > 0 && errors.length <= 10) {
                            message += `Errors:\n${errors.join('\n')}`;
                        } else if (errors.length > 10) {
                            message += `Errors (first 10):\n${errors.slice(0, 10).join('\n')}\n... and ${errors.length - 10} more`;
                        }
                    }
                    
                    alert(message);
                    
                } catch (error) {
                    alert('❌ Error reading CSV file: ' + error.message + '\n\nMake sure your file is a valid CSV format.');
                    console.error('CSV Import Error:', error);
                }
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);
            
            return values.map(v => v.trim().replace(/^"|"$/g, ''));
        }

        // ===== YOUTH GROUP MANAGEMENT =====
        function addYouthGroup() {
            const groupData = getYouthGroupFormData();
            if (!validateYouthGroupData(groupData)) return;

            appData.youthGroups.push(groupData);
            
            // Auto-assign off-campus housing if needed
            if (groupData.stayingOffCampus) {
                autoAssignOffCampusHousing(groupData.id);
            }
            
            clearYouthGroupForm();
            updateAllDisplays();
            autoSave();
        }

        function updateYouthGroup() {
            if (editingGroupIndex < 0) return;
            
            const groupData = getYouthGroupFormData();
            if (!validateYouthGroupData(groupData)) return;

            const oldId = appData.youthGroups[editingGroupIndex].id;
            const wasOffCampus = appData.youthGroups[editingGroupIndex].stayingOffCampus;
            
            appData.youthGroups[editingGroupIndex] = groupData;
            
            if (oldId !== groupData.id) {
                updateAssignmentIds(oldId, groupData.id);
            }
            
            // Handle off-campus housing changes
            if (groupData.stayingOffCampus && !wasOffCampus) {
                // Just checked off-campus - auto-assign
                autoAssignOffCampusHousing(groupData.id);
            } else if (!groupData.stayingOffCampus && wasOffCampus) {
                // Just unchecked off-campus - remove assignments
                removeOffCampusHousing(groupData.id);
            } else if (groupData.stayingOffCampus) {
                // Still off-campus - update assignments in case numbers changed
                autoAssignOffCampusHousing(groupData.id);
            }
            
            cancelEdit();
            updateAllDisplays();
            autoSave();
        }

        function autoAssignOffCampusHousing(groupId) {
            const group = appData.youthGroups.find(g => g.id === groupId);
            if (!group) return;
            
            const maleTotal = group.maleTeens + group.maleChaperones;
            const femaleTotal = group.femaleTeens + group.femaleChaperones;
            
            // Assign to Off Campus-Male if they have males
            if (maleTotal > 0) {
                if (!appData.housingAssignments.male[groupId]) {
                    appData.housingAssignments.male[groupId] = [];
                }
                // Check if already assigned to off-campus
                const offCampusMaleRoom = 'Off Campus-Male';
                if (!appData.housingAssignments.male[groupId].includes(offCampusMaleRoom)) {
                    appData.housingAssignments.male[groupId] = [offCampusMaleRoom];
                }
            }
            
            // Assign to Off Campus-Female if they have females
            if (femaleTotal > 0) {
                if (!appData.housingAssignments.female[groupId]) {
                    appData.housingAssignments.female[groupId] = [];
                }
                // Check if already assigned to off-campus
                const offCampusFemaleRoom = 'Off Campus-Female';
                if (!appData.housingAssignments.female[groupId].includes(offCampusFemaleRoom)) {
                    appData.housingAssignments.female[groupId] = [offCampusFemaleRoom];
                }
            }
        }

        function removeOffCampusHousing(groupId) {
            // Remove from off-campus male housing
            if (appData.housingAssignments.male[groupId]) {
                appData.housingAssignments.male[groupId] = appData.housingAssignments.male[groupId].filter(
                    room => room !== 'Off Campus-Male'
                );
                if (appData.housingAssignments.male[groupId].length === 0) {
                    delete appData.housingAssignments.male[groupId];
                }
            }
            
            // Remove from off-campus female housing
            if (appData.housingAssignments.female[groupId]) {
                appData.housingAssignments.female[groupId] = appData.housingAssignments.female[groupId].filter(
                    room => room !== 'Off Campus-Female'
                );
                if (appData.housingAssignments.female[groupId].length === 0) {
                    delete appData.housingAssignments.female[groupId];
                }
            }
        }

        function editYouthGroup(index) {
            const group = appData.youthGroups[index];
            populateYouthGroupForm(group);
            editingGroupIndex = index;
            showEditButtons();
        }

        function deleteYouthGroup() {
            if (editingGroupIndex < 0) return;
            
            if (confirm('Are you sure you want to delete this youth group and all its assignments?')) {
                const groupId = appData.youthGroups[editingGroupIndex].id;
                
                delete appData.housingAssignments.male[groupId];
                delete appData.housingAssignments.female[groupId];
                delete appData.smallGroupAssignments[groupId];
                
                appData.youthGroups.splice(editingGroupIndex, 1);
                cancelEdit();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelEdit() {
            editingGroupIndex = -1;
            clearYouthGroupForm();
            hideEditButtons();
        }

        function getYouthGroupFormData() {
            return {
                id: document.getElementById('group-id').value.trim(),
                parish: document.getElementById('parish-name').value.trim(),
                leader: document.getElementById('group-leader').value.trim(),
                seminarianSgl: document.getElementById('seminarian-sgl').value.trim(),
                phone: document.getElementById('phone-number').value.trim(),
                maleTeens: parseInt(document.getElementById('male-teens').value) || 0,
                femaleTeens: parseInt(document.getElementById('female-teens').value) || 0,
                maleChaperones: parseInt(document.getElementById('male-chaperones').value) || 0,
                femaleChaperones: parseInt(document.getElementById('female-chaperones').value) || 0,
                stayingOffCampus: document.getElementById('staying-off-campus').checked,
                specialAccommodations: document.getElementById('special-accommodations').value.trim()
            };
        }

        function validateYouthGroupData(data) {
            if (!data.id || !data.parish) {
                alert('Please fill in Group ID and Parish Name (required fields)');
                return false;
            }
            
            const existingIndex = appData.youthGroups.findIndex(g => g.id === data.id);
            if (existingIndex !== -1 && existingIndex !== editingGroupIndex) {
                alert('A group with this ID already exists');
                return false;
            }
            
            return true;
        }

        function populateYouthGroupForm(group) {
            document.getElementById('group-id').value = group.id;
            document.getElementById('parish-name').value = group.parish;
            document.getElementById('group-leader').value = group.leader;
            document.getElementById('seminarian-sgl').value = group.seminarianSgl || '';
            document.getElementById('phone-number').value = group.phone;
            document.getElementById('male-teens').value = group.maleTeens;
            document.getElementById('female-teens').value = group.femaleTeens;
            document.getElementById('male-chaperones').value = group.maleChaperones;
            document.getElementById('female-chaperones').value = group.femaleChaperones;
            document.getElementById('staying-off-campus').checked = group.stayingOffCampus || false;
            document.getElementById('special-accommodations').value = group.specialAccommodations;
        }

        function clearYouthGroupForm() {
            document.getElementById('group-id').value = '';
            document.getElementById('parish-name').value = '';
            document.getElementById('group-leader').value = '';
            document.getElementById('seminarian-sgl').value = '';
            document.getElementById('phone-number').value = '';
            document.getElementById('male-teens').value = '0';
            document.getElementById('female-teens').value = '0';
            document.getElementById('male-chaperones').value = '0';
            document.getElementById('female-chaperones').value = '0';
            document.getElementById('staying-off-campus').checked = false;
            document.getElementById('special-accommodations').value = '';
        }

        function showEditButtons() {
            document.getElementById('update-group-btn').style.display = 'inline-block';
            document.getElementById('delete-group-btn').style.display = 'inline-block';
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
        }

        function hideEditButtons() {
            document.getElementById('update-group-btn').style.display = 'none';
            document.getElementById('delete-group-btn').style.display = 'none';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        function updateAssignmentIds(oldId, newId) {
            if (appData.housingAssignments.male[oldId]) {
                appData.housingAssignments.male[newId] = appData.housingAssignments.male[oldId];
                delete appData.housingAssignments.male[oldId];
            }
            if (appData.housingAssignments.female[oldId]) {
                appData.housingAssignments.female[newId] = appData.housingAssignments.female[oldId];
                delete appData.housingAssignments.female[oldId];
            }
            if (appData.smallGroupAssignments[oldId]) {
                appData.smallGroupAssignments[newId] = appData.smallGroupAssignments[oldId];
                delete appData.smallGroupAssignments[oldId];
            }
        }

        // ===== HOUSING ROOM MANAGEMENT =====
        function addHousingRoom() {
            const roomData = getHousingRoomFormData();
            if (!validateHousingRoomData(roomData)) return;

            appData.housingRooms.push(roomData);
            clearHousingRoomForm();
            updateAllDisplays();
            autoSave();
        }

        function updateHousingRoom() {
            if (editingHousingRoomIndex < 0) return;
            
            const roomData = getHousingRoomFormData();
            if (!validateHousingRoomData(roomData)) return;

            appData.housingRooms[editingHousingRoomIndex] = roomData;
            cancelRoomEdit();
            updateAllDisplays();
            autoSave();
        }

        function editHousingRoom(index) {
            const room = appData.housingRooms[index];
            populateHousingRoomForm(room);
            editingHousingRoomIndex = index;
            showRoomEditButtons();
        }

        function deleteHousingRoom() {
            if (editingHousingRoomIndex < 0) return;
            
            if (confirm('Are you sure you want to delete this housing room and all its assignments?')) {
                const room = appData.housingRooms[editingHousingRoomIndex];
                const roomKey = `${room.building}-${room.roomId}`;
                
                removeRoomFromHousingAssignments(roomKey);
                
                appData.housingRooms.splice(editingHousingRoomIndex, 1);
                cancelRoomEdit();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelRoomEdit() {
            editingHousingRoomIndex = -1;
            clearHousingRoomForm();
            hideRoomEditButtons();
        }

        function getHousingRoomFormData() {
            return {
                building: document.getElementById('building-name').value.trim(),
                roomId: document.getElementById('room-id').value.trim(),
                gender: document.getElementById('gender-designation').value,
                capacity: parseInt(document.getElementById('room-capacity').value) || 0,
                accessibility: document.getElementById('accessibility-features').value.trim()
            };
        }

        function validateHousingRoomData(data) {
            if (!data.building || !data.roomId || !data.gender || data.capacity < 1) {
                alert('Please fill in all required housing room fields');
                return false;
            }
            
            const roomKey = `${data.building}-${data.roomId}`;
            const existingIndex = appData.housingRooms.findIndex(r => `${r.building}-${r.roomId}` === roomKey);
            if (existingIndex !== -1 && existingIndex !== editingHousingRoomIndex) {
                alert('A housing room with this building and room ID already exists');
                return false;
            }
            
            return true;
        }

        function populateHousingRoomForm(room) {
            document.getElementById('building-name').value = room.building;
            document.getElementById('room-id').value = room.roomId;
            document.getElementById('gender-designation').value = room.gender;
            document.getElementById('room-capacity').value = room.capacity;
            document.getElementById('accessibility-features').value = room.accessibility;
        }

        function clearHousingRoomForm() {
            document.getElementById('building-name').value = '';
            document.getElementById('room-id').value = '';
            document.getElementById('gender-designation').value = '';
            document.getElementById('room-capacity').value = '';
            document.getElementById('accessibility-features').value = '';
        }

        function showRoomEditButtons() {
            document.getElementById('update-room-btn').style.display = 'inline-block';
            document.getElementById('delete-room-btn').style.display = 'inline-block';
            document.getElementById('cancel-room-edit-btn').style.display = 'inline-block';
        }

        function hideRoomEditButtons() {
            document.getElementById('update-room-btn').style.display = 'none';
            document.getElementById('delete-room-btn').style.display = 'none';
            document.getElementById('cancel-room-edit-btn').style.display = 'none';
        }

        function removeRoomFromHousingAssignments(roomKey) {
            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                if (Array.isArray(appData.housingAssignments.male[groupId])) {
                    appData.housingAssignments.male[groupId] = appData.housingAssignments.male[groupId].filter(key => key !== roomKey);
                    if (appData.housingAssignments.male[groupId].length === 0) {
                        delete appData.housingAssignments.male[groupId];
                    }
                }
            });
            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                if (Array.isArray(appData.housingAssignments.female[groupId])) {
                    appData.housingAssignments.female[groupId] = appData.housingAssignments.female[groupId].filter(key => key !== roomKey);
                    if (appData.housingAssignments.female[groupId].length === 0) {
                        delete appData.housingAssignments.female[groupId];
                    }
                }
            });
        }

        // ===== SMALL GROUP ROOM MANAGEMENT =====
        function addSmallGroupRoom() {
            const roomData = getSmallGroupRoomFormData();
            if (!validateSmallGroupRoomData(roomData)) return;

            appData.smallGroupRooms.push(roomData);
            clearSmallGroupRoomForm();
            updateAllDisplays();
            autoSave();
        }

        function updateSmallGroupRoom() {
            if (editingSmallGroupRoomIndex < 0) return;
            
            const roomData = getSmallGroupRoomFormData();
            if (!validateSmallGroupRoomData(roomData)) return;

            appData.smallGroupRooms[editingSmallGroupRoomIndex] = roomData;
            cancelSmallGroupRoomEdit();
            updateAllDisplays();
            autoSave();
        }

        function editSmallGroupRoom(index) {
            const room = appData.smallGroupRooms[index];
            populateSmallGroupRoomForm(room);
            editingSmallGroupRoomIndex = index;
            showSmallGroupRoomEditButtons();
        }

        function deleteSmallGroupRoom() {
            if (editingSmallGroupRoomIndex < 0) return;
            
            if (confirm('Are you sure you want to delete this small group room and all its assignments?')) {
                const room = appData.smallGroupRooms[editingSmallGroupRoomIndex];
                const roomKey = `${room.building}-${room.roomId}`;
                
                removeRoomFromSmallGroupAssignments(roomKey);
                
                appData.smallGroupRooms.splice(editingSmallGroupRoomIndex, 1);
                cancelSmallGroupRoomEdit();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelSmallGroupRoomEdit() {
            editingSmallGroupRoomIndex = -1;
            clearSmallGroupRoomForm();
            hideSmallGroupRoomEditButtons();
        }

        function getSmallGroupRoomFormData() {
            return {
                building: document.getElementById('sg-building-name').value.trim(),
                roomId: document.getElementById('sg-room-id').value.trim(),
                gender: document.getElementById('sg-gender-designation').value,
                capacity: parseInt(document.getElementById('sg-room-capacity').value) || 0,
                features: document.getElementById('sg-room-features').value.trim()
            };
        }

        function validateSmallGroupRoomData(data) {
            if (!data.building || !data.roomId || !data.gender || data.capacity < 1) {
                alert('Please fill in all required small group room fields');
                return false;
            }
            
            const roomKey = `${data.building}-${data.roomId}`;
            const existingIndex = appData.smallGroupRooms.findIndex(r => `${r.building}-${r.roomId}` === roomKey);
            if (existingIndex !== -1 && existingIndex !== editingSmallGroupRoomIndex) {
                alert('A small group room with this building and room ID already exists');
                return false;
            }
            
            return true;
        }

        function populateSmallGroupRoomForm(room) {
            document.getElementById('sg-building-name').value = room.building;
            document.getElementById('sg-room-id').value = room.roomId;
            document.getElementById('sg-gender-designation').value = room.gender;
            document.getElementById('sg-room-capacity').value = room.capacity;
            document.getElementById('sg-room-features').value = room.features;
        }

        function clearSmallGroupRoomForm() {
            document.getElementById('sg-building-name').value = '';
            document.getElementById('sg-room-id').value = '';
            document.getElementById('sg-gender-designation').value = '';
            document.getElementById('sg-room-capacity').value = '';
            document.getElementById('sg-room-features').value = '';
        }

        function showSmallGroupRoomEditButtons() {
            document.getElementById('update-sg-room-btn').style.display = 'inline-block';
            document.getElementById('delete-sg-room-btn').style.display = 'inline-block';
            document.getElementById('cancel-sg-room-edit-btn').style.display = 'inline-block';
        }

        function hideSmallGroupRoomEditButtons() {
            document.getElementById('update-sg-room-btn').style.display = 'none';
            document.getElementById('delete-sg-room-btn').style.display = 'none';
            document.getElementById('cancel-sg-room-edit-btn').style.display = 'none';
        }

        function removeRoomFromSmallGroupAssignments(roomKey) {
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                if (Array.isArray(appData.smallGroupAssignments[groupId])) {
                    appData.smallGroupAssignments[groupId] = appData.smallGroupAssignments[groupId].filter(key => key !== roomKey);
                    if (appData.smallGroupAssignments[groupId].length === 0) {
                        delete appData.smallGroupAssignments[groupId];
                    }
                }
            });
        }

        // ===== HOUSING ASSIGNMENT MANAGEMENT =====
        function updateHousingAssignmentDropdown() {
            document.getElementById('housing-assignment-search').value = '';
            const select = document.getElementById('housing-assignment-group-select');
            select.innerHTML = '<option value="">Select a Group-Gender Assignment</option>';
            
            appData.youthGroups.forEach(group => {
                const maleTotal = group.maleTeens + group.maleChaperones;
                const femaleTotal = group.femaleTeens + group.femaleChaperones;
                const isOffCampus = group.stayingOffCampus || false;
                
                if (maleTotal > 0) {
                    const option = document.createElement('option');
                    option.value = `${group.id}-male`;
                    option.textContent = `${group.id} - ${group.parish} - Males (${maleTotal} people)${isOffCampus ? ' 🏕️ OFF-CAMPUS' : ''}`;
                    select.appendChild(option);
                }
                
                if (femaleTotal > 0) {
                    const option = document.createElement('option');
                    option.value = `${group.id}-female`;
                    option.textContent = `${group.id} - ${group.parish} - Females (${femaleTotal} people)${isOffCampus ? ' 🏕️ OFF-CAMPUS' : ''}`;
                    select.appendChild(option);
                }
            });
        }

        function selectGroupForHousingAssignment() {
            const select = document.getElementById('housing-assignment-group-select');
            const value = select.value;
            
            if (!value) {
                selectedHousingAssignment = null;
                updateHousingAssignmentDisplay();
                return;
            }
            
            const [groupId, gender] = value.split('-');
            const group = appData.youthGroups.find(g => g.id === groupId);
            
            selectedHousingAssignment = {
                groupId: groupId,
                gender: gender,
                groupData: group
            };
            
            updateHousingAssignmentDisplay();
        }

        function updateHousingAssignmentDisplay() {
            updateSelectedHousingGroupInfo();
            updateAvailableHousingRoomsList();
            updateHousingAssignmentActions();
        }

        function updateSelectedHousingGroupInfo() {
            const infoDiv = document.getElementById('housing-selected-group-info');
            
            if (!selectedHousingAssignment) {
                infoDiv.innerHTML = '<p>Please select a group-gender assignment above to see room options.</p>';
                return;
            }
            
            const { groupId, gender, groupData } = selectedHousingAssignment;
            const peopleCount = gender === 'male' ? 
                (groupData.maleTeens + groupData.maleChaperones) : 
                (groupData.femaleTeens + groupData.femaleChaperones);
                
            const assignedRooms = appData.housingAssignments[gender][groupId] || [];
            const roomNames = assignedRooms.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            });
            
            const isOffCampus = groupData.stayingOffCampus || false;
            
            infoDiv.innerHTML = `
                <h4>${groupData.parish} (${groupId})</h4>
                <p><strong>Leader:</strong> ${groupData.leader}</p>
                <p><strong>Phone:</strong> ${groupData.phone}</p>
                <p><strong>${gender.charAt(0).toUpperCase() + gender.slice(1)} Total:</strong> ${peopleCount} people</p>
                ${gender === 'male' ? 
                    `<p>(${groupData.maleTeens} teens + ${groupData.maleChaperones} chaperones)</p>` :
                    `<p>(${groupData.femaleTeens} teens + ${groupData.femaleChaperones} chaperones)</p>`
                }
                ${groupData.specialAccommodations ? `<p><strong>Special Accommodations:</strong> ${groupData.specialAccommodations}</p>` : ''}
                
                ${isOffCampus ? `
                    <div class="notification" style="background: #fff3cd; border-left: 4px solid #e67e22; padding: 12px; margin: 10px 0; border-radius: 6px;">
                        <strong style="color: #856404;">🏕️ OFF-CAMPUS GROUP</strong>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #856404;">This group is staying off-campus and has been automatically assigned to off-campus housing.</p>
                    </div>
                ` : ''}
                
                ${assignedRooms.length > 0 ? `
                    <div class="${gender}-section">
                        <strong>Current Housing Assignments:</strong>
                        <p>${roomNames.join(', ')}</p>
                    </div>
                ` : `<p style="color: #e67e22;"><strong>⚠️ No ${gender} housing assignments yet.</strong></p>`}
            `;
        }

        function updateAvailableHousingRoomsList() {
            const roomsDiv = document.getElementById('housing-available-rooms-list');
            const searchBar = document.getElementById('housing-rooms-search');

            if (!selectedHousingAssignment) {
                roomsDiv.innerHTML = '<p>Select a group-gender assignment to see matching rooms.</p>';
                if (searchBar) searchBar.style.display = 'none';
                return;
            }

            // Show search bar
            if (searchBar) searchBar.style.display = 'block';

            const { gender, groupId } = selectedHousingAssignment;
            const group = appData.youthGroups.find(g => g.id === groupId);
            const groupSize = gender === 'male' ? (group.maleTeens + group.maleChaperones) : (group.femaleTeens + group.femaleChaperones);

            const matchingRooms = appData.housingRooms.filter(room => room.gender === gender);
            const assignedRooms = appData.housingAssignments[gender][groupId] || [];

            if (matchingRooms.length === 0) {
                roomsDiv.innerHTML = `<div class="notification error">⚠️ No ${gender} housing rooms available!</div>`;
                return;
            }

            // Sort rooms by recommendation (closest fit first)
            const roomsWithFit = matchingRooms.map(room => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getHousingRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const wastedSpace = availableSpace - groupSize;
                return { room, roomKey, occupiedCount, availableSpace, wastedSpace };
            });

            roomsWithFit.sort((a, b) => {
                // First sort by whether it fits (positive available space after assignment)
                const aFits = a.availableSpace >= groupSize;
                const bFits = b.availableSpace >= groupSize;
                if (aFits && !bFits) return -1;
                if (!aFits && bFits) return 1;

                // Then sort by least wasted space (but only for rooms that fit)
                if (aFits && bFits) {
                    return Math.abs(a.wastedSpace) - Math.abs(b.wastedSpace);
                }

                // For rooms that don't fit, sort by most available space
                return b.availableSpace - a.availableSpace;
            });

            let roomsHTML = '';
            roomsWithFit.forEach(({ room, roomKey, occupiedCount, availableSpace, wastedSpace }, index) => {
                const isAssigned = assignedRooms.includes(roomKey);

                // Determine color coding
                let backgroundColor = 'white';
                let borderColor = '#061d28';
                if (occupiedCount > 0) {
                    if (availableSpace === 0) {
                        backgroundColor = '#ffe5cc'; // Orange - completely full
                        borderColor = '#e67e22';
                    } else {
                        backgroundColor = '#fff9e6'; // Yellow - has people but still has space
                        borderColor = '#f39c12';
                    }
                }

                // Determine recommendation
                let recommendation = '';
                if (availableSpace >= groupSize) {
                    if (wastedSpace >= 0 && wastedSpace <= 5) {
                        recommendation = '<span style="background: #27ae60; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">✨ Perfect fit!</span>';
                    } else if (wastedSpace > 5 && wastedSpace <= 10) {
                        recommendation = '<span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">👍 Good match</span>';
                    } else if (index === 0) {
                        recommendation = '<span style="background: #9b59b6; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">⭐ Best available</span>';
                    }
                }

                roomsHTML += `
                    <div class="room-card ${isAssigned ? 'selected' : ''}"
                         data-room-search="${room.building.toLowerCase()} ${room.roomId.toLowerCase()} ${room.accessibility ? room.accessibility.toLowerCase() : ''}"
                         onclick="toggleHousingRoomSelection('${roomKey}')"
                         style="cursor: pointer; background: ${backgroundColor}; border-left-color: ${borderColor};">
                        <strong>${room.building} - ${room.roomId}</strong> ${recommendation}
                        <p><strong>Capacity:</strong> ${room.capacity} | <strong>Available:</strong> ${availableSpace} | <strong>Currently Occupied:</strong> ${occupiedCount}</p>
                        ${room.accessibility ? `<p>♿ ${room.accessibility}</p>` : ''}
                        ${getHousingRoomAssignedGroupsDisplay(roomKey)}
                    </div>
                `;
            });
            
            roomsDiv.innerHTML = roomsHTML;
        }

        function toggleHousingRoomSelection(roomKey) {
            if (!selectedHousingAssignment) return;
            
            const { groupId, gender } = selectedHousingAssignment;
            
            if (!appData.housingAssignments[gender][groupId]) {
                appData.housingAssignments[gender][groupId] = [];
            }
            
            const assignedRooms = appData.housingAssignments[gender][groupId];
            const index = assignedRooms.indexOf(roomKey);
            
            if (index > -1) {
                assignedRooms.splice(index, 1);
                if (assignedRooms.length === 0) {
                    delete appData.housingAssignments[gender][groupId];
                }
            } else {
                assignedRooms.push(roomKey);
            }
            
            updateHousingAssignmentDisplay();
        }

        function updateHousingAssignmentActions() {
            const actionsDiv = document.getElementById('housing-assignment-actions');
            if (selectedHousingAssignment) {
                actionsDiv.style.display = 'block';
            } else {
                actionsDiv.style.display = 'none';
            }
        }

        function confirmHousingAssignment() {
            if (!selectedHousingAssignment) return;
            
            alert(`Housing assignment updated for ${selectedHousingAssignment.groupData.parish} (${selectedHousingAssignment.gender})`);
            updateAllDisplays();
            autoSave();
        }

        function clearHousingAssignment() {
            if (!selectedHousingAssignment) return;
            
            const { groupId, gender, groupData } = selectedHousingAssignment;
            
            if (confirm(`Clear all ${gender} housing assignments for ${groupData.parish}?`)) {
                delete appData.housingAssignments[gender][groupId];
                updateHousingAssignmentDisplay();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelHousingSelection() {
            selectedHousingAssignment = null;
            document.getElementById('housing-assignment-group-select').value = '';
            updateHousingAssignmentDisplay();
        }

        function filterHousingAssignmentDropdown() {
            const searchTerm = document.getElementById('housing-assignment-search').value.toLowerCase();
            const select = document.getElementById('housing-assignment-group-select');
            
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            appData.youthGroups.forEach(group => {
                const matchesSearch = !searchTerm || 
                    group.parish.toLowerCase().includes(searchTerm) ||
                    group.id.toLowerCase().includes(searchTerm) ||
                    group.leader.toLowerCase().includes(searchTerm);
                
                if (matchesSearch) {
                    const maleTotal = group.maleTeens + group.maleChaperones;
                    const femaleTotal = group.femaleTeens + group.femaleChaperones;
                    const isOffCampus = group.stayingOffCampus || false;
                    
                    if (maleTotal > 0) {
                        const option = document.createElement('option');
                        option.value = `${group.id}-male`;
                        option.textContent = `${group.id} - ${group.parish} - Males (${maleTotal} people)${isOffCampus ? ' 🏕️ OFF-CAMPUS' : ''}`;
                        select.appendChild(option);
                    }
                    
                    if (femaleTotal > 0) {
                        const option = document.createElement('option');
                        option.value = `${group.id}-female`;
                        option.textContent = `${group.id} - ${group.parish} - Females (${femaleTotal} people)${isOffCampus ? ' 🏕️ OFF-CAMPUS' : ''}`;
                        select.appendChild(option);
                    }
                }
            });
        }

        // ===== SMALL GROUP ASSIGNMENT MANAGEMENT =====
        function updateSmallGroupAssignmentDropdown() {
            document.getElementById('sg-assignment-search').value = '';
            const select = document.getElementById('sg-assignment-group-select');
            select.innerHTML = '<option value="">Select a Group for Small Group Assignment</option>';
            
            appData.youthGroups.forEach(group => {
                const totalGroup = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                
                if (totalGroup > 0) {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = `${group.id} - ${group.parish} (${totalGroup} people total)`;
                    select.appendChild(option);
                }
            });
        }

        function selectGroupForSmallGroupAssignment() {
            const select = document.getElementById('sg-assignment-group-select');
            const groupId = select.value;
            
            if (!groupId) {
                selectedSmallGroupAssignment = null;
                updateSmallGroupAssignmentDisplay();
                return;
            }
            
            const group = appData.youthGroups.find(g => g.id === groupId);
            
            selectedSmallGroupAssignment = {
                groupId: groupId,
                groupData: group
            };
            
            updateSmallGroupAssignmentDisplay();
        }

        function updateSmallGroupAssignmentDisplay() {
            updateSelectedSmallGroupInfo();
            updateAvailableSmallGroupRoomsList();
            updateSmallGroupAssignmentActions();
        }

        function updateSelectedSmallGroupInfo() {
            const infoDiv = document.getElementById('sg-selected-group-info');
            
            if (!selectedSmallGroupAssignment) {
                infoDiv.innerHTML = '<p>Please select a group above to see small group location options.</p>';
                return;
            }
            
            const { groupId, groupData } = selectedSmallGroupAssignment;
            const maleTotal = groupData.maleTeens + groupData.maleChaperones;
            const femaleTotal = groupData.femaleTeens + groupData.femaleChaperones;
            const totalPeople = maleTotal + femaleTotal;
                
            const assignedRooms = appData.smallGroupAssignments[groupId] || [];
            const roomNames = assignedRooms.map(roomKey => {
                const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building} - ${room.roomId}` : roomKey;
            });
            
            infoDiv.innerHTML = `
                <h4>${groupData.parish} (${groupId})</h4>
                <p><strong>Leader:</strong> ${groupData.leader}</p>
                <p><strong>Phone:</strong> ${groupData.phone}</p>
                <p><strong>Total Group:</strong> ${totalPeople} people</p>
                <p>(${maleTotal} males + ${femaleTotal} females)</p>
                ${groupData.specialAccommodations ? `<p><strong>Special Accommodations:</strong> ${groupData.specialAccommodations}</p>` : ''}
                
                ${assignedRooms.length > 0 ? `
                    <div class="male-section">
                        <strong>Current Small Group Location:</strong>
                        <p>${roomNames.join(', ')}</p>
                    </div>
                ` : `<p style="color: #e67e22;"><strong>⚠️ No small group location assigned yet.</strong></p>`}
            `;
        }

        function updateAvailableSmallGroupRoomsList() {
            const roomsDiv = document.getElementById('sg-available-rooms-list');
            const searchBar = document.getElementById('sg-rooms-search');

            if (!selectedSmallGroupAssignment) {
                roomsDiv.innerHTML = '<p>Select a group to see available small group locations.</p>';
                if (searchBar) searchBar.style.display = 'none';
                return;
            }

            // Show search bar
            if (searchBar) searchBar.style.display = 'block';

            const { groupId } = selectedSmallGroupAssignment;
            const group = appData.youthGroups.find(g => g.id === groupId);
            const groupSize = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;

            const assignedRooms = appData.smallGroupAssignments[groupId] || [];

            if (appData.smallGroupRooms.length === 0) {
                roomsDiv.innerHTML = `<div class="notification error">⚠️ No small group rooms available!</div>`;
                return;
            }

            // Sort rooms by recommendation (closest fit first)
            const roomsWithFit = appData.smallGroupRooms.map(room => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getSmallGroupRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const wastedSpace = availableSpace - groupSize;
                return { room, roomKey, occupiedCount, availableSpace, wastedSpace };
            });

            roomsWithFit.sort((a, b) => {
                // First sort by whether it fits
                const aFits = a.availableSpace >= groupSize;
                const bFits = b.availableSpace >= groupSize;
                if (aFits && !bFits) return -1;
                if (!aFits && bFits) return 1;

                // Then sort by least wasted space
                if (aFits && bFits) {
                    return Math.abs(a.wastedSpace) - Math.abs(b.wastedSpace);
                }

                // For rooms that don't fit, sort by most available space
                return b.availableSpace - a.availableSpace;
            });

            let roomsHTML = '';
            roomsWithFit.forEach(({ room, roomKey, occupiedCount, availableSpace, wastedSpace }, index) => {
                const isAssigned = assignedRooms.includes(roomKey);

                // Determine color coding - Light blue if has people
                let backgroundColor = 'white';
                let borderColor = '#061d28';
                if (occupiedCount > 0) {
                    backgroundColor = '#e8f4f8'; // Light blue - has people assigned
                    borderColor = '#3498db';
                }

                // Determine recommendation
                let recommendation = '';
                if (availableSpace >= groupSize) {
                    if (wastedSpace >= 0 && wastedSpace <= 5) {
                        recommendation = '<span style="background: #27ae60; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">✨ Perfect fit!</span>';
                    } else if (wastedSpace > 5 && wastedSpace <= 10) {
                        recommendation = '<span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">👍 Good match</span>';
                    } else if (index === 0) {
                        recommendation = '<span style="background: #9b59b6; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px;">⭐ Best available</span>';
                    }
                }

                roomsHTML += `
                    <div class="room-card ${isAssigned ? 'selected' : ''}"
                         data-room-search="${room.building.toLowerCase()} ${room.roomId.toLowerCase()} ${room.features ? room.features.toLowerCase() : ''} ${room.gender}"
                         onclick="toggleSmallGroupRoomSelection('${roomKey}')"
                         style="cursor: pointer; background: ${backgroundColor}; border-left-color: ${borderColor};">
                        <strong>${room.building} - ${room.roomId}</strong> ${recommendation}
                        <p><strong>Type:</strong> ${room.gender === 'mixed' ? 'Co-ed/Mixed' : room.gender.charAt(0).toUpperCase() + room.gender.slice(1)} | <strong>Capacity:</strong> ${room.capacity} | <strong>Available:</strong> ${availableSpace} | <strong>Currently Occupied:</strong> ${occupiedCount}</p>
                        ${room.features ? `<p>🏗️ ${room.features}</p>` : ''}
                        ${getSmallGroupRoomAssignedGroupsDisplay(roomKey)}
                    </div>
                `;
            });

            roomsDiv.innerHTML = roomsHTML;
        }

        function toggleSmallGroupRoomSelection(roomKey) {
            if (!selectedSmallGroupAssignment) return;
            
            const { groupId } = selectedSmallGroupAssignment;
            
            if (!appData.smallGroupAssignments[groupId]) {
                appData.smallGroupAssignments[groupId] = [];
            }
            
            const assignedRooms = appData.smallGroupAssignments[groupId];
            const index = assignedRooms.indexOf(roomKey);
            
            if (index > -1) {
                assignedRooms.splice(index, 1);
                if (assignedRooms.length === 0) {
                    delete appData.smallGroupAssignments[groupId];
                }
            } else {
                assignedRooms.push(roomKey);
            }
            
            updateSmallGroupAssignmentDisplay();
        }

        function updateSmallGroupAssignmentActions() {
            const actionsDiv = document.getElementById('sg-assignment-actions');
            if (selectedSmallGroupAssignment) {
                actionsDiv.style.display = 'block';
            } else {
                actionsDiv.style.display = 'none';
            }
        }

        function confirmSmallGroupAssignment() {
            if (!selectedSmallGroupAssignment) return;
            
            alert(`Small group assignment updated for ${selectedSmallGroupAssignment.groupData.parish}`);
            updateAllDisplays();
            autoSave();
        }

        function clearSmallGroupAssignment() {
            if (!selectedSmallGroupAssignment) return;
            
            const { groupId, groupData } = selectedSmallGroupAssignment;
            
            if (confirm(`Clear all small group location assignments for ${groupData.parish}?`)) {
                delete appData.smallGroupAssignments[groupId];
                updateSmallGroupAssignmentDisplay();
                updateAllDisplays();
                autoSave();
            }
        }

        function cancelSmallGroupSelection() {
            selectedSmallGroupAssignment = null;
            document.getElementById('sg-assignment-group-select').value = '';
            updateSmallGroupAssignmentDisplay();
        }

        function filterSmallGroupAssignmentDropdown() {
            const searchTerm = document.getElementById('sg-assignment-search').value.toLowerCase();
            const select = document.getElementById('sg-assignment-group-select');
            
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            appData.youthGroups.forEach(group => {
                const matchesSearch = !searchTerm || 
                    group.parish.toLowerCase().includes(searchTerm) ||
                    group.id.toLowerCase().includes(searchTerm) ||
                    group.leader.toLowerCase().includes(searchTerm);
                
                if (matchesSearch) {
                    const totalGroup = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                    
                    if (totalGroup > 0) {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = `${group.id} - ${group.parish} (${totalGroup} people total)`;
                        select.appendChild(option);
                    }
                }
            });
        }

        // ===== MEAL COLOR ASSIGNMENT MANAGEMENT =====
        function updateMealColorAssignment(groupId, color) {
            if (color === '') {
                delete appData.mealColorAssignments[groupId];
            } else {
                appData.mealColorAssignments[groupId] = color;
            }
            updateMealColorSummary();
            updateDashboard();
            autoSave();
        }

        function updateMealColorsTable() {
            const tbody = document.getElementById('meal-colors-table');
            tbody.innerHTML = '';

            const sortedGroups = getSortedMealColorGroups();
            
            sortedGroups.forEach(group => {
                const total = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                const assignedColor = appData.mealColorAssignments[group.id] || '';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="section-id">${group.id}</span></td>
                    <td>${group.parish}</td>
                    <td>${group.leader}</td>
                    <td><strong>${total}</strong></td>
                    <td>
                        <select onchange="updateMealColorAssignment('${group.id}', this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #bdc3c7;">
                            <option value="">Select Color</option>
                            ${MEAL_COLORS.map(color => 
                                `<option value="${color}" ${assignedColor === color ? 'selected' : ''}>${color}</option>`
                            ).join('')}
                        </select>
                        ${assignedColor ? `<span style="margin-left: 10px; padding: 2px 8px; border-radius: 4px; background: ${getColorForMealAssignment(assignedColor)}; color: white; font-size: 12px;">${assignedColor}</span>` : ''}
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="clearMealColor('${group.id}')" style="font-size: 12px; padding: 4px 8px;">Clear</button>
                    </td>
                `;
            });
        }

        function updateMealColorSummary() {
            // Initialize counts
            const colorCounts = {};
            MEAL_COLORS.forEach(color => {
                colorCounts[color] = 0;
            });
            
            // Count people per color
            Object.keys(appData.mealColorAssignments).forEach(groupId => {
                const color = appData.mealColorAssignments[groupId];
                const group = appData.youthGroups.find(g => g.id === groupId);
                if (group && color) {
                    const totalPeople = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                    colorCounts[color] += totalPeople;
                }
            });
            
            // Update display
            MEAL_COLORS.forEach(color => {
                const element = document.getElementById(`${color.toLowerCase()}-meal-count`);
                if (element) {
                    element.textContent = colorCounts[color];
                }
            });
        }

        function getColorForMealAssignment(colorName) {
            const colorMap = {
                'Blue': '#3498db',
                'Red': '#e74c3c',
                'Orange': '#e67e22',
                'Yellow': '#f1c40f',
                'Green': '#27ae60',
                'Purple': '#9b59b6',
                'Brown': '#8b4513',
                'Grey': '#95a5a6'
            };
            return colorMap[colorName] || '#bdc3c7';
        }

        function clearMealColor(groupId) {
            if (confirm('Clear meal color assignment for this group?')) {
                delete appData.mealColorAssignments[groupId];
                updateMealColorsTable();
                updateMealColorSummary();
                updateDashboard();
                autoSave();
            }
        }

        function confirmMealColorAssignments() {
            alert('Meal color assignments updated successfully!');
            updateAllDisplays();
            autoSave();
        }
        function getHousingRoomOccupancy(roomKey) {
            let total = 0;
            
            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const assignments = appData.housingAssignments.male[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.maleTeens + group.maleChaperones;
                    }
                }
            });
            
            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const assignments = appData.housingAssignments.female[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.femaleTeens + group.femaleChaperones;
                    }
                }
            });
            
            return total;
        }

        function getSmallGroupRoomOccupancy(roomKey) {
            let total = 0;
            
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const assignments = appData.smallGroupAssignments[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                    }
                }
            });
            
            return total;
        }

        function getHousingRoomAssignedGroupsDisplay(roomKey) {
            const assignedGroups = [];
            
            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const assignments = appData.housingAssignments.male[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(`${groupId}(M)`);
                }
            });
            
            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const assignments = appData.housingAssignments.female[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(`${groupId}(F)`);
                }
            });
            
            return assignedGroups.length > 0 ? 
                `<p><strong>Assigned:</strong> ${assignedGroups.join(', ')}</p>` : '';
        }

        function getSmallGroupRoomAssignedGroupsDisplay(roomKey) {
            const assignedGroups = [];
            
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const assignments = appData.smallGroupAssignments[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(groupId);
                }
            });
            
            return assignedGroups.length > 0 ? 
                `<p><strong>Assigned:</strong> ${assignedGroups.join(', ')}</p>` : '';
        }

        function isGroupHousingAssigned(groupId) {
            const group = appData.youthGroups.find(g => g.id === groupId);
            if (group && group.stayingOffCampus) {
                return true; // Off-campus groups are considered "assigned"
            }
            const maleAssignments = appData.housingAssignments.male[groupId];
            const femaleAssignments = appData.housingAssignments.female[groupId];
            return (Array.isArray(maleAssignments) && maleAssignments.length > 0) ||
                   (Array.isArray(femaleAssignments) && femaleAssignments.length > 0);
        }

        function isGroupSmallGroupAssigned(groupId) {
            const assignments = appData.smallGroupAssignments[groupId];
            return Array.isArray(assignments) && assignments.length > 0;
        }

        // ===== DISPLAY UPDATE FUNCTIONS =====
        function updateAllDisplays() {
            updateYouthGroupsTable();
            updateHousingRoomsTable();
            updateSmallGroupRoomsTable();
            updateMealColorsTable();
            updateMealColorSummary();
            updateMealTimesConfig();
            updateDashboard();
            updateAssignmentOverview();
            
            // Update forms preview if we're on that tab
            const formsTab = document.getElementById('printable-forms');
            if (formsTab && formsTab.classList.contains('active')) {
                updateFormsPreview();
            }
        }

        function updateYouthGroupsTable() {
            const tbody = document.getElementById('youth-groups-table');
            tbody.innerHTML = '';

            const sortedGroups = getSortedYouthGroups();
            
            sortedGroups.forEach((group, sortedIndex) => {
                const originalIndex = appData.youthGroups.indexOf(group);
                const total = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                const isAssigned = isGroupHousingAssigned(group.id);
                const isOffCampus = group.stayingOffCampus || false;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="section-id">${group.id}</span>${isOffCampus ? ' <span style="background: #e67e22; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">🏕️ OFF</span>' : ''}</td>
                    <td>${group.parish}</td>
                    <td>${group.leader}</td>
                    <td>${group.seminarianSgl || 'Not Assigned'}</td>
                    <td>${group.phone}</td>
                    <td>${group.maleTeens}</td>
                    <td>${group.femaleTeens}</td>
                    <td>${group.maleChaperones}</td>
                    <td>${group.femaleChaperones}</td>
                    <td><strong>${total}</strong></td>
                    <td style="font-size: 12px; max-width: 150px; word-wrap: break-word;">${group.specialAccommodations || 'None'}</td>
                    <td><span class="assignment-status ${isAssigned || isOffCampus ? 'status-assigned' : 'status-unassigned'}">${isAssigned || isOffCampus ? '✅ Assigned' : '❌ Unassigned'}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="editYouthGroup(${originalIndex})" style="font-size: 12px; padding: 6px 12px;">Edit</button>
                    </td>
                `;
            });
        }

        function updateHousingRoomsTable() {
            const tbody = document.getElementById('housing-rooms-table');
            tbody.innerHTML = '';

            const sortedRooms = getSortedHousingRooms();

            sortedRooms.forEach((room, sortedIndex) => {
                const originalIndex = appData.housingRooms.indexOf(room);
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getHousingRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const assignedGroups = getHousingRoomAssignedGroupsDisplay(roomKey);
                
                const row = tbody.insertRow();
                const sectionId = `${room.building.substring(0, 3).toUpperCase()}-${room.roomId}`;
                
                row.innerHTML = `
                    <td><span class="section-id">${sectionId}</span></td>
                    <td>${room.building}</td>
                    <td>${room.roomId}</td>
                    <td>${room.gender.charAt(0).toUpperCase() + room.gender.slice(1)}</td>
                    <td>${room.capacity}</td>
                    <td>${occupiedCount}</td>
                    <td class="capacity-display ${availableSpace < 0 ? 'capacity-negative' : availableSpace === 0 ? 'capacity-zero' : 'capacity-positive'}">${availableSpace}</td>
                    <td>${room.accessibility ? '♿' : '✅'}</td>
                    <td style="font-size: 12px;">${assignedGroups.replace(/<[^>]*>/g, '').replace('Assigned: ', '') || 'None'}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editHousingRoom(${originalIndex})" style="font-size: 12px; padding: 6px 12px;">Edit</button>
                    </td>
                `;
            });
        }

        function updateSmallGroupRoomsTable() {
            const tbody = document.getElementById('small-group-rooms-table');
            tbody.innerHTML = '';

            const sortedRooms = getSortedSmallGroupRooms();

            sortedRooms.forEach((room, sortedIndex) => {
                const originalIndex = appData.smallGroupRooms.indexOf(room);
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getSmallGroupRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const assignedGroups = getSmallGroupRoomAssignedGroupsDisplay(roomKey);
                
                const row = tbody.insertRow();
                const locationId = `${room.building.substring(0, 3).toUpperCase()}-${room.roomId}`;
                
                row.innerHTML = `
                    <td><span class="section-id">${locationId}</span></td>
                    <td>${room.building}</td>
                    <td>${room.roomId}</td>
                    <td>${room.gender === 'mixed' ? 'Mixed/Co-ed' : room.gender.charAt(0).toUpperCase() + room.gender.slice(1)}</td>
                    <td>${room.capacity}</td>
                    <td>${occupiedCount}</td>
                    <td class="capacity-display ${availableSpace < 0 ? 'capacity-negative' : availableSpace === 0 ? 'capacity-zero' : 'capacity-positive'}">${availableSpace}</td>
                    <td>${room.features ? '🏗️' : '✅'}</td>
                    <td style="font-size: 12px;">${assignedGroups.replace(/<[^>]*>/g, '').replace('Assigned: ', '') || 'None'}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editSmallGroupRoom(${originalIndex})" style="font-size: 12px; padding: 6px 12px;">Edit</button>
                    </td>
                `;
            });
        }

        function updateDashboard() {
            // Basic counts
            const totalGroups = appData.youthGroups.length;
            const totalParticipants = appData.youthGroups.reduce((total, group) => 
                total + group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones, 0);
            
            // Off-campus people count (total people in off-campus groups)
            const offCampusPeople = appData.youthGroups
                .filter(g => g.stayingOffCampus)
                .reduce((total, group) => 
                    total + group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones, 0);
            
            // Housing analysis (only for on-campus groups)
            const groupsNeedingHousing = appData.youthGroups.filter(g => !g.stayingOffCampus && !isGroupHousingAssigned(g.id)).length;
            const groupsNeedingSmallGroup = appData.youthGroups.filter(g => !isGroupSmallGroupAssigned(g.id)).length;
            const groupsNeedingMealColor = appData.youthGroups.filter(g => !appData.mealColorAssignments[g.id]).length;
            
            // Male housing capacity analysis (excluding Off Campus)
            const maleHousingRooms = appData.housingRooms.filter(room => room.gender === 'male' && room.building !== 'Off Campus');
            const totalMaleHousingCapacity = maleHousingRooms.reduce((total, room) => total + room.capacity, 0);
            const usedMaleHousingCapacity = maleHousingRooms.reduce((total, room) => {
                return total + getHousingRoomOccupancy(`${room.building}-${room.roomId}`);
            }, 0);
            const maleHousingUtilization = totalMaleHousingCapacity > 0 ? Math.round((usedMaleHousingCapacity / totalMaleHousingCapacity) * 100) : 0;
            
            // Female housing capacity analysis (excluding Off Campus)
            const femaleHousingRooms = appData.housingRooms.filter(room => room.gender === 'female' && room.building !== 'Off Campus');
            const totalFemaleHousingCapacity = femaleHousingRooms.reduce((total, room) => total + room.capacity, 0);
            const usedFemaleHousingCapacity = femaleHousingRooms.reduce((total, room) => {
                return total + getHousingRoomOccupancy(`${room.building}-${room.roomId}`);
            }, 0);
            const femaleHousingUtilization = totalFemaleHousingCapacity > 0 ? Math.round((usedFemaleHousingCapacity / totalFemaleHousingCapacity) * 100) : 0;
            
            // Mixed/Co-ed small group room capacity analysis
            const mixedSmallGroupRooms = appData.smallGroupRooms.filter(room => room.gender === 'mixed');
            const totalMixedSGCapacity = mixedSmallGroupRooms.reduce((total, room) => total + room.capacity, 0);
            const usedMixedSGCapacity = mixedSmallGroupRooms.reduce((total, room) => {
                return total + getSmallGroupRoomOccupancy(`${room.building}-${room.roomId}`);
            }, 0);
            const mixedSGUtilization = totalMixedSGCapacity > 0 ? Math.round((usedMixedSGCapacity / totalMixedSGCapacity) * 100) : 0;
            
            // Available rooms analysis
            const availableHousingRooms = appData.housingRooms.filter(room => {
                const occupancy = getHousingRoomOccupancy(`${room.building}-${room.roomId}`);
                return occupancy < room.capacity;
            }).length;
            
            const availableSmallGroupRooms = appData.smallGroupRooms.filter(room => {
                const occupancy = getSmallGroupRoomOccupancy(`${room.building}-${room.roomId}`);
                return occupancy < room.capacity;
            }).length;
            
            // Update the display
            document.getElementById('total-groups').textContent = totalGroups;
            document.getElementById('total-participants').textContent = totalParticipants;
            document.getElementById('off-campus-groups').textContent = offCampusPeople;
            document.getElementById('groups-needing-housing').textContent = groupsNeedingHousing;
            document.getElementById('groups-needing-small-group').textContent = groupsNeedingSmallGroup;
            document.getElementById('groups-needing-meal-color').textContent = groupsNeedingMealColor;
            
            // Male housing stats
            document.getElementById('male-housing-capacity').textContent = totalMaleHousingCapacity;
            document.getElementById('male-housing-used').textContent = usedMaleHousingCapacity;
            document.getElementById('male-housing-utilization').textContent = maleHousingUtilization + '%';
            
            // Female housing stats
            document.getElementById('female-housing-capacity').textContent = totalFemaleHousingCapacity;
            document.getElementById('female-housing-used').textContent = usedFemaleHousingCapacity;
            document.getElementById('female-housing-utilization').textContent = femaleHousingUtilization + '%';
            
            // Mixed small group stats
            document.getElementById('mixed-sg-capacity').textContent = totalMixedSGCapacity;
            document.getElementById('mixed-sg-used').textContent = usedMixedSGCapacity;
            document.getElementById('mixed-sg-utilization').textContent = mixedSGUtilization + '%';
            
            // General stats
            document.getElementById('available-housing-rooms').textContent = availableHousingRooms;
            document.getElementById('available-small-group-rooms').textContent = availableSmallGroupRooms;
        }

        function updateAssignmentOverview() {
            const overviewDiv = document.getElementById('assignment-overview');
            
            if (appData.youthGroups.length === 0) {
                overviewDiv.innerHTML = '<p>No youth groups added yet.</p>';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px;">';
            
            appData.youthGroups.forEach(group => {
                const isHousingAssigned = isGroupHousingAssigned(group.id);
                const isSmallGroupAssigned = isGroupSmallGroupAssigned(group.id);
                const mealColor = appData.mealColorAssignments[group.id] || '';
                const maleTotal = group.maleTeens + group.maleChaperones;
                const femaleTotal = group.femaleTeens + group.femaleChaperones;
                const totalGroup = maleTotal + femaleTotal;
                
                // Check if off-campus
                const isOffCampus = group.stayingOffCampus || false;
                
                // Get housing assignments
                const maleHousingRooms = appData.housingAssignments.male[group.id] || [];
                const femaleHousingRooms = appData.housingAssignments.female[group.id] || [];
                
                const maleHousingRoomNames = maleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                const femaleHousingRoomNames = femaleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                // Get small group assignments
                const groupSmallGroupRooms = appData.smallGroupAssignments[group.id] || [];
                
                const groupSmallGroupRoomNames = groupSmallGroupRooms.map(roomKey => {
                    const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                const overallAssigned = isHousingAssigned || isSmallGroupAssigned;
                
                html += `
                    <div class="room-card" style="border-left-color: ${overallAssigned ? '#27ae60' : '#e74c3c'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${group.parish}</strong>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                ${isOffCampus ? '<span class="assignment-status" style="background: #e67e22; color: white; font-size: 10px;">🏕️ OFF-CAMPUS</span>' : ''}
                                <span class="assignment-status ${isHousingAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                    🏠 ${isHousingAssigned ? '✅' : '❌'}
                                </span>
                                <span class="assignment-status ${isSmallGroupAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                    👥 ${isSmallGroupAssigned ? '✅' : '❌'}
                                </span>
                                ${mealColor ? `<span style="padding: 2px 6px; border-radius: 4px; background: ${getColorForMealAssignment(mealColor)}; color: white; font-size: 10px; font-weight: bold;">🍽️ ${mealColor}</span>` : '<span style="font-size: 10px; color: #e67e22;">🍽️ No Color</span>'}
                            </div>
                        </div>
                        <p><span class="section-id">${group.id}</span> | ${totalGroup} people total</p>
                        ${group.seminarianSgl ? `<p style="font-size: 12px; color: #2c3e50;"><strong>Seminarian SGL:</strong> ${group.seminarianSgl}</p>` : ''}
                        
                        <!-- Housing Assignments -->
                        ${isOffCampus ? `
                            <div style="background: #fff3cd; padding: 8px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #e67e22;">
                                <strong style="font-size: 14px;">🏕️ OFF-CAMPUS HOUSING</strong>
                                <p style="font-size: 12px; margin-top: 4px;">This group is staying off-campus</p>
                            </div>
                        ` : `
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin: 8px 0;">
                                <strong style="font-size: 14px;">🏠 Housing Assignments</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px;">
                                    ${maleTotal > 0 ? `
                                        <div class="male-section" style="padding: 6px;">
                                            <strong style="font-size: 12px;">🔵 Males: ${maleTotal}</strong>
                                            ${maleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0;">${maleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0;">Not assigned</p>'}
                                        </div>
                                    ` : '<div></div>'}
                                    
                                    ${femaleTotal > 0 ? `
                                        <div class="female-section" style="padding: 6px;">
                                            <strong style="font-size: 12px;">🟣 Females: ${femaleTotal}</strong>
                                            ${femaleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0;">${femaleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0;">Not assigned</p>'}
                                        </div>
                                    ` : '<div></div>'}
                                </div>
                            </div>
                        `}
                        
                        <!-- Small Group Assignments -->
                        <div style="background: #f0f8ff; padding: 8px; border-radius: 6px; margin: 8px 0;">
                            <strong style="font-size: 14px;">👥 Small Group Location</strong>
                            ${groupSmallGroupRoomNames.length > 0 ? `
                                <div style="background: linear-gradient(45deg, #e8f4f8, #fdf2f2); padding: 6px; border-radius: 4px; margin-top: 5px;">
                                    <strong style="font-size: 12px;">🟡 Group Location:</strong>
                                    <p style="font-size: 10px; margin: 2px 0 0 0;">${groupSmallGroupRoomNames.join(', ')}</p>
                                </div>
                            ` : `<div style="background: #fff3cd; padding: 4px; border-radius: 4px; margin-top: 5px; text-align: center;">
                                <p style="font-size: 10px; color: #856404; margin: 0;">No small group location assigned</p>
                            </div>`}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            overviewDiv.innerHTML = html;
        }

        // ===== SEARCH FUNCTIONALITY =====
        function performSearch() {
            const searchTerm = document.getElementById('parish-search').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            
            if (!searchTerm.trim()) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const matchingGroups = appData.youthGroups.filter(group => 
                group.parish.toLowerCase().includes(searchTerm) ||
                group.id.toLowerCase().includes(searchTerm) ||
                group.leader.toLowerCase().includes(searchTerm) ||
                (group.seminarianSgl && group.seminarianSgl.toLowerCase().includes(searchTerm)) ||
                group.phone.toLowerCase().includes(searchTerm)
            );
            
            if (matchingGroups.length === 0) {
                resultsDiv.innerHTML = '<div class="notification warning">No groups found matching your search.</div>';
                return;
            }
            
            let html = '<h3>Search Results</h3><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px;">';
            
            matchingGroups.forEach(group => {
                const isHousingAssigned = isGroupHousingAssigned(group.id);
                const isSmallGroupAssigned = isGroupSmallGroupAssigned(group.id);
                const mealColor = appData.mealColorAssignments[group.id] || '';
                const maleTotal = group.maleTeens + group.maleChaperones;
                const femaleTotal = group.femaleTeens + group.femaleChaperones;
                const totalGroup = maleTotal + femaleTotal;
                
                // Check if off-campus
                const isOffCampus = group.stayingOffCampus || false;
                
                // Get housing assignments
                const maleHousingRooms = appData.housingAssignments.male[group.id] || [];
                const femaleHousingRooms = appData.housingAssignments.female[group.id] || [];
                
                const maleHousingRoomNames = maleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                const femaleHousingRoomNames = femaleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                // Get small group assignments
                const groupSmallGroupRooms = appData.smallGroupAssignments[group.id] || [];
                
                const groupSmallGroupRoomNames = groupSmallGroupRooms.map(roomKey => {
                    const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building}-${room.roomId}` : roomKey;
                });
                
                const overallAssigned = isHousingAssigned || isSmallGroupAssigned;
                
                html += `
                    <div class="room-card" style="border-left-color: ${overallAssigned ? '#27ae60' : '#e74c3c'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${group.parish}</strong>
                            <div style="display: flex; gap: 5px;">
                                ${isOffCampus ? '<span class="assignment-status" style="background: #e67e22; color: white; font-size: 10px;">🏕️ OFF-CAMPUS</span>' : ''}
                                <span class="assignment-status ${isHousingAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                    🏠 ${isHousingAssigned ? '✅' : '❌'}
                                </span>
                                <span class="assignment-status ${isSmallGroupAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                    👥 ${isSmallGroupAssigned ? '✅' : '❌'}
                                </span>
                            </div>
                        </div>
                        <p><span class="section-id">${group.id}</span> | <strong>Leader:</strong> ${group.leader} | <strong>Phone:</strong> ${group.phone}</p>
                        ${group.seminarianSgl ? `<p><strong>Seminarian SGL:</strong> ${group.seminarianSgl}</p>` : ''}
                        <p><strong>Total People:</strong> ${totalGroup} (${maleTotal} males, ${femaleTotal} females)</p>
                        ${group.specialAccommodations ? `<p style="margin-top: 8px; font-size: 12px;"><strong>Special Accommodations:</strong> ${group.specialAccommodations}</p>` : ''}
                        
                        <!-- Meal Color Display -->
                        ${mealColor ? `<div style="margin: 8px 0;"><strong>Meal Color:</strong> <span style="padding: 2px 6px; border-radius: 4px; background: ${getColorForMealAssignment(mealColor)}; color: white; font-size: 12px; font-weight: bold;">${mealColor}</span></div>` : '<div style="margin: 8px 0; color: #e67e22;"><strong>Meal Color:</strong> Not assigned</div>'}
                        
                        <!-- Housing Assignments -->
                        ${isOffCampus ? `
                            <div style="background: #fff3cd; padding: 8px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #e67e22;">
                                <strong style="font-size: 14px;">🏕️ OFF-CAMPUS HOUSING</strong>
                                <p style="font-size: 12px; margin-top: 4px;">This group is staying off-campus</p>
                            </div>
                        ` : `
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin: 8px 0;">
                                <strong style="font-size: 14px;">🏠 Housing Assignments</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px;">
                                    ${maleTotal > 0 ? `
                                        <div class="male-section" style="padding: 6px;">
                                            <strong style="font-size: 12px;">🔵 Males: ${maleTotal}</strong>
                                            ${maleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0;">${maleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0;">Not assigned</p>'}
                                        </div>
                                    ` : '<div></div>'}
                                    
                                    ${femaleTotal > 0 ? `
                                        <div class="female-section" style="padding: 6px;">
                                            <strong style="font-size: 12px;">🟣 Females: ${femaleTotal}</strong>
                                            ${femaleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0;">${femaleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0;">Not assigned</p>'}
                                        </div>
                                    ` : '<div></div>'}
                                </div>
                            </div>
                        `}
                        
                        <!-- Small Group Assignments -->
                        <div style="background: #f0f8ff; padding: 8px; border-radius: 6px; margin: 8px 0;">
                            <strong style="font-size: 14px;">👥 Small Group Location</strong>
                            ${groupSmallGroupRoomNames.length > 0 ? `
                                <div style="background: linear-gradient(45deg, #e8f4f8, #fdf2f2); padding: 6px; border-radius: 4px; margin-top: 5px;">
                                    <strong style="font-size: 12px;">🟡 Group Location:</strong>
                                    <p style="font-size: 10px; margin: 2px 0 0 0;">${groupSmallGroupRoomNames.join(', ')}</p>
                                </div>
                            ` : `<div style="background: #fff3cd; padding: 4px; border-radius: 4px; margin-top: 5px; text-align: center;">
                                <p style="font-size: 10px; color: #856404; margin: 0;">No small group location assigned</p>
                            </div>`}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // ===== RESOURCES MANAGEMENT =====
        function displayResources() {
            const container = document.getElementById('resources-list');
            if (!container) return;

            let html = '';

            if (!appData.resources || appData.resources.length === 0) {
                html = '<p style="color: #666;">No resources configured yet.</p>';
            } else {
                appData.resources.forEach((resource, index) => {
                    html += `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <span style="font-size: 2em;">${resource.emoji}</span>
                                <h3 style="margin: 0; color: #061d28;">${resource.emoji} Resource</h3>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Display Name:</label>
                                <input type="text"
                                       value="${resource.name || ''}"
                                       onchange="updateResourceName(${index}, this.value)"
                                       style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 14px;"
                                       placeholder="e.g., Click here for full schedule">
                            </div>

                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">URL Link:</label>
                                <input type="text"
                                       value="${resource.url || ''}"
                                       onchange="updateResourceUrl(${index}, this.value)"
                                       style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 14px;"
                                       placeholder="https://example.com/schedule">
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function updateResourceName(index, name) {
            if (appData.resources && appData.resources[index]) {
                appData.resources[index].name = name;
                autoSave();
            }
        }

        function updateResourceUrl(index, url) {
            if (appData.resources && appData.resources[index]) {
                appData.resources[index].url = url;
                autoSave();
            }
        }

        // ===== ROOM POSTER MANAGEMENT =====
        let roomNotesData = {};
        let currentRoomFilter = 'all';

        function loadRoomNotes() {
            const saved = localStorage.getItem('m2k_room_notes');
            if (saved) {
                try {
                    roomNotesData = JSON.parse(saved);
                } catch (e) {
                    roomNotesData = {};
                }
            }
        }

        function saveRoomNotes() {
            localStorage.setItem('m2k_room_notes', JSON.stringify(roomNotesData));
        }

        function updateRoomNote(roomKey, note) {
            roomNotesData[roomKey] = note;
            saveRoomNotes();
        }

        function getRoomNote(roomKey) {
            return roomNotesData[roomKey] || '';
        }

        function showAllRoomPosters(filter) {
            currentRoomFilter = filter;
            displayRoomPosters();
        }

        function filterRoomPosters() {
            const searchTerm = document.getElementById('room-search').value.toLowerCase();
            const container = document.getElementById('room-posters-container');
            if (!container) return;

            const posters = container.querySelectorAll('.room-poster');
            posters.forEach(poster => {
                const searchText = poster.getAttribute('data-search-text') || '';
                if (searchText.includes(searchTerm)) {
                    poster.style.display = 'block';
                } else {
                    poster.style.display = 'none';
                }
            });
        }

        function displayRoomPosters() {
            const container = document.getElementById('room-posters-container');
            if (!container) return;

            let html = '';

            // Generate Housing Room Posters
            if (currentRoomFilter === 'all' || currentRoomFilter === 'housing') {
                appData.housingRooms.forEach(room => {
                    const roomKey = `${room.building}-${room.roomId}`;
                    const assignedGroups = getHousingRoomAssignments(roomKey);
                    const note = getRoomNote(roomKey);

                    const searchText = `${room.building} ${room.roomId} ${assignedGroups.map(g => g.parish + ' ' + g.id).join(' ')}`.toLowerCase();

                    html += `
                        <div class="room-poster" data-search-text="${searchText}" data-room-key="${roomKey}" style="background: white; border: 3px solid #061d28; border-radius: 10px; padding: 30px; page-break-after: always; position: relative;">
                            <!-- Select Checkbox -->
                            <input type="checkbox" class="room-poster-checkbox" style="position: absolute; top: 15px; right: 15px; width: 25px; height: 25px; cursor: pointer;">

                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 25px; border-bottom: 4px solid #d4af37; padding-bottom: 20px;">
                                <h1 style="color: #061d28; margin: 0 0 10px 0; font-size: 2.5em;">Mount 2000 Youth Retreat</h1>
                                <h2 style="color: #d4af37; margin: 0; font-size: 1.8em;">HOUSING</h2>
                            </div>

                            <!-- Room Info -->
                            <div style="background: linear-gradient(135deg, #061d28, #0f3a4a); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h2 style="margin: 0 0 10px 0; font-size: 2em;">${room.building}</h2>
                                <h3 style="margin: 0; font-size: 1.5em; color: #d4af37;">Room ${room.roomId}</h3>
                                <p style="margin: 10px 0 0 0; font-size: 1.2em;">Capacity: ${room.capacity} | Gender: ${room.gender.toUpperCase()}</p>
                            </div>

                            <!-- Assigned Groups -->
                            <div style="margin-bottom: 20px;">
                                <h3 style="color: #061d28; border-bottom: 2px solid #d4af37; padding-bottom: 10px; margin-bottom: 15px;">Assigned Groups:</h3>
                                ${assignedGroups.length > 0 ? assignedGroups.map(group => `
                                    <div style="background: #f8f9fa; padding: 15px; border-left: 5px solid #d4af37; margin-bottom: 10px; border-radius: 5px;">
                                        <p style="margin: 0 0 5px 0; font-size: 1.3em; font-weight: bold; color: #061d28;">Group ${group.id}: ${group.parish}</p>
                                        <p style="margin: 0; color: #555;">Leader: ${group.leader} | ${group.count} people</p>
                                    </div>
                                `).join('') : '<p style="color: #999; font-style: italic;">No groups assigned to this room yet</p>'}
                            </div>

                            <!-- Accessibility & Notes -->
                            ${room.accessibility || note ? `
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 5px solid #f39c12; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 10px 0; color: #856404;">Important Information:</h4>
                                    ${room.accessibility ? `<p style="margin: 5px 0; font-weight: bold;">♿ Accessibility: ${room.accessibility}</p>` : ''}
                                    ${note ? `<p style="margin: 5px 0;"><strong>Notes:</strong> ${note}</p>` : ''}
                                </div>
                            ` : ''}

                            <!-- Custom Notes Section -->
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ccc;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #061d28;">Add Custom Notes:</label>
                                <textarea onchange="updateRoomNote('${roomKey}', this.value)"
                                          style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 14px; font-family: inherit;"
                                          placeholder="Add any special instructions or notes for this room...">${note}</textarea>
                            </div>
                        </div>
                    `;
                });
            }

            // Generate Small Group Room Posters
            if (currentRoomFilter === 'all' || currentRoomFilter === 'smallgroup') {
                appData.smallGroupRooms.forEach(room => {
                    const roomKey = `${room.building}-${room.roomId}`;
                    const assignedGroups = getSmallGroupRoomAssignments(roomKey);
                    const note = getRoomNote(roomKey);

                    const searchText = `${room.building} ${room.roomId} ${assignedGroups.map(g => g.parish + ' ' + g.id).join(' ')}`.toLowerCase();

                    html += `
                        <div class="room-poster" data-search-text="${searchText}" data-room-key="${roomKey}" style="background: white; border: 3px solid #061d28; border-radius: 10px; padding: 30px; page-break-after: always; position: relative;">
                            <!-- Select Checkbox -->
                            <input type="checkbox" class="room-poster-checkbox" style="position: absolute; top: 15px; right: 15px; width: 25px; height: 25px; cursor: pointer;">

                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 25px; border-bottom: 4px solid #d4af37; padding-bottom: 20px;">
                                <h1 style="color: #061d28; margin: 0 0 10px 0; font-size: 2.5em;">Mount 2000 Youth Retreat</h1>
                                <h2 style="color: #d4af37; margin: 0; font-size: 1.8em;">SMALL GROUP ROOM</h2>
                            </div>

                            <!-- Room Info -->
                            <div style="background: linear-gradient(135deg, #061d28, #0f3a4a); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h2 style="margin: 0 0 10px 0; font-size: 2em;">${room.building}</h2>
                                <h3 style="margin: 0; font-size: 1.5em; color: #d4af37;">Room ${room.roomId}</h3>
                                <p style="margin: 10px 0 0 0; font-size: 1.2em;">Capacity: ${room.capacity}</p>
                            </div>

                            <!-- Assigned Groups -->
                            <div style="margin-bottom: 20px;">
                                <h3 style="color: #061d28; border-bottom: 2px solid #d4af37; padding-bottom: 10px; margin-bottom: 15px;">Assigned Groups:</h3>
                                ${assignedGroups.length > 0 ? assignedGroups.map(group => `
                                    <div style="background: #f8f9fa; padding: 15px; border-left: 5px solid #d4af37; margin-bottom: 10px; border-radius: 5px;">
                                        <p style="margin: 0 0 5px 0; font-size: 1.3em; font-weight: bold; color: #061d28;">Group ${group.id}: ${group.parish}</p>
                                        <p style="margin: 0; color: #555;">Leader: ${group.leader} | ${group.count} people</p>
                                    </div>
                                `).join('') : '<p style="color: #999; font-style: italic;">No groups assigned to this room yet</p>'}
                            </div>

                            <!-- Room Features & Setup -->
                            ${room.features || note ? `
                                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; border-left: 5px solid #3498db; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Setup Requirements:</h4>
                                    ${room.features ? `<p style="margin: 5px 0; font-weight: bold;">🪑 ${room.features}</p>` : ''}
                                    ${note ? `<p style="margin: 5px 0;"><strong>Notes:</strong> ${note}</p>` : ''}
                                </div>
                            ` : ''}

                            <!-- Custom Notes Section -->
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ccc;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #061d28;">Add Custom Notes:</label>
                                <textarea onchange="updateRoomNote('${roomKey}', this.value)"
                                          style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 14px; font-family: inherit;"
                                          placeholder="Add any special instructions or notes for this room...">${note}</textarea>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function getHousingRoomAssignments(roomKey) {
            const assignments = [];

            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const rooms = appData.housingAssignments.male[groupId];
                if (Array.isArray(rooms) && rooms.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        assignments.push({
                            id: group.id,
                            parish: group.parish,
                            leader: group.leader,
                            count: group.maleTeens + group.maleChaperones,
                            gender: 'Male'
                        });
                    }
                }
            });

            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const rooms = appData.housingAssignments.female[groupId];
                if (Array.isArray(rooms) && rooms.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        assignments.push({
                            id: group.id,
                            parish: group.parish,
                            leader: group.leader,
                            count: group.femaleTeens + group.femaleChaperones,
                            gender: 'Female'
                        });
                    }
                }
            });

            return assignments;
        }

        function getSmallGroupRoomAssignments(roomKey) {
            const assignments = [];

            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const rooms = appData.smallGroupAssignments[groupId];
                if (Array.isArray(rooms) && rooms.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        assignments.push({
                            id: group.id,
                            parish: group.parish,
                            leader: group.leader,
                            count: group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones
                        });
                    }
                }
            });

            return assignments;
        }

        function printAllRoomPosters() {
            const allPosters = document.querySelectorAll('.room-poster');
            const visiblePosters = Array.from(allPosters).filter(p => p.style.display !== 'none');

            if (visiblePosters.length === 0) {
                alert('No room posters to print. Please add some rooms first.');
                return;
            }

            // Collect room keys from visible posters
            const roomKeys = Array.from(visiblePosters).map(p => p.getAttribute('data-room-key'));
            generateRoomPostersPDF(roomKeys);
        }

        function printSelectedRoomPosters() {
            const checkboxes = document.querySelectorAll('.room-poster-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('No room posters selected. Please check the boxes of the posters you want to print.');
                return;
            }

            // Collect room keys from checked posters
            const roomKeys = Array.from(checkboxes).map(cb => cb.closest('.room-poster').getAttribute('data-room-key'));
            generateRoomPostersPDF(roomKeys);
        }

        function generateRoomPostersPDF(roomKeys) {
            if (!roomKeys || roomKeys.length === 0) return;

            const printWindow = window.open('', '_blank');

            let postersHTML = '';

            roomKeys.forEach(roomKey => {
                // Check if housing or small group
                const housingRoom = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                const smallGroupRoom = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);

                if (housingRoom) {
                    postersHTML += generateHousingRoomPosterHTML(housingRoom, roomKey);
                } else if (smallGroupRoom) {
                    postersHTML += generateSmallGroupRoomPosterHTML(smallGroupRoom, roomKey);
                }
            });

            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mount 2000 Room Posters - ${new Date().toLocaleDateString()}</title>
                    <style>
                        @page {
                            size: letter landscape;
                            margin: 0.5in;
                        }
                        @media print {
                            .page-break {
                                page-break-after: always;
                            }
                            * {
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 14pt;
                            line-height: 1.5;
                            color: #000;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .room-poster-page {
                            background: white;
                            padding: 40px;
                            min-height: 7.5in;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 35px;
                            border-bottom: 5px solid #d4af37;
                            padding-bottom: 25px;
                        }
                        .header h1 {
                            color: #061d28;
                            margin: 0 0 15px 0;
                            font-size: 42pt;
                            font-weight: bold;
                        }
                        .header h2 {
                            color: #d4af37;
                            margin: 0;
                            font-size: 32pt;
                            font-weight: bold;
                        }
                        .room-info-box {
                            background: linear-gradient(135deg, #061d28, #0f3a4a);
                            color: white;
                            padding: 35px;
                            border-radius: 10px;
                            margin-bottom: 30px;
                            text-align: center;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .room-info-box h2 {
                            margin: 0 0 15px 0;
                            font-size: 36pt;
                            font-weight: bold;
                        }
                        .room-info-box h3 {
                            margin: 0;
                            font-size: 28pt;
                            color: #d4af37;
                            font-weight: bold;
                        }
                        .room-info-box p {
                            margin: 20px 0 0 0;
                            font-size: 18pt;
                            font-weight: bold;
                        }
                        .section-title {
                            color: #061d28;
                            border-bottom: 3px solid #d4af37;
                            padding-bottom: 12px;
                            margin: 30px 0 20px 0;
                            font-size: 22pt;
                            font-weight: bold;
                        }
                        .group-box {
                            background: #f8f9fa;
                            padding: 20px;
                            border-left: 6px solid #d4af37;
                            margin-bottom: 15px;
                            border-radius: 6px;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .group-box .group-name {
                            margin: 0 0 8px 0;
                            font-size: 20pt;
                            font-weight: bold;
                            color: #061d28;
                        }
                        .group-box .group-info {
                            margin: 0;
                            color: #333;
                            font-size: 16pt;
                            font-weight: 600;
                        }
                        .info-box {
                            padding: 20px;
                            border-radius: 10px;
                            border-left: 6px solid;
                            margin: 20px 0;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .warning-box {
                            background: #fff3cd;
                            border-left-color: #f39c12;
                        }
                        .info-box-blue {
                            background: #e8f4f8;
                            border-left-color: #3498db;
                        }
                        .info-box h4 {
                            margin: 0 0 12px 0;
                            font-size: 18pt;
                            font-weight: bold;
                        }
                        .info-box p {
                            margin: 8px 0;
                            font-size: 16pt;
                            font-weight: 600;
                        }
                        .no-groups {
                            color: #999;
                            font-style: italic;
                            font-size: 14pt;
                        }
                    </style>
                </head>
                <body>
                    ${postersHTML}
                </body>
                </html>
            `;

            printWindow.document.write(printHTML);
            printWindow.document.close();

            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 250);
        }

        function generateHousingRoomPosterHTML(room, roomKey) {
            const assignedGroups = getHousingRoomAssignments(roomKey);
            const note = getRoomNote(roomKey);

            return `
                <div class="room-poster-page page-break">
                    <div class="header">
                        <h1>Mount 2000 Youth Retreat</h1>
                        <h2>HOUSING</h2>
                    </div>

                    <div class="room-info-box">
                        <h2>${room.building}</h2>
                        <h3>Room ${room.roomId}</h3>
                        <p>Capacity: ${room.capacity} | Gender: ${room.gender.toUpperCase()}</p>
                    </div>

                    <h3 class="section-title">Assigned Groups:</h3>
                    ${assignedGroups.length > 0 ? assignedGroups.map(group => `
                        <div class="group-box">
                            <p class="group-name">Group ${group.id}: ${group.parish}</p>
                            <p class="group-info">Leader: ${group.leader} | ${group.count} people (${group.gender})</p>
                        </div>
                    `).join('') : '<p class="no-groups">No groups assigned to this room yet</p>'}

                    ${room.accessibility || note ? `
                        <div class="info-box warning-box">
                            <h4>⚠️ Important Information:</h4>
                            ${room.accessibility ? `<p><strong>Accessibility:</strong> ${room.accessibility}</p>` : ''}
                            ${note ? `<p><strong>Notes:</strong> ${note}</p>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function generateSmallGroupRoomPosterHTML(room, roomKey) {
            const assignedGroups = getSmallGroupRoomAssignments(roomKey);
            const note = getRoomNote(roomKey);

            return `
                <div class="room-poster-page page-break">
                    <div class="header">
                        <h1>Mount 2000 Youth Retreat</h1>
                        <h2>SMALL GROUP ROOM</h2>
                    </div>

                    <div class="room-info-box">
                        <h2>${room.building}</h2>
                        <h3>Room ${room.roomId}</h3>
                        <p>Capacity: ${room.capacity}</p>
                    </div>

                    <h3 class="section-title">Assigned Groups:</h3>
                    ${assignedGroups.length > 0 ? assignedGroups.map(group => `
                        <div class="group-box">
                            <p class="group-name">Group ${group.id}: ${group.parish}</p>
                            <p class="group-info">Leader: ${group.leader} | ${group.count} people</p>
                        </div>
                    `).join('') : '<p class="no-groups">No groups assigned to this room yet</p>'}

                    ${room.features || note ? `
                        <div class="info-box info-box-blue">
                            <h4>🪑 Setup Requirements:</h4>
                            ${room.features ? `<p><strong>${room.features}</strong></p>` : ''}
                            ${note ? `<p><strong>Notes:</strong> ${note}</p>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ===== DATA MANAGEMENT =====
        function autoSave() {
            window.housingData = { ...appData, timestamp: new Date().toISOString() };
        }

        function saveData() {
            const data = { ...appData, timestamp: new Date().toISOString(), version: '3.0' };
            const dataStr = JSON.stringify(data, null, 2);
            
            // Download as JSON file
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'm2k_2026_housing_data.json';
            link.click();
            
            alert('✅ Data saved successfully as JSON file!');
        }

        // ===== GITHUB API INTEGRATION =====
        function getGitHubSettings() {
            const settings = localStorage.getItem('githubSettings');
            return settings ? JSON.parse(settings) : {
                token: '',
                owner: 'M2KPortal',
                repo: 'M2KPortal.github.io',
                branch: 'main',
                filePath: 'm2k_2026_housing_data (1).json'
            };
        }

        function saveGitHubSettings(settings) {
            localStorage.setItem('githubSettings', JSON.stringify(settings));
        }

        async function saveToGitHub() {
            const settings = getGitHubSettings();

            // Check if token is set, if not prompt for it
            if (!settings.token) {
                const token = await promptForGitHubToken();
                if (!token) {
                    return; // User cancelled
                }
                settings.token = token;
                saveGitHubSettings(settings);
            }

            const saveBtn = document.getElementById('save-github-btn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '⏳ Saving to GitHub...';
            }

            try {
                // Prepare data
                const data = { ...appData, timestamp: new Date().toISOString(), version: '3.0' };
                const dataStr = JSON.stringify(data, null, 2);
                const content = btoa(unescape(encodeURIComponent(dataStr))); // Base64 encode

                // Get current file SHA (required for updates)
                const getUrl = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}?ref=${settings.branch}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }

                // Update or create file
                const updateUrl = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}`;
                const updateResponse = await fetch(updateUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update housing data - ${new Date().toLocaleString()}`,
                        content: content,
                        branch: settings.branch,
                        ...(sha && { sha: sha })
                    })
                });

                if (updateResponse.ok) {
                    const result = await updateResponse.json();
                    alert('✅ Data saved to GitHub successfully!\n\nCommit: ' + result.commit.sha.substring(0, 7));
                } else {
                    const error = await updateResponse.json();
                    throw new Error(error.message || 'Failed to save to GitHub');
                }
            } catch (error) {
                console.error('GitHub save error:', error);
                alert('❌ Failed to save to GitHub:\n\n' + error.message + '\n\nPlease check:\n• Your GitHub token is valid\n• Token has repo permissions\n• Repository details are correct');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '🔄 Save to GitHub';
                }
            }
        }

        function promptForGitHubToken() {
            return new Promise((resolve) => {
                const settings = getGitHubSettings();

                const html = `
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; margin: 20px auto;">
                        <h2 style="margin-bottom: 15px; color: #061d28;">🔑 GitHub Personal Access Token</h2>
                        <p style="color: #666; margin-bottom: 20px;">Enter your GitHub token to save changes automatically.</p>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">GitHub Personal Access Token:</label>
                            <input type="password" id="github-token-input"
                                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                                   onkeypress="if(event.key==='Enter') document.getElementById('save-token-btn').click()">
                        </div>

                        <div style="margin-bottom: 20px; padding: 12px; background: #e3f2fd; border-radius: 8px; font-size: 13px;">
                            <strong style="color: #1565c0;">📍 Saving to:</strong><br>
                            <code style="color: #0d47a1; background: white; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-top: 5px;">
                                ${settings.owner}/${settings.repo}/${settings.filePath}
                            </code>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button id="save-token-btn" onclick="submitGitHubToken()" class="btn btn-success" style="flex: 1; padding: 12px;">
                                ✅ Save Token
                            </button>
                            <button onclick="cancelGitHubToken()" class="btn btn-secondary" style="flex: 1; padding: 12px;">
                                Cancel
                            </button>
                        </div>

                        <div style="padding: 15px; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336; margin-bottom: 15px;">
                            <strong style="color: #c62828; font-size: 14px;">🔒 Security:</strong>
                            <ul style="margin: 8px 0 0 20px; line-height: 1.6; color: #c62828; font-size: 13px;">
                                <li>Token stored- ghp_0T6VF0r9igRIEfcqmovj36Mm7HBq4z0QFWg R </li>
                                <li>Never shared or visible to others</li>
                                <li>Only you have access to it</li>
                            </ul>
                        </div>

                        <div style="padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <strong style="font-size: 14px;">📖 How to get a token:</strong>
                            <ol style="margin: 8px 0 0 20px; line-height: 1.6; font-size: 13px;">
                                <li>Go to <a href="https://github.com/settings/tokens" target="_blank" style="color: #1565c0;">github.com/settings/tokens</a></li>
                                <li>Click "Generate new token (classic)"</li>
                                <li>Select <strong>"repo"</strong> scope</li>
                                <li>Copy and paste the token above</li>
                            </ol>
                        </div>
                    </div>
                `;

                const modal = document.createElement('div');
                modal.id = 'github-token-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto; padding: 20px; display: flex; align-items: center;';
                modal.innerHTML = html;
                document.body.appendChild(modal);

                // Focus the input
                setTimeout(() => {
                    const input = document.getElementById('github-token-input');
                    if (input) input.focus();
                }, 100);

                // Store resolve function for later use
                window._tokenPromiseResolve = resolve;
            });
        }

        function submitGitHubToken() {
            const input = document.getElementById('github-token-input');
            const token = input.value.trim();

            if (!token) {
                alert('⚠️ Please enter a GitHub token');
                return;
            }

            const modal = document.getElementById('github-token-modal');
            if (modal) modal.remove();

            if (window._tokenPromiseResolve) {
                window._tokenPromiseResolve(token);
                delete window._tokenPromiseResolve;
            }
        }

        function cancelGitHubToken() {
            const modal = document.getElementById('github-token-modal');
            if (modal) modal.remove();

            if (window._tokenPromiseResolve) {
                window._tokenPromiseResolve(null);
                delete window._tokenPromiseResolve;
            }
        }

        function manageGitHubToken() {
            const settings = getGitHubSettings();
            const hasToken = !!settings.token;

            const action = hasToken
                ? confirm('You have a GitHub token saved.\n\nWhat would you like to do?\n\nOK = Update token\nCancel = Remove token')
                : true;

            if (action === null) return; // User clicked Cancel on confirm

            if (!hasToken || action) {
                // Update token
                promptForGitHubToken().then(token => {
                    if (token) {
                        settings.token = token;
                        saveGitHubSettings(settings);
                        alert('✅ GitHub token saved!\n\nYou can now use "Save to GitHub" to automatically save changes.');
                    }
                });
            } else {
                // Remove token
                settings.token = '';
                saveGitHubSettings(settings);
                alert('🗑️ GitHub token removed.\n\nYou will be prompted for a token next time you save.');
            }
        }

        function loadData() {
            document.getElementById('load-file').click();
        }

        function handleLoadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.youthGroups && data.housingRooms && data.housingAssignments) {
                        if (confirm('This will replace all current data. Continue?')) {
                            appData.youthGroups = data.youthGroups;
                            appData.housingRooms = data.housingRooms;
                            appData.housingAssignments = data.housingAssignments;
                            appData.smallGroupRooms = data.smallGroupRooms || [];
                            appData.smallGroupAssignments = data.smallGroupAssignments || {};
                            appData.mealColorAssignments = data.mealColorAssignments || {};
                            
                            // Load meal times if available
                            if (data.mealTimes) {
                                appData.mealTimes = data.mealTimes;
                            }
                            
                            // Load default notes if available
                            if (data.defaultNotes) {
                                appData.defaultNotes = data.defaultNotes;
                            }
                            
                            // Load group notes if available
                            if (data.groupNotes) {
                                appData.groupNotes = data.groupNotes;
                            }
                            
                            updateAllDisplays();
                            updateHousingAssignmentDropdown();
                            updateSmallGroupAssignmentDropdown();
                            
                            alert('Data loaded successfully!');
                        }
                    } else {
                        alert('Invalid file format.');
                    }
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportToCSV() {
            const headers = [
                'Group ID', 'Parish Name', 'Group Leader', 'Seminarian SGL', 'Phone Number',
                'Male Teens', 'Female Teens', 'Male Chaperones', 'Female Chaperones', 'Total People',
                'Special Accommodations', 'Meal Color', 'Male Housing Assignments', 'Female Housing Assignments', 
                'Small Group Assignments', 'Housing Assignment Status', 'Small Group Assignment Status'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            appData.youthGroups.forEach(group => {
                const totalPeople = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                
                // Get housing assignments
                const maleHousingRooms = appData.housingAssignments.male[group.id] || [];
                const femaleHousingRooms = appData.housingAssignments.female[group.id] || [];
                
                const maleHousingRoomNames = maleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building} - ${room.roomId}` : roomKey;
                });
                
                const femaleHousingRoomNames = femaleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building} - ${room.roomId}` : roomKey;
                });
                
                // Get small group assignments
                const groupSmallGroupRooms = appData.smallGroupAssignments[group.id] || [];
                
                const groupSmallGroupRoomNames = groupSmallGroupRooms.map(roomKey => {
                    const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building} - ${room.roomId}` : roomKey;
                });
                
                const isHousingAssigned = maleHousingRooms.length > 0 || femaleHousingRooms.length > 0;
                const isSmallGroupAssigned = groupSmallGroupRooms.length > 0;
                const mealColor = appData.mealColorAssignments[group.id] || '';
                
                const row = [
                    group.id,
                    `"${group.parish}"`,
                    `"${group.leader}"`,
                    `"${group.seminarianSgl || ''}"`,
                    group.phone,
                    group.maleTeens,
                    group.femaleTeens,
                    group.maleChaperones,
                    group.femaleChaperones,
                    totalPeople,
                    `"${group.specialAccommodations || ''}"`,
                    mealColor,
                    `"${maleHousingRoomNames.join('; ')}"`,
                    `"${femaleHousingRoomNames.join('; ')}"`,
                    `"${groupSmallGroupRoomNames.join('; ')}"`,
                    isHousingAssigned ? 'Assigned' : 'Unassigned',
                    isSmallGroupAssigned ? 'Assigned' : 'Unassigned'
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Add housing room summary
            csvContent += '\n\nHOUSING ROOM ASSIGNMENTS SUMMARY\n';
            csvContent += 'Building,Room,Gender,Capacity,Occupied,Available,Assigned Groups\n';
            
            appData.housingRooms.forEach(room => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getHousingRoomOccupancy(roomKey);
                const assignedGroupsText = getHousingRoomAssignedGroupsDisplay(roomKey).replace(/<[^>]*>/g, '').replace('Assigned: ', '') || 'None';
                
                csvContent += `"${room.building}","${room.roomId}","${room.gender}",${room.capacity},${occupiedCount},${room.capacity - occupiedCount},"${assignedGroupsText}"\n`;
            });
            
            // Add small group room summary
            csvContent += '\n\nSMALL GROUP ROOM ASSIGNMENTS SUMMARY\n';
            csvContent += 'Building,Room,Gender,Capacity,Occupied,Available,Assigned Groups\n';
            
            appData.smallGroupRooms.forEach(room => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getSmallGroupRoomOccupancy(roomKey);
                const assignedGroupsText = getSmallGroupRoomAssignedGroupsDisplay(roomKey).replace(/<[^>]*>/g, '').replace('Assigned: ', '') || 'None';
                
                csvContent += `"${room.building}","${room.roomId}","${room.gender === 'mixed' ? 'Mixed/Co-ed' : room.gender}",${room.capacity},${occupiedCount},${room.capacity - occupiedCount},"${assignedGroupsText}"\n`;
            });
            
            // Add meal color summary
            csvContent += '\n\nMEAL COLOR ASSIGNMENTS SUMMARY\n';
            csvContent += 'Meal Color,Groups Assigned,Total People\n';
            
            const mealColorSummary = {};
            MEAL_COLORS.forEach(color => {
                mealColorSummary[color] = { groups: 0, people: 0 };
            });
            
            Object.keys(appData.mealColorAssignments).forEach(groupId => {
                const color = appData.mealColorAssignments[groupId];
                const group = appData.youthGroups.find(g => g.id === groupId);
                if (group && color && mealColorSummary[color]) {
                    mealColorSummary[color].groups++;
                    mealColorSummary[color].people += group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                }
            });
            
            MEAL_COLORS.forEach(color => {
                csvContent += `${color},${mealColorSummary[color].groups},${mealColorSummary[color].people}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `mount2k_complete_assignments_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Complete housing, small group, and meal color data exported successfully! The CSV includes separate sections for all assignments.');
        }

        function exportCompleteHTML() {
            // Get the current HTML content
            let htmlContent = document.documentElement.outerHTML;
            
            // Create the new loadSampleData function with current data
            const currentDataString = `
            appData.youthGroups = ${JSON.stringify(appData.youthGroups, null, 12)};

            appData.housingRooms = ${JSON.stringify(appData.housingRooms, null, 12)};

            appData.smallGroupRooms = ${JSON.stringify(appData.smallGroupRooms, null, 12)};

            appData.housingAssignments = ${JSON.stringify(appData.housingAssignments, null, 12)};
            appData.smallGroupAssignments = ${JSON.stringify(appData.smallGroupAssignments, null, 12)};`;

            // Find and replace the loadSampleData function content
            const loadSampleDataRegex = /function loadSampleData\(\) \{[\s\S]*?appData\.groupNotes = \{\};[\s\S]*?\}/;
            
            const newLoadSampleDataFunction = `function loadSampleData() {
            ${currentDataString}
        }`;

            // Replace the function in the HTML
            htmlContent = htmlContent.replace(loadSampleDataRegex, newLoadSampleDataFunction);
            
            // Add a comment at the top indicating this is a saved version
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            htmlContent = htmlContent.replace(
                '<title>Mount 2K Housing Management System</title>',
                `<title>Mount 2K Housing Management System - Saved ${new Date().toLocaleDateString()}</title>`
            );
            
            // Create and download the file
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `mount2k_housing_system_complete_${timestamp.split('T')[0]}.html`;
            link.click();
            
            alert('Complete HTML site exported! 🌐\n\nYou can now upload this HTML file to any web host and it will load with all your current assignments. The file includes:\n• All youth groups\n• All room assignments\n• All small group assignments\n\nJust upload the HTML file to your hosting service!');
        }

        // ===== PASSWORD PROTECTION =====
        let systemConfig = null;
        const FALLBACK_PASSWORD_HASH = '11928902f4159816e88d463509a2d7c993060f78d664d96127626b9907ac8b18'; // Mount2K2026

        async function loadSystemConfig() {
            try {
                const response = await fetch('m2k_config.json');
                if (!response.ok) {
                    console.warn('Config file not found, using fallback password');
                    return null;
                }
                systemConfig = await response.json();
                console.log('Config loaded successfully');
                return systemConfig;
            } catch (error) {
                console.error('Error loading config:', error);
                console.warn('Using fallback password hash');
                // Fallback to hardcoded hash
                return null;
            }
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function checkPassword() {
            const input = document.getElementById('password-input');
            const errorDiv = document.getElementById('password-error');

            const enteredPassword = input.value.trim();

            if (!enteredPassword) {
                errorDiv.textContent = '⚠️ Please enter a password';
                errorDiv.style.display = 'block';
                return;
            }

            const hashedInput = await hashPassword(enteredPassword);

            // Priority 1: Check against centralized config from GitHub
            let passwordHash = null;
            if (systemConfig && systemConfig.passwordHash) {
                passwordHash = systemConfig.passwordHash;
                console.log('Using config password');
            } else {
                // Priority 2: Use fallback password hash
                passwordHash = FALLBACK_PASSWORD_HASH;
                console.log('Using fallback password');
            }

            if (hashedInput === passwordHash) {
                unlockSystem();
            } else {
                errorDiv.textContent = '❌ Incorrect password. Please try again.';
                errorDiv.style.display = 'block';
                input.value = '';
                input.focus();

                // Shake animation
                input.style.animation = 'shake 0.5s';
                setTimeout(() => input.style.animation = '', 500);
            }
        }

        function unlockSystem() {
            document.getElementById('password-overlay').style.display = 'none';
            document.getElementById('main-content').classList.add('unlocked');

            // Set session authentication
            sessionStorage.setItem('authenticated', 'true');
        }

        function logout() {
            // Clear session
            sessionStorage.removeItem('authenticated');

            // Show success message
            alert('✅ Logout successful!\n\nRedirecting to dashboard...');

            // Redirect to index.html
            window.location.href = 'https://m2kportal.github.io/index.html';
        }

        async function initPasswordSystem() {
            // Load config from GitHub
            await loadSystemConfig();

            const setupMode = document.getElementById('password-setup-mode');
            const btnText = document.getElementById('password-btn-text');
            const input = document.getElementById('password-input');

            // Check if already authenticated in this session
            if (sessionStorage.getItem('authenticated') === 'true') {
                unlockSystem();
                return;
            }

            // Always hide setup mode since we have a fallback password
            setupMode.style.display = 'none';
            btnText.textContent = '🔓 Unlock';
            input.placeholder = 'Enter password';

            // Show status message
            if (systemConfig && systemConfig.passwordHash) {
                console.log('✅ Config loaded - using GitHub password');
            } else {
                console.log('⚠️ Config not loaded - using fallback password: Mount2K2026');
            }

            input.focus();
        }

        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
                20%, 40%, 60%, 80% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        // ===== SEARCH/FILTER FUNCTIONS =====
        function filterHousingRooms() {
            const searchTerm = document.getElementById('housing-rooms-search').value.toLowerCase();
            const roomCards = document.querySelectorAll('#housing-available-rooms-list .room-card');

            roomCards.forEach(card => {
                const searchText = card.getAttribute('data-room-search') || '';
                if (searchText.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterSmallGroupRooms() {
            const searchTerm = document.getElementById('sg-rooms-search').value.toLowerCase();
            const roomCards = document.querySelectorAll('#sg-available-rooms-list .room-card');

            roomCards.forEach(card => {
                const searchText = card.getAttribute('data-room-search') || '';
                if (searchText.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // ===== SYSTEM INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initPasswordSystem();
            initializeSystem();
        });
    </script>
</body>
</html>
